<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Queue Management Dashboard</title>
    <link rel="stylesheet" href="assets/css/admindashb.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="assets/css/improved_admindash.css" />
    <!-- MOVED THE OTHER STYLES IN THE IMPROVED_ADMINDASHB.CSS FOR BETTER ORGANIZATION -->
  </head>

  <body>
    <div class="sidebar">
      <div class="sidebar-header">
        <img
          src="/assets/img/updated_RegistrarLogo.jpg"
          width="50"
          height="50"
          alt="Office of the University Registrar"
          onerror="this.style.display='none'"
        />
        <div class="sidebar-title">Registrar Staff</div>
      </div>

      <div class="menu-item active" data-page="queue">
        <i class="bi bi-list-task menu-icon"></i>
        <span>Queue Management</span>
      </div>

      <div class="menu-item" data-page="documents">
        <i class="bi bi-file-earmark-text menu-icon"></i>
        <span>Service Requests</span>
      </div>

      <div class="menu-item" data-page="reports">
        <i class="bi bi-bar-chart menu-icon"></i>
        <span>Reports</span>
      </div>

      <div class="menu-item" data-page="settings">
        <i class="bi bi-gear menu-icon"></i>
        <span>Settings</span>
      </div>
      <div
        class="menu-item"
        data-page="staff-management"
        id="nav-staff-management"
        style="display: none"
      >
        <i class="bi bi-people-fill menu-icon"></i>
        <span>Staff Accounts</span>
      </div>

      <div class="request-card">
        <div class="request-number" id="totalRequestsToday">0</div>
        <div class="request-label">Request Today</div>
      </div>

      <div class="user-card">
        <div class="user-avatar" id="sidebarAvatar">...</div>
        <div class="user-info">
          <h4 id="sidebarStaffName">Loading...</h4>
          <p id="sidebarStaffRole">Registrar Staff</p>
        </div>
      </div>
    </div>

    <div class="main-content">
      <div id="queue-page" class="page active">
        <div class="row mb-4">
          <div class="col-md-3">
            <div class="card h-100">
              <div
                class="card-body text-center d-flex flex-column justify-content-center"
              >
                <h2 id="win1-count" class="text-primary fw-bold mb-0">0</h2>
                <p class="text-muted small mb-0">Window 1</p>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card h-100">
              <div
                class="card-body text-center d-flex flex-column justify-content-center"
              >
                <h2 id="win2-count" class="text-warning fw-bold mb-0">0</h2>
                <p class="text-muted small mb-0">Window 2</p>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card h-100">
              <div
                class="card-body text-center d-flex flex-column justify-content-center"
              >
                <h2 id="win3-count" class="text-info fw-bold mb-0">0</h2>
                <p class="text-muted small mb-0">Window 3</p>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card h-100">
              <div
                class="card-body text-center d-flex flex-column justify-content-center"
              >
                <h2 id="win4-count" class="text-danger fw-bold mb-0">0</h2>
                <p class="text-muted small mb-0">Window 4</p>
              </div>
            </div>
          </div>
        </div>

        <div class="row mb-4">
          <div class="col-12">
            <h3 class="section-title fs-5 mb-3">Now Serving</h3>
            <div id="current-serving-container">
              <div class="card shadow-sm">
                <div class="card-body text-center text-muted py-4">
                  <i class="bi bi-hourglass-split mb-2 fs-3"></i>
                  <p class="mb-0">Loading status...</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row mb-4">
          <div class="col-12">
            <h3 class="section-title fs-5 mb-3">New Requests</h3>
            <div
              class="requests-container-bg"
              style="
                background-color: #f0f2f5;
                border-radius: 12px;
                padding: 20px;
                min-height: 200px;
              "
            >
              <div
                id="requests-list"
                class="requests-scroll-area"
                style="max-height: 400px; overflow-y: auto"
              >
                <div id="no-requests-msg" class="text-center text-muted py-4">
                  <i class="bi bi-inbox fs-3"></i>
                  <p class="mb-0 mt-2">No New Requests</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row mb-4">
          <div class="col-12">
            <h3 class="section-title fs-5 mb-3">All Requests Being Served</h3>
            <div
              class="requests-container-bg"
              style="
                background-color: #f0f2f5;
                border-radius: 12px;
                padding: 20px;
                min-height: 100px;
                margin-bottom: 20px;
              "
            >
              <div
                id="all-processing-list"
                class="requests-scroll-area"
                style="max-height: 250px; overflow-y: auto"
              >
                <div id="no-processing-msg" class="text-center text-muted py-4">
                  <i class="bi bi-person-slash fs-3"></i>
                  <p class="mb-0 mt-2">No Requests Currently in Progress</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Service Request Page -->
      <div id="documents-page" class="page">
        <div
          class="header d-flex align-items-center justify-content-between flex-wrap gap-3 mb-4"
        >
          <h1 class="mb-0 fs-4 fw-bold">Service Request Management</h1>

          <div
            class="search-wrapper d-flex align-items-center shadow-sm"
            style="border-radius: 50px; overflow: hidden; background: #f8f9fa"
          >
            <input
              type="text"
              id="serviceRequestSearchInput"
              class="form-control border-0 bg-transparent"
              style="
                height: 40px;
                padding: 0 16px;
                outline: none;
                box-shadow: none;
              "
              placeholder="Search..."
            />
            <button
              class="btn btn-primary"
              id="serviceRequestSearchBtn"
              type="button"
              style="
                height: 40px;
                width: 48px;
                border-radius: 50px;
                border: none;
                margin-left: -1px;
              "
            >
              <i class="bi bi-search text-white"></i>
            </button>
          </div>
        </div>

        <div id="processingRequestsContainer" class="mb-5"></div>

        <hr class="border-secondary opacity-10 my-4" />

        <h3 class="section-title fs-6 text-secondary fw-bold mb-3">
          <i class="bi bi-clock-history me-2"></i>History (This Session)
        </h3>
        <div id="completedRequestsContainer" class="mb-4"></div>
      </div>

      <!-- Reports Page -->
      <div id="reports-page" class="page">
        <div class="header">
          <h1>Analytics Dashboard</h1>
        </div>

        <div class="analytics-grid">
          <div class="summary-card">
            <div class="summary-number" id="totalRequestsSummary">0</div>
            <div class="summary-label">Total Today's Request</div>
          </div>
          <div class="summary-card">
            <div class="summary-number" id="completedSummary">0</div>
            <div class="summary-label">Completed Today</div>
          </div>
        </div>

        <div class="charts-grid">
          <div class="info-card">
            <h3>
              First Contact Resolution (FCR)
              <span style="color: #999">(Today)</span>
            </h3>
            <p
              style="
                font-size: 14px;
                color: #666;
                margin-top: -10px;
                margin-bottom: 15px;
              "
            >
              Based on Approved vs. Declined service requests.
            </p>
            <div
              class="chart-container"
              style="position: relative; height: 250px; width: 100%"
            >
              <canvas id="fcrChart"></canvas>
            </div>
          </div>

          <div class="info-card">
            <h3>
              Recent Client Requests <span style="color: #999">(Today)</span>
            </h3>
            <ul class="request-list" id="recentRequestsList"></ul>
          </div>
        </div>

        <div class="history-table" id="queueReportHistoryContainer">
          <h2 class="history-title">Queue Report History</h2>
          <div
            class="history-item empty"
            style="text-align: center; color: #999; padding: 20px 0"
          >
            No reports found.
          </div>
        </div>
      </div>

      <div id="report-detail-page" class="page">
        <div class="header">
          <h1>Queue Report Details</h1>
          <button class="btn btn-secondary" onclick="showPage('reports')">
            <i class="bi bi-arrow-left"></i> Back to Reports
          </button>
        </div>

        <div class="report-header">
          <h2 class="report-title">Queue Report History</h2>
          <div class="report-date" id="reportDetailDate">Loading...</div>

          <div class="service-summary">
            <h3 class="summary-title">Overall Service Requested</h3>
            <div class="summary-grid" id="reportDetailServiceGrid"></div>

            <div class="total-requests">
              <div class="total-label">Total Requests</div>
              <div class="total-number" id="reportDetailTotal">0</div>
            </div>
          </div>
        </div>

        <div class="data-table" id="reportDetailDataTable">
          <div style="text-align: center; color: #999; padding: 30px 0">
            Loading report details...
          </div>
        </div>
      </div>

      <!-- Detail Report Page -->
      <div id="report-detail-page" class="page">
        <div class="header">
          <h1>Queue Report Details</h1>
          <button class="btn btn-secondary" onclick="showPage('reports')">
            <i class="bi bi-arrow-left"></i> Back to Reports
          </button>
        </div>

        <div class="report-header">
          <h2 class="report-title">Queue Report History</h2>
          <div class="report-date">Friday 8am-4pm<br />August 5, 2025</div>

          <div class="service-summary">
            <h3 class="summary-title">Overall Service Requested</h3>
            <div class="summary-grid">
              <div>
                <div class="service-item">
                  <span class="service-name">Transcript of Grades:</span>
                  <span class="service-count">2</span>
                </div>
                <div class="service-item">
                  <span class="service-name">Certification of Grade Form:</span>
                  <span class="service-count">7</span>
                </div>
                <div class="service-item">
                  <span class="service-name">Adding/Dropping Subjects:</span>
                  <span class="service-count">3</span>
                </div>
              </div>
              <div>
                <div class="service-item">
                  <span class="service-name">Signature Related Services:</span>
                  <span class="service-count">26</span>
                </div>
                <div class="service-item">
                  <span class="service-name">Grade Slip:</span>
                  <span class="service-count">11</span>
                </div>
              </div>
            </div>

            <div class="total-requests">
              <div class="total-label">Total Requests</div>
              <div class="total-number">52</div>
            </div>
          </div>
        </div>

        <div class="data-table">
          <div class="table-section">
            <div class="table-header-title">Transcript of Grades</div>
            <div class="table-row header-row">
              <div class="table-cell header">Name</div>
              <div class="table-cell header">Year/Course/Major</div>
              <div class="table-cell header">Year Graduated</div>
              <div class="table-cell header">Student ID</div>
            </div>
            <div class="table-row">
              <div class="table-cell">Sarah Jane Maralo</div>
              <div class="table-cell">N/A</div>
              <div class="table-cell">2024</div>
              <div class="table-cell">2019-0987654</div>
            </div>
          </div>
        </div>
      </div>

      <!-- --------------------------------------------- SETTINGS PAGE ------------------------------------------------->
      <div id="settings-page" class="page">
        <div class="header">
          <h1>Settings</h1>
        </div>

        <div class="settings-section">
          <div
            class="staff-info-card"
            style="
              box-shadow: none;
              padding: 0;
              margin-bottom: 20px;
              background: transparent;
            "
          >
            <div class="staff-header d-flex align-items-center mb-3">
              <div class="staff-avatar">
                <span id="staffAvatarInitials">AD</span>
              </div>
              <div>
                <h4 id="staffFullName" class="mb-1">Loading...</h4>
                <p class="text-muted mb-0" id="staffEmail">Loading...</p>
                <span class="badge bg-primary" id="staffRole">Loading...</span>
              </div>
            </div>

            <div class="staff-details">
              <div class="row">
                <div class="col-md-6">
                  <p>
                    <strong>Department:</strong>
                    <span id="staffDepartment">Loading...</span>
                  </p>
                  <p>
                    <strong>Phone:</strong>
                    <span id="staffPhone">Loading...</span>
                  </p>
                </div>
                <div class="col-md-6">
                  <p>
                    <strong>Last Login:</strong>
                    <span id="staffLastLogin">Loading...</span>
                  </p>
                  <p>
                    <strong>Member Since:</strong>
                    <span id="staffMemberSince">Loading...</span>
                  </p>
                </div>
              </div>
            </div>
          </div>

          <button class="btn-logout" onclick="handleLogout()">
            <i class="bi bi-box-arrow-right"></i> Log out
          </button>
        </div>

        <div class="settings-section">
          <h2 class="settings-section-title">Manage Queue System Settings</h2>

          <div class="settings-item" onclick="toggleModal('waitingTimeModal')">
            <div class="settings-item-icon">‚è±Ô∏è</div>
            <span>Edit Services Waiting Time</span>
          </div>

          <div class="settings-item" onclick="toggleModal('monitoringModal')">
            <div class="settings-item-icon">üì∫</div>
            <span>Edit Monitoring Details</span>
          </div>

          <div class="settings-item" onclick="toggleModal('notificationModal')">
            <div class="settings-item-icon">üîî</div>
            <span>Edit Notification Details</span>
          </div>

          <div class="settings-item" onclick="toggleFontSize()">
            <div class="settings-item-icon">Aa</div>
            <span>Change Font Size</span>
            <span class="settings-value" id="fontSizeValue">Medium</span>
          </div>
          <div
            class="settings-item d-flex align-items-center justify-content-between"
          >
            <div class="d-flex align-items-center">
              <i class="bi bi-moon-stars-fill me-2"></i>
              <div>
                <div>Dark Mode</div>
                <small class="text-muted"
                  >Toggle between light and dark theme</small
                >
              </div>
            </div>
            <div class="form-check form-switch">
              <input
                class="form-check-input"
                type="checkbox"
                id="darkModeSwitch"
              />
              <label class="form-check-label" for="darkModeSwitch"></label>
            </div>
          </div>
        </div>
      </div>

      <div id="staff-management-page" class="page">
        <div
          class="header d-flex justify-content-between align-items-center mb-4"
        >
          <h1>Staff Account Management</h1>
          <button
            class="btn btn-success"
            onclick="toggleModal('registerStaffModal')"
          >
            <i class="bi bi-plus-lg"></i> Register New Staff
          </button>
        </div>

        <div class="card border-0 shadow-sm">
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                  <tr>
                    <th class="p-3 ps-4">Staff Name</th>
                    <th class="p-3">Role</th>
                    <th class="p-3">Department</th>
                    <th class="p-3">Current Status</th>
                    <th class="p-3 text-end pe-4">Actions</th>
                  </tr>
                </thead>
                <tbody id="staffListContainer"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- --------------------------------------------- SETTING'S MODALS HERE ------------------------------------------------->

    <!-- Account Details Modal -->
    <div id="accountDetailsModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Registrar Staff Account Details</h3>
          <span class="modal-close" onclick="toggleModal('accountDetailsModal')"
            >&times;</span
          >
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>Full Name</label>
            <input type="text" value="Jila Santos" class="form-input" />
          </div>
          <div class="form-group">
            <label>Email Address</label>
            <input
              type="email"
              value="jila.santos@rsu.edu"
              class="form-input"
            />
          </div>
          <div class="form-group">
            <label>Role</label>
            <input
              type="text"
              value="Registrar Staff"
              class="form-input"
              disabled
            />
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="toggleModal('accountDetailsModal')"
          >
            Cancel
          </button>
          <button class="btn btn-primary" onclick="saveAccountDetails()">
            Save Changes
          </button>
        </div>
      </div>
    </div>

    <!-- Password Modal -->
    <div id="passwordModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Manage Account Password</h3>
          <span class="modal-close" onclick="toggleModal('passwordModal')"
            >&times;</span
          >
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>Current Password</label>
            <input
              type="password"
              class="form-input"
              placeholder="Enter current password"
            />
          </div>
          <div class="form-group">
            <label>New Password</label>
            <input
              type="password"
              class="form-input"
              placeholder="Enter new password"
            />
          </div>
          <div class="form-group">
            <label>Confirm New Password</label>
            <input
              type="password"
              class="form-input"
              placeholder="Confirm new password"
            />
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="toggleModal('passwordModal')"
          >
            Cancel
          </button>
          <button class="btn btn-primary" onclick="changePassword()">
            Change Password
          </button>
        </div>
      </div>
    </div>

    <!-- Approve Request Modal -->
    <div id="approveRequestModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Approve Service Request</h3>
          <span class="modal-close" onclick="toggleModal('approveRequestModal')"
            >&times;</span
          >
        </div>
        <div class="modal-body">
          <input type="hidden" id="approveRequestId" />
          <div class="form-group">
            <label>Request Details</label>
            <div id="approveRequestDetails" class="request-details-preview">
              <!-- Request details will be populated here -->
            </div>
          </div>
          <div class="form-group">
            <label>Admin Notes (Optional)</label>
            <textarea
              id="approveNotes"
              class="form-input"
              rows="3"
              placeholder="Add any notes for the student..."
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="toggleModal('approveRequestModal')"
          >
            Cancel
          </button>
          <button
            class="btn btn-success"
            onclick="serviceRequestManager.confirmApproveRequest()"
          >
            Approve Request
          </button>
        </div>
      </div>
    </div>

    <!-- Decline Request Modal -->
    <div id="declineRequestModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Decline Service Request</h3>
          <span class="modal-close" onclick="toggleModal('declineRequestModal')"
            >&times;</span
          >
        </div>
        <div class="modal-body">
          <input type="hidden" id="declineRequestId" />
          <div class="form-group">
            <label>Request Details</label>
            <div id="declineRequestDetails" class="request-details-preview">
              <!-- Request details will be populated here -->
            </div>
          </div>
          <div class="form-group">
            <label
              >Reason for Declining <span style="color: red">*</span></label
            >
            <textarea
              id="declineReason"
              class="form-input"
              rows="4"
              placeholder="Please provide a clear reason for declining this request..."
              required
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="toggleModal('declineRequestModal')"
          >
            Cancel
          </button>
          <button
            class="btn btn-danger"
            onclick="serviceRequestManager.confirmDeclineRequest()"
          >
            Decline Request
          </button>
        </div>
      </div>
    </div>

    <!-- Request Details Modal -->
    <div id="requestDetailsModal" class="modal">
      <div class="modal-content" style="max-width: 700px">
        <div class="modal-header">
          <h3>Service Request Details</h3>
          <span class="modal-close" onclick="toggleModal('requestDetailsModal')"
            >&times;</span
          >
        </div>
        <div class="modal-body">
          <div id="requestDetailsContent">
            <!-- Request details will be populated here -->
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="toggleModal('requestDetailsModal')"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Additional Modals for Settings -->
    <div id="waitingTimeModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Edit Services Waiting Time</h3>
          <span class="modal-close" onclick="toggleModal('waitingTimeModal')"
            >&times;</span
          >
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>Average Service Time (minutes)</label>
            <input type="number" class="form-input" value="15" min="1" />
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="toggleModal('waitingTimeModal')"
          >
            Cancel
          </button>
          <button class="btn btn-primary" onclick="saveWaitingTime()">
            Save Changes
          </button>
        </div>
      </div>
    </div>

    <div id="monitoringModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Edit Monitoring Details</h3>
          <span class="modal-close" onclick="toggleModal('monitoringModal')"
            >&times;</span
          >
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>Auto-refresh Interval (seconds)</label>
            <input type="number" class="form-input" value="5" min="1" />
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="toggleModal('monitoringModal')"
          >
            Cancel
          </button>
          <button class="btn btn-primary" onclick="saveMonitoring()">
            Save Changes
          </button>
        </div>
      </div>
    </div>

    <div id="notificationModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Edit Notification Details</h3>
          <span class="modal-close" onclick="toggleModal('notificationModal')"
            >&times;</span
          >
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>Enable Sound Notifications</label>
            <input type="checkbox" checked />
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="toggleModal('notificationModal')"
          >
            Cancel
          </button>
          <button class="btn btn-primary" onclick="saveNotification()">
            Save Changes
          </button>
        </div>
      </div>
    </div>
    <div
      id="windowSelectionModal"
      class="modal fade"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div
          class="modal-content shadow-lg"
          style="border-radius: 15px; border: none"
        >
          <div class="modal-header justify-content-center border-0 pt-4">
            <h4 class="m-0 fw-bold text-primary">Select Your Window</h4>
          </div>
          <div class="modal-body px-4 pb-4">
            <p class="text-muted text-center mb-4">
              Please select which window you are assigned to for this session.
            </p>
            <div class="d-grid gap-3">
              <button
                type="button"
                class="btn btn-outline-primary p-3 text-start fw-semibold position-relative"
                onclick="selectWindow('Window 1', event)"
              >
                <i class="bi bi-display me-3 fs-5"></i> Window 1
              </button>
              <button
                type="button"
                class="btn btn-outline-primary p-3 text-start fw-semibold position-relative"
                onclick="selectWindow('Window 2', event)"
              >
                <i class="bi bi-display me-3 fs-5"></i> Window 2
              </button>
              <button
                type="button"
                class="btn btn-outline-primary p-3 text-start fw-semibold position-relative"
                onclick="selectWindow('Window 3', event)"
              >
                <i class="bi bi-display me-3 fs-5"></i> Window 3
              </button>
              <button
                type="button"
                class="btn btn-outline-primary p-3 text-start fw-semibold position-relative"
                onclick="selectWindow('Window 4', event)"
              >
                <i class="bi bi-display me-3 fs-5"></i> Window 4
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div
      id="windowDetailsModal"
      class="modal fade"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div
          class="modal-content border-0 shadow-lg"
          style="max-width: 800px; width: 100%"
        >
          <div class="modal-header bg-light border-0">
            <h5
              class="modal-title fw-bold text-primary"
              id="windowDetailsTitle"
            >
              Window Details
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div
            class="modal-body p-4"
            style="
              background-color: #f8f9fa;
              max-height: 60vh;
              overflow-y: auto;
            "
          >
            <div id="windowDetailsList"></div>
          </div>
          <div class="modal-footer border-0 bg-light">
            <button
              type="button"
              class="btn btn-secondary px-4"
              data-bs-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>
    <div id="editStaffModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Edit Staff Account</h3>
          <span class="modal-close" onclick="toggleModal('editStaffModal')"
            >&times;</span
          >
        </div>
        <div class="modal-body">
          <input type="hidden" id="editStaffId" />
          <div class="form-group">
            <label>Full Name</label>
            <input type="text" id="editStaffName" class="form-input" />
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="editStaffEmail" class="form-input" />
          </div>
          <div class="form-group">
            <label>Phone</label>
            <input type="text" id="editStaffPhone" class="form-input" />
          </div>
          <div class="form-group">
            <label>Department</label>
            <input type="text" id="editStaffDept" class="form-input" />
          </div>
          <div class="form-group">
            <label>Role</label>
            <select id="editStaffRole" class="form-select form-input">
              <option value="staff">Staff</option>
              <option value="admin">Admin</option>
              <option value="super_admin">Super Admin</option>
            </select>
          </div>
          <div class="form-group">
            <label>Reset Password (Optional)</label>
            <input
              type="password"
              id="editStaffPassword"
              class="form-input"
              placeholder="Leave blank to keep current"
            />
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="toggleModal('editStaffModal')"
          >
            Cancel
          </button>
          <button class="btn btn-primary" onclick="staffManager.updateStaff()">
            Save Changes
          </button>
        </div>
      </div>
    </div>
    <div id="registerStaffModal" class="modal">
      <div class="modal-content" style="max-width: 600px">
        <div class="modal-header">
          <h3>Register New Staff Member</h3>
          <span class="modal-close" onclick="toggleModal('registerStaffModal')"
            >&times;</span
          >
        </div>
        <div class="modal-body">
          <form id="dashboardRegisterForm">
            <div class="row mb-3">
              <div class="col-md-5">
                <label class="form-label"
                  >Last Name <span class="text-danger">*</span></label
                >
                <input
                  type="text"
                  class="form-input"
                  id="regLastName"
                  required
                />
              </div>
              <div class="col-md-5">
                <label class="form-label"
                  >First Name <span class="text-danger">*</span></label
                >
                <input
                  type="text"
                  class="form-input"
                  id="regFirstName"
                  required
                />
              </div>
              <div class="col-md-2">
                <label class="form-label">M.I.</label>
                <input
                  type="text"
                  class="form-input"
                  id="regMiddleInitial"
                  maxlength="2"
                  placeholder="Opt"
                />
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label"
                  >Phone <span class="text-danger">*</span></label
                >
                <input
                  type="tel"
                  class="form-input"
                  id="regPhone"
                  placeholder="09..."
                  required
                />
              </div>
              <div class="col-md-6">
                <label class="form-label"
                  >Sex <span class="text-danger">*</span></label
                >
                <select class="form-select form-input" id="regSex" required>
                  <option value="" selected disabled>Select...</option>
                  <option value="Male">Male</option>
                  <option value="Female">Female</option>
                </select>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label"
                >Email (Username) <span class="text-danger">*</span></label
              >
              <input type="email" class="form-input" id="regEmail" required />
            </div>
            <div class="mb-3">
              <label class="form-label"
                >Permanent Address <span class="text-danger">*</span></label
              >
              <input type="text" class="form-input" id="regAddress" required />
            </div>

            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label"
                  >Password <span class="text-danger">*</span></label
                >
                <div class="input-group">
                  <input
                    type="password"
                    class="form-control form-input"
                    id="regPassword"
                    required
                    style="border-right: 0"
                  />
                  <span
                    class="input-group-text bg-white"
                    style="cursor: pointer; border-left: 0"
                    onclick="toggleRegPassword('regPassword', this)"
                  >
                    <i class="bi bi-eye"></i>
                  </span>
                </div>
              </div>
              <div class="col-md-6">
                <label class="form-label"
                  >Confirm Password <span class="text-danger">*</span></label
                >
                <div class="input-group">
                  <input
                    type="password"
                    class="form-control form-input"
                    id="regConfirmPassword"
                    required
                    style="border-right: 0"
                  />
                  <span
                    class="input-group-text bg-white"
                    style="cursor: pointer; border-left: 0"
                    onclick="toggleRegPassword('regConfirmPassword', this)"
                  >
                    <i class="bi bi-eye"></i>
                  </span>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="toggleModal('registerStaffModal')"
          >
            Cancel
          </button>
          <button
            class="btn btn-success"
            onclick="submitNewStaffRegistration()"
          >
            Create Account
          </button>
        </div>
      </div>
    </div>
    <!-- --------------------------------------------- END OF MANUAL TRANSACTION MODAL ------------------------------------------------->

    <!-- Add Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

    <script>
      // -------------------------- BOOTSTRAP OFFCANVAS SIDEBAR FOR MOBILE USING OFFCANVAS COMPONENT--------------------------------------

      // Initialize Bootstrap Offcanvas for sidebar on mobile
      document.querySelectorAll(".menu-item").forEach((item) => {
        item.addEventListener("click", () => {
          const offcanvasEl = document.getElementById("sidebarOffcanvas");
          const bsOffcanvas = bootstrap.Offcanvas.getInstance(offcanvasEl);
          if (bsOffcanvas && window.innerWidth <= 768) {
            bsOffcanvas.hide();
          }
        });
      });
      // Keep your existing navigation setup but update it to work with Bootstrap
      function setupNavigation() {
        const menuItems = document.querySelectorAll(".menu-item");
        menuItems.forEach((item) => {
          item.addEventListener("click", () => {
            const targetPage = item.getAttribute("data-page");
            // Remove active class from all menu items and pages
            menuItems.forEach((mi) => mi.classList.remove("active"));
            document
              .querySelectorAll(".page")
              .forEach((page) => page.classList.remove("active"));
            // Add active class to clicked item
            item.classList.add("active");
            // Show target page
            showPage(targetPage);
            // On mobile, the offcanvas will auto-close due to data-bs-dismiss="offcanvas"
          });
        });
      }
      // -------------------------- END OF BOOTSTRAP OFFCANVAS SIDEBAR FOR MOBILE USING OFFCANVAS COMPONENT--------------------------------------

      // -------------------------- SHOW PAGE FUNCTION TO HANDLE PAGE NAVIGATION -----------------------------------------------------
      function showPage(page) {
        // Hide all pages
        document.querySelectorAll(".page").forEach((p) => {
          p.classList.remove("active");

          // Clear search bar if leaving documents page
          if (p.id === "documents-page") {
            const searchInput = document.getElementById(
              "serviceRequestSearchInput"
            );
            if (searchInput && searchInput.value !== "") {
              searchInput.value = "";
              const searchBtn = document.getElementById(
                "serviceRequestSearchBtn"
              );
              if (searchBtn) searchBtn.click();
            }
          }
        });

        // Show target page
        const pageToShow = document.getElementById(page + "-page");

        if (pageToShow) {
          pageToShow.classList.add("active");

          // Refresh data for specific pages
          if (page === "queue" && queueManager) {
            queueManager.loadQueues();
          } else if (page === "documents" && serviceRequestManager) {
            serviceRequestManager.loadServiceRequests();
          } else if (page === "reports") {
            updateReportsData();
            if (queueManager)
              queueManager.loadQueues().then(() => updateReportsData());
            if (serviceRequestManager)
              serviceRequestManager
                .loadServiceRequests()
                .then(() => updateReportsData());
          } else if (page === "github") {
            loadGitHubData();
          } else if (page === "staff-management") {
            if (typeof staffManager !== "undefined") {
              staffManager.loadAllStaff();
            }
          }
        } else {
          // This 'else' handles cases where the page ID doesn't exist
          console.error("Page not found:", page);
          // Fallback to queue page
          const fallback = document.getElementById("queue-page");
          if (fallback) fallback.classList.add("active");
        }
      }
      // -------------------------- END SHOW PAGE FUNCTION -----------------------------------------------------

      // -------------------------- END SHOW PAGE FUNCTION TO HANDLE PAGE NAVIGATION -----------------------------------------------------

      // Initialize managers
      let serviceRequestManager;
      let queueManager;
      let isQueuePaused = false;
      let fcrChartInstance = null;
      let currentWindow = null;
      let windowSelectionModalObj = null;

      // Admin Dashboard Authentication Helper
      const adminToken = localStorage.getItem("adminToken");
      console.log(
        "Admin token from localStorage:",
        adminToken ? "Present" : "Missing"
      );
      let currentStaff = null;
      // Function to make authenticated API calls
      function makeAuthenticatedRequest(url, options = {}) {
        if (!adminToken) {
          console.error("No admin token found, redirecting to login");
          adminLogout();
          return Promise.reject("No admin token");
        }
        const defaultOptions = {
          headers: {
            Authorization: `Bearer ${adminToken}`,
            "Content-Type": "application/json",
            ...options.headers,
          },
        };
        console.log("Making authenticated request to:", url);
        return fetch(url, { ...defaultOptions, ...options });
      }

      // ---------------------------------------------------------
      // BLOCK 1: Display Staff Info & Handle Super Admin (FIXED)
      // ---------------------------------------------------------
      function displayStaffInfo(staff) {
        currentStaff = staff; // Update global variable

        // 1. Update Sidebar Name
        const sidebarNameEl = document.getElementById("sidebarStaffName");
        if (sidebarNameEl) {
          sidebarNameEl.textContent = staff.full_name;
        }

        // 2. Update Sidebar Role
        const sidebarRoleEl = document.getElementById("sidebarStaffRole");
        if (sidebarRoleEl) {
          const formattedRole = staff.role
            .replace("_", " ")
            .replace(/\b\w/g, (s) => s.toUpperCase());
          sidebarRoleEl.textContent = formattedRole;
        }

        // 3. Update Sidebar Avatar Initials
        const sidebarAvatarEl = document.getElementById("sidebarAvatar");
        let initials = "AD"; // Default
        if (sidebarAvatarEl) {
          if (staff.first_name && staff.last_name) {
            initials = (
              staff.first_name.charAt(0) + staff.last_name.charAt(0)
            ).toUpperCase();
          } else if (staff.full_name) {
            initials = staff.full_name.substring(0, 2).toUpperCase();
          }
          sidebarAvatarEl.textContent = initials;
        }

        // 4. Update Settings Page Details (FIXED SECTION)
        if (document.getElementById("staffFullName"))
          document.getElementById("staffFullName").textContent =
            staff.full_name;

        if (document.getElementById("staffEmail"))
          document.getElementById("staffEmail").textContent = staff.email;

        if (document.getElementById("staffRole"))
          document.getElementById("staffRole").textContent = staff.role
            .replace("_", " ")
            .toUpperCase();

        if (document.getElementById("staffDepartment"))
          document.getElementById("staffDepartment").textContent =
            staff.department || "Not Specified";

        if (document.getElementById("staffPhone"))
          document.getElementById("staffPhone").textContent =
            staff.phone || "Not Specified";

        if (document.getElementById("staffLastLogin"))
          document.getElementById("staffLastLogin").textContent =
            staff.last_login
              ? new Date(staff.last_login).toLocaleString()
              : "First Login";

        if (document.getElementById("staffMemberSince"))
          document.getElementById("staffMemberSince").textContent =
            staff.created_at
              ? new Date(staff.created_at).toLocaleDateString()
              : "N/A";

        // Update Avatar in Settings Page to match Sidebar
        if (document.getElementById("staffAvatarInitials"))
          document.getElementById("staffAvatarInitials").textContent = initials;

        // üü¢ 5. SUPER ADMIN CHECK üü¢
        if (staff.role === "super_admin") {
          console.log("üëë Super Admin Detected");

          // A. Show the "Staff Accounts" tab in sidebar
          const staffNav = document.getElementById("nav-staff-management");
          if (staffNav) staffNav.style.display = "flex";

          // B. Force "Supervisor" mode (Bypasses Window Selection)
          localStorage.setItem("assignedWindow", "Supervisor");
          currentWindow = "Supervisor";

          // Update UI to show Supervisor mode
          const winDisplay = document.getElementById("currentWindowDisplay");
          if (winDisplay) winDisplay.textContent = "Supervisor";

          const sidebarTitle = document.querySelector(".sidebar-title");
          if (sidebarTitle)
            sidebarTitle.innerHTML = `Super Admin<br><small style="font-size:11px; color:#ccc;">Supervisor View</small>`;

          // C. Load staff data immediately
          if (typeof staffManager !== "undefined") {
            staffManager.loadAllStaff();
          }
        }
      }

      // Check authentication on page load
      // Check authentication on page load
      if (!adminToken) {
        window.location.href = "/adminLogin";
      } else {
        console.log("Admin token found, verifying...");
        // Verify token is still valid on page load
        makeAuthenticatedRequest("/api/admin/me")
          .then((response) => {
            console.log("Auth check response status:", response.status);
            return response.json();
          })
          .then((data) => {
            console.log("Auth check response:", data);
            if (!data.success) {
              console.log("Token invalid, logging out");
              adminLogout();
            } else {
              console.log("Admin logged in:", data.admin);

              // 1. Update Sidebar info (Name, Role, Avatar)
              displayStaffInfo(data.admin);

              // 2. Load initial data
              if (queueManager) {
                queueManager.loadQueues();
              }
              if (serviceRequestManager) {
                serviceRequestManager.loadServiceRequests();
              }

              // üü¢ 3. PASTE THIS HERE: CHECK WINDOW ASSIGNMENT üü¢
              // We call this here because we need 'currentStaff' (set in displayStaffInfo)
              // to be ready so we know if they are a Super Admin or not.
              checkWindowAssignment();
            }
          })
          .catch((error) => {
            console.error("Auth check failed:", error);
            adminLogout();
          });
      }

      // Admin logout function
      function adminLogout() {
        localStorage.removeItem("admin");
        localStorage.removeItem("adminToken");
        localStorage.removeItem("assignedWindow"); // Clear client-side cache
        window.location.href = "/adminLogin";
      }

      // Global function to unassign the window
      async function unassignWindowOnServer(windowToUnassign) {
        // Use the passed argument, or fall back to the global variable
        const targetWindow = windowToUnassign || currentWindow;

        if (targetWindow && adminToken) {
          try {
            console.log("Attempting to unassign:", targetWindow);
            await makeAuthenticatedRequest("/api/admin/unassign-window", {
              method: "POST",
              body: JSON.stringify({ windowNumber: targetWindow }),
            });
            console.log("Server unassign success");
          } catch (e) {
            console.warn("Failed to unassign window on server.", e);
          }
        }
        // Clear client-side state
        currentWindow = null;
        localStorage.removeItem("assignedWindow");
      }

      // Navigation functionality
      document.addEventListener("DOMContentLoaded", function () {
        console.log("Admin dashboard initialized");

        // üü¢ FIX: REMOVED the line localStorage.removeItem("assignedWindow");
        // This allows the browser to remember the window on refresh.

        // Initialize managers
        serviceRequestManager = new ServiceRequestManager();
        queueManager = new QueueManager();
        // Pre-load data in the background on page load
        serviceRequestManager.loadServiceRequests();
        queueManager.loadQueues();

        // Set up navigation
        setupNavigation();

        // Show initial page
        showPage("queue");

        // Load preferences
        loadPreferences();

        // Set up enhanced auto-refresh
        setupEnhancedAutoRefresh();

        // üü¢ FIX: Ensure window check runs after everything else is ready üü¢
        // This function will now check local storage first before showing the modal.
        // checkWindowAssignment();
      });

      // ‚¨áÔ∏è REPLACE THIS FUNCTION ‚¨áÔ∏è
      function showReportDetail(reportId) {
        if (reportId === "today") {
          // Call the new function to populate the page
          populateTodayReportDetail();
        } else {
          // This can be used later for other reports
        }
        showPage("report-detail");
      }
      // ‚¨ÜÔ∏è END OF REPLACEMENT ‚¨ÜÔ∏è

      function toggleQueuePause() {
        isQueuePaused = !isQueuePaused;
        const btn = document.getElementById("pauseQueueBtn");
        if (isQueuePaused) {
          btn.innerHTML = "‚ñ∂Ô∏è Resume Queue";
          showNotification("Queue processing paused", "warning");
        } else {
          btn.innerHTML = "‚è∏Ô∏è Pause Queue";
          showNotification("Queue processing resumed", "success");
        }
      }

      // ‚¨áÔ∏è REPLACE THIS FUNCTION ‚¨áÔ∏è
      function updateReportsData() {
        // Update report statistics

        // 1. Update from Queue Manager (as before)
        if (queueManager && queueManager.queues) {
          // Use all queues for a more accurate total
          const total =
            (queueManager.queues.waiting || []).length +
            (queueManager.queues.processing || []).length +
            (queueManager.queues.ready || []).length +
            (queueManager.queues.completed || []).length +
            (queueManager.queues.priority || []).length;

          document.getElementById("totalRequestsSummary").textContent = total;
          document.getElementById("completedSummary").textContent = (
            queueManager.queues.completed || []
          ).length;
          document.getElementById("totalRequestsToday").textContent = total;
          // 3. Update the Recent Requests list
          renderRecentRequests(queueManager.queues);
          // 4. Update the Report History list
          renderReportHistory(queueManager.queues);
        }

        // 2. Update FCR Chart from Service Request Manager
        if (serviceRequestManager && serviceRequestManager.requests) {
          // --- START OF FIX ---
          // Get today's date as a string (e.g., "2025-10-31")
          const todayStr = new Date().toLocaleDateString("en-CA");

          // Filter approved for today
          const approvedCount = serviceRequestManager.requests.filter((req) => {
            if (req.status !== "approved" || !req.approved_at) {
              return false;
            }
            const requestDateStr = new Date(req.approved_at).toLocaleDateString(
              "en-CA"
            );
            return requestDateStr === todayStr;
          }).length;

          // Filter declined for today
          const declinedCount = serviceRequestManager.requests.filter((req) => {
            if (req.status !== "declined" || !req.declined_at) {
              return false;
            }
            const requestDateStr = new Date(req.declined_at).toLocaleDateString(
              "en-CA"
            );
            return requestDateStr === todayStr;
          }).length;
          // --- END OF FIX ---

          // Call the new chart rendering function
          renderFCRChart(approvedCount, declinedCount);
        } else {
          // If manager isn't ready, render an empty chart
          renderFCRChart(0, 0);
        }
      }
      // ‚¨ÜÔ∏è END OF REPLACEMENT ‚¨ÜÔ∏è
      // ‚¨áÔ∏è ADD THIS ENTIRE NEW FUNCTION ‚¨áÔ∏è

      /**
       * Renders or updates the First Contact Resolution (FCR) donut chart.
       * We use (Approved) / (Approved + Declined) as the FCR metric.
       */
      function renderFCRChart(approvedCount, declinedCount) {
        const ctx = document.getElementById("fcrChart");
        if (!ctx) {
          console.warn("FCR Chart canvas not found.");
          return; // Don't do anything if canvas isn't there
        }

        const totalHandled = approvedCount + declinedCount;
        const fcrRate =
          totalHandled > 0
            ? ((approvedCount / totalHandled) * 100).toFixed(1)
            : 0;

        const chartData = {
          labels: ["Resolved (Approved)", "Not Resolved (Declined)"],
          datasets: [
            {
              label: "Request Status",
              data: [approvedCount, declinedCount],
              backgroundColor: [
                "rgba(40, 167, 69, 0.85)", // Bootstrap Success
                "rgba(220, 53, 69, 0.85)", // Bootstrap Danger
              ],
              borderColor: [
                "rgba(255, 255, 255, 0.7)",
                "rgba(255, 255, 255, 0.7)",
              ],
              borderWidth: 2,
            },
          ],
        };

        const chartConfig = {
          type: "doughnut",
          data: chartData,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: "70%", // Makes it a donut
            plugins: {
              legend: {
                position: "bottom",
                labels: {
                  padding: 20,
                },
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    let label = context.label || "";
                    if (label) {
                      label += ": ";
                    }
                    if (context.parsed !== null) {
                      const percentage =
                        totalHandled > 0
                          ? ((context.parsed / totalHandled) * 100).toFixed(1)
                          : 0;
                      label += `${context.parsed} requests (${percentage}%)`;
                    }
                    return label;
                  },
                },
              },
              // This adds the "FCR: XX%" text in the middle
              title: {
                display: false, // We will draw it manually
              },
            },
            // Custom plugin to draw text in the center
            animation: {
              onComplete: (chart) => {
                const chartCtx = chart.ctx;
                chartCtx.save();
                const x = chart.getDatasetMeta(0).data[0].x;
                const y = chart.getDatasetMeta(0).data[0].y;

                chartCtx.textAlign = "center";
                chartCtx.textBaseline = "middle";

                // FCR Rate Text
                chartCtx.font = "bold 24px Poppins, sans-serif";
                chartCtx.fillStyle = "#333"; // Use body color
                chartCtx.fillText(`${fcrRate}%`, x, y - 10);

                // "FCR" Label
                chartCtx.font = "14px Poppins, sans-serif";
                chartCtx.fillStyle = "#777"; // Muted color
                chartCtx.fillText("FCR Rate", x, y + 15);

                chartCtx.restore();
              },
            },
          },
        };

        // If chart doesn't exist, create it
        if (!fcrChartInstance) {
          fcrChartInstance = new Chart(ctx, chartConfig);
        } else {
          // If it exists, update its data and refresh
          fcrChartInstance.data = chartData;
          fcrChartInstance.update();
        }
      }
      // ‚¨ÜÔ∏è END OF NEW FUNCTION ‚¨ÜÔ∏è
      // ‚¨áÔ∏è ADD THIS ENTIRE NEW FUNCTION ‚¨áÔ∏è

      /**
       * Populates the 'Recent Client Requests' list on the Reports page.
       * Gathers all requests from the queueManager, sorts them, and shows the top 5.
       */
      function renderRecentRequests(queues) {
        const listElement = document.getElementById("recentRequestsList");
        if (!listElement) {
          console.warn("Recent requests list element not found.");
          return;
        }

        // 1. Combine all available queue arrays
        const allRequests = [
          ...(queues.waiting || []),
          ...(queues.processing || []),
          ...(queues.ready || []),
          ...(queues.completed || []),
          ...(queues.priority || []),
        ];

        // 2. Sort by 'submitted_at' time, most recent first
        allRequests.sort(
          (a, b) => new Date(b.submitted_at) - new Date(a.submitted_at)
        );

        // 3. Use all recent requests (CSS will handle scrolling)
        const recentRequests = allRequests;

        // 4. Handle empty state
        if (recentRequests.length === 0) {
          listElement.innerHTML = `
                <li class="request-list-item empty">
                  No requests found for today.
                </li>
              `;
          return;
        }

        // 5. Build and inject the HTML
        // 5. Build and inject the HTML
        listElement.innerHTML = recentRequests
          .map((request) => {
            // Safely get service name
            const services = Array.isArray(request.services)
              ? request.services
              : [];
            let mainService = "General Request"; // Default
            if (services.length > 0) {
              // Try to parse if it's JSON string, otherwise use as-is
              try {
                const parsedServices = JSON.parse(services[0]);
                mainService = Array.isArray(parsedServices)
                  ? parsedServices[0]
                  : services[0];
              } catch (e) {
                mainService = services[0]; // It's just a string
              }
            } else if (request.service) {
              mainService = request.service;
            }

            // Utility to prevent XSS (HTML injection)
            const escape = (str) => {
              if (str === null || str === undefined) return "";
              return String(str)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;");
            };

            const clientName = escape(request.user_name);
            const serviceName = escape(mainService);

            return `
                <li class="request-list-item">
                  <div class="client-name" title="${clientName}">${clientName}</div>
                  <div class="service-name" title="${serviceName}">${serviceName}</div>
                </li>
              `;
          })
          .join("");
      }
      // ‚¨ÜÔ∏è END OF NEW FUNCTION ‚¨ÜÔ∏è

      function setupAutoRefresh() {
        // Refresh queue data every 10 seconds
        setInterval(() => {
          if (
            !isQueuePaused &&
            document.getElementById("queue-page").classList.contains("active")
          ) {
            queueManager.loadQueues();
          }
        }, 10000);

        // Refresh service requests every 30 seconds
        setInterval(() => {
          if (
            document
              .getElementById("documents-page")
              .classList.contains("active")
          ) {
            serviceRequestManager.loadServiceRequests();
          }
        }, 30000);
      }

      // Modal functions
      function toggleModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
          modal.classList.toggle("active");
        }
      }

      // Close modal when clicking outside
      window.onclick = function (event) {
        if (event.target.classList.contains("modal")) {
          event.target.classList.remove("active");
        }
      };

      // Theme toggle
      let currentTheme = "light";
      function toggleTheme() {
        currentTheme = currentTheme === "light" ? "dark" : "light";
        document.getElementById("themeValue").textContent =
          currentTheme === "light" ? "Light" : "Dark";

        if (currentTheme === "dark") {
          document.documentElement.setAttribute("data-theme", "dark");
          document.body.classList.add("dark-theme");
        } else {
          document.documentElement.removeAttribute("data-theme");
          document.body.classList.remove("dark-theme");
        }

        showNotification(
          "Theme changed to " + (currentTheme === "light" ? "Light" : "Dark")
        );

        // Save to localStorage
        localStorage.setItem("adminTheme", currentTheme);
      }

      // Font size toggle
      const fontSizes = ["Small", "Medium", "Large"];
      let currentFontSizeIndex = 1;
      function toggleFontSize() {
        currentFontSizeIndex = (currentFontSizeIndex + 1) % fontSizes.length;
        const fontSize = fontSizes[currentFontSizeIndex];
        document.getElementById("fontSizeValue").textContent = fontSize;

        const sizes = {
          Small: "14px",
          Medium: "16px",
          Large: "18px",
        };

        document.body.style.fontSize = sizes[fontSize];
        showNotification("Font size changed to " + fontSize);

        // Save to localStorage
        localStorage.setItem("adminFontSize", fontSize);
      }

      // Load saved preferences
      function loadPreferences() {
        // Load theme
        const savedTheme = localStorage.getItem("adminTheme");
        if (savedTheme) {
          currentTheme = savedTheme;
          document.getElementById("themeValue").textContent =
            savedTheme === "light" ? "Light" : "Dark";
          if (savedTheme === "dark") {
            document.documentElement.setAttribute("data-theme", "dark");
            document.body.classList.add("dark-theme");
          }
        }

        // Load font size
        const savedFontSize = localStorage.getItem("adminFontSize");
        if (savedFontSize) {
          const sizes = { Small: "14px", Medium: "16px", Large: "18px" };
          document.body.style.fontSize = sizes[savedFontSize];
          document.getElementById("fontSizeValue").textContent = savedFontSize;
          currentFontSizeIndex = fontSizes.indexOf(savedFontSize);
        }
      }

      // Save functions
      function saveAccountDetails() {
        showNotification("Account details saved successfully!");
        toggleModal("accountDetailsModal");
      }

      function changePassword() {
        showNotification("Password changed successfully!");
        toggleModal("passwordModal");
      }

      function saveWaitingTime() {
        showNotification("Waiting time settings saved!");
        toggleModal("waitingTimeModal");
      }

      function saveMonitoring() {
        showNotification("Monitoring settings saved!");
        toggleModal("monitoringModal");
      }

      function saveNotification() {
        showNotification("Notification settings saved!");
        toggleModal("notificationModal");
      }

      // Notification system
      function showNotification(message, type = "success") {
        // Remove existing notification if any
        const existingNotif = document.querySelector(".notification-toast");
        if (existingNotif) {
          existingNotif.remove();
        }

        // Create notification
        const notification = document.createElement("div");
        notification.className = "notification-toast";
        notification.textContent = message;

        // Style based on type
        const bgColor =
          type === "error"
            ? "#d32f2f"
            : type === "warning"
            ? "#f57c00"
            : "#2e7d32";
        notification.style.cssText = `
                  position: fixed;
                  top: 20px;
                  right: 20px;
                  background: ${bgColor};
                  color: white;
                  padding: 15px 25px;
                  border-radius: 8px;
                  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                  z-index: 10000;
                  animation: slideInRight 0.3s ease-out;
              `;

        document.body.appendChild(notification);

        // Remove after 3 seconds
        setTimeout(() => {
          if (notification.parentNode) {
            notification.style.animation = "slideOutRight 0.3s ease-out";
            setTimeout(() => {
              if (notification.parentNode) {
                notification.remove();
              }
            }, 300);
          }
        }, 3000);
      }

      // Service Request Management
      class ServiceRequestManager {
        constructor() {
          this.currentAdmin = "Jila Santos";
          this.requests = [];
        }

        async loadServiceRequests() {
          try {
            console.log("Loading service requests...");
            const response = await makeAuthenticatedRequest(
              "/api/admin/service-requests"
            );

            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();

            if (result.success) {
              this.requests = result.requests || [];
              this.renderRequests();
              this.updateStats();
              console.log(
                "Service requests loaded successfully:",
                this.requests.length
              );
            } else {
              console.error("Error loading service requests:", result.message);
              this.showEmptyState();
              showNotification(
                "Failed to load service requests: " + result.message,
                "error"
              );
            }
          } catch (error) {
            console.error("Error loading service requests:", error);
            this.showEmptyState();
            if (error.message.includes("No admin token")) {
              showNotification("Session expired. Please login again.", "error");
              adminLogout();
            } else {
              showNotification("Failed to load service requests", "error");
            }
          }
        }

        showEmptyState() {
          const containers = [
            "pendingRequestsContainer",
            "approvedRequestsContainer",
            "declinedRequestsContainer",
          ];

          containers.forEach((containerId) => {
            const container = document.getElementById(containerId);
            if (container) {
              container.innerHTML = `
                              <div class="empty-state">
                                  <div style="text-align: center; padding: 40px; color: #999;">
                                      <div style="font-size: 3rem;">üìã</div>
                                      <p style="margin-top: 10px;">No service requests found.</p>
                                  </div>
                              </div>
                          `;
            }
          });

          this.updateStats();
        }

        renderRequests() {
          this.renderProcessingRequests(); // Active cards
          this.renderCompletedRequests(); // üü¢ ADD THIS CALL üü¢
        }

        // üü¢ UPDATED: Renders ALL active/claimed requests for this window (Oldest to Newest) üü¢
        renderProcessingRequests() {
          const container = document.getElementById(
            "processingRequestsContainer"
          );
          if (!container) return;

          // Get active queue data
          const processingQueueItems =
            queueManager && queueManager.queues
              ? queueManager.queues.processing
              : [];

          // Get Current Window Identity
          let activeWindow = localStorage.getItem("assignedWindow");
          if (!activeWindow || activeWindow === "null")
            activeWindow = currentWindow;

          // Helper
          const cleanString = (str) =>
            String(str || "")
              .replace(/[^a-zA-Z0-9]/g, "")
              .toLowerCase();
          const myCleanWindow = cleanString(activeWindow);

          // 1. Filter: Find ALL requests for THIS window
          const myRequests = processingQueueItems.filter(
            (item) => cleanString(item.window_number) === myCleanWindow
          );

          // 2. Sort: Oldest Started to Newest Started
          // This ensures the "oldest" claimed request appears at the top
          myRequests.sort(
            (a, b) => new Date(a.started_at) - new Date(b.started_at)
          );

          // üü¢ STATE 1: IDLE (No active requests)
          if (myRequests.length === 0) {
            container.innerHTML = `
                          <div class="text-center py-5 bg-white rounded shadow-sm border">
                              <div class="mb-3">
                                  <i class="bi bi-person-workspace display-1 text-muted opacity-25"></i>
                              </div>
                              <h3 class="fw-bold text-secondary">No Active Requests</h3>
                              <p class="text-muted">You are not currently serving any clients.</p>
                              <button class="btn btn-primary mt-3" onclick="showPage('queue')">
                                  <i class="bi bi-list-task me-2"></i> Go to Queue List
                              </button>
                          </div>`;
            return;
          }

          // üü¢ STATE 2: ACTIVE LIST (Rendering all claimed requests)

          // Determine colors based on window (same for all cards in this window)
          let borderColor = "#0d6efd"; // Default blue
          let badgeClass = "bg-primary";
          if (myCleanWindow.includes("2")) {
            borderColor = "#ffc107";
            badgeClass = "bg-warning text-dark";
          }
          if (myCleanWindow.includes("3")) {
            borderColor = "#0dcaf0";
            badgeClass = "bg-info text-dark";
          }
          if (myCleanWindow.includes("4")) {
            borderColor = "#dc3545";
            badgeClass = "bg-danger";
          }

          // Generate HTML for ALL active cards
          const cardsHtml = myRequests
            .map((req) => {
              const services = Array.isArray(req.services) ? req.services : [];

              return `
                      <div class="card border-0 shadow-sm animate__animated animate__fadeIn mb-4">
                          <div class="card-body p-4" style="border-left: 8px solid ${borderColor};">

                              <div class="d-flex justify-content-between align-items-start mb-3">
                                  <div>
                                      <h3 class="fw-bold mb-1">${this.escapeHtml(
                                        req.user_name
                                      )}</h3>
                                      <p class="text-muted mb-0 fs-6">Student ID: <strong>${this.escapeHtml(
                                        req.student_id
                                      )}</strong></p>
                                  </div>
                                  <div class="text-end">
                                      <span class="badge ${badgeClass} fs-5 px-3 py-2 rounded-pill shadow-sm">
                                          ${this.escapeHtml(req.queue_number)}
                                      </span>
                                  </div>
                              </div>

                              <div class="bg-light p-3 rounded mb-3">
                                  <label class="text-secondary small fw-bold text-uppercase mb-1">Requested Services</label>
                                  <div class="fs-6 fw-semibold text-dark">
                                      <i class="bi bi-gear-wide-connected me-2 text-primary"></i>
                                      ${this.escapeHtml(services.join(", "))}
                                  </div>
                              </div>

                              <div class="d-flex justify-content-between align-items-center pt-2 border-top">
                                  <div class="text-muted small">
                                      <i class="bi bi-clock me-1"></i> Started: ${new Date(
                                        req.started_at
                                      ).toLocaleTimeString()}
                                  </div>

                                  <button class="btn btn-success px-4 fw-bold shadow-sm" onclick="queueManager.markAsDone('${
                                    req.queue_id
                                  }')">
                                      <i class="bi bi-check-circle-fill me-2"></i> Mark as Done
                                  </button>
                              </div>

                          </div>
                      </div>`;
            })
            .join("");

          container.innerHTML = `
                      <h3 class="section-title fs-5 text-primary fw-bold mb-3">
                          <i class="bi bi-person-check-fill me-2"></i> Now Serving (${myRequests.length})
                      </h3>
                      ${cardsHtml}
                  `;
        }

        // üü¢ NEW: Renders history of completed requests (Oldest to Newest) üü¢
        renderCompletedRequests() {
          const container = document.getElementById(
            "completedRequestsContainer"
          );
          if (!container) return;

          // 1. Get Completed Data from QueueManager
          const completedQueueItems =
            queueManager && queueManager.queues
              ? queueManager.queues.completed
              : [];

          // 2. Get Current Window
          let activeWindow = localStorage.getItem("assignedWindow");
          if (!activeWindow || activeWindow === "null")
            activeWindow = currentWindow;
          const cleanString = (str) =>
            String(str || "")
              .replace(/[^a-zA-Z0-9]/g, "")
              .toLowerCase();
          const myCleanWindow = cleanString(activeWindow);

          // 3. Filter for MY window only
          const myHistory = completedQueueItems.filter(
            (item) => cleanString(item.window_number) === myCleanWindow
          );

          if (myHistory.length === 0) {
            container.innerHTML = `
                          <div class="text-center py-3 text-muted bg-light rounded small">
                              No completed requests yet.
                          </div>`;
            return;
          }

          // 4. Sort: Oldest completed to Newest completed
          myHistory.sort(
            (a, b) => new Date(a.completed_at) - new Date(b.completed_at)
          );

          // 5. Render
          container.innerHTML = myHistory
            .map((item) => {
              const services = Array.isArray(item.services)
                ? item.services
                : [];

              // Determine Color
              let badgeClass = "bg-secondary";
              if (myCleanWindow.includes("1")) badgeClass = "bg-primary";
              else if (myCleanWindow.includes("2"))
                badgeClass = "bg-warning text-dark";
              else if (myCleanWindow.includes("3"))
                badgeClass = "bg-info text-dark";
              else if (myCleanWindow.includes("4")) badgeClass = "bg-danger";

              return `
                          <div class="document-item shadow-sm mb-2 p-3 rounded border-start border-3 border-success bg-white">
                              <div class="d-flex justify-content-between align-items-center">

                                  <div class="d-flex align-items-center gap-3">
                                      <span class="badge ${badgeClass} rounded-pill">${this.escapeHtml(
                item.queue_number
              )}</span>
                                      <div>
                                          <div class="fw-bold text-dark small">${this.escapeHtml(
                                            item.user_name
                                          )}</div>
                                          <div class="text-muted" style="font-size: 0.75rem;">ID: ${this.escapeHtml(
                                            item.student_id
                                          )}</div>
                                      </div>
                                  </div>

                                  <div class="text-secondary small px-2 text-truncate" style="max-width: 200px;">
                                      ${this.escapeHtml(services.join(", "))}
                                  </div>

                                  <div class="text-end text-success small" style="min-width: 80px;">
                                      <i class="bi bi-check-circle-fill me-1"></i> ${new Date(
                                        item.completed_at
                                      ).toLocaleTimeString([], {
                                        hour: "2-digit",
                                        minute: "2-digit",
                                      })}
                                  </div>
                              </div>
                          </div>
                      `;
            })
            .join("");
        }

        renderPendingRequests() {
          const container = document.getElementById("pendingRequestsContainer");
          if (!container) return;

          const pendingRequests = this.requests.filter(
            (req) => req.status === "pending"
          );

          if (pendingRequests.length === 0) {
            container.innerHTML = `
                          <div class="empty-state">
                              <div style="text-align: center; padding: 40px; color: #999;">
                                  <div style="font-size: 3rem;"> </div>
                                  <p style="margin-top: 10px;">No pending service requests.</p>
                              </div>
                          </div>
                      `;
            return;
          }

          container.innerHTML = pendingRequests
            .map(
              (request) => `
                              <div class="document-item">
                                  <div class="document-header">
                                      <div>
                                          <div class="document-title">${this.escapeHtml(
                                            request.services.join(", ")
                                          )}</div>
                                          <div class="document-description">
          <span class="requester-line">Requested by: ${this.escapeHtml(
            request.user_name
          )} (${this.escapeHtml(request.student_id)})</span><br>
          ${
            request.services
              ? `Service: ${this.escapeHtml(request.services.join(", "))}<br>`
              : ""
          }
          ${
            request.submitted_at
              ? `Submitted: ${new Date(request.submitted_at).toLocaleString()}`
              : ""
          }
      </div>
                                      </div>
                                      <div class="queue-number">Request ID: ${this.escapeHtml(
                                        request.request_id
                                      )}</div>
                                  </div>
                                  <div class="document-meta">
                                      <span>Submitted: ${new Date(
                                        request.submitted_at
                                      ).toLocaleString()}</span>
                                      <div class="button-group" style="margin-top: 10px;">
                                          <button class="btn btn-success btn-sm" onclick="serviceRequestManager.showApproveModal('${
                                            request.request_id
                                          }')">
                                              ‚úì Approve
                                          </button>
                                          <button class="btn btn-danger btn-sm" onclick="serviceRequestManager.showDeclineModal('${
                                            request.request_id
                                          }')">
                                              ‚úó Decline
                                          </button>
                                          <button class="btn btn-primary btn-sm" onclick="serviceRequestManager.viewRequestDetails('${
                                            request.request_id
                                          }')">
                                              üëÅÔ∏è View Details
                                          </button>
                                      </div>
                                  </div>
                              </div>
                          `
            )
            .join("");
        }

        renderApprovedRequests() {
          const container = document.getElementById(
            "approvedRequestsContainer"
          );
          if (!container) return;

          // 1. Get the start of today (midnight)
          const today = new Date();
          today.setHours(0, 0, 0, 0);

          // 2. Filter for approved AND approved_at date is on or after today
          const approvedRequests = this.requests.filter((req) => {
            return (
              req.status === "approved" &&
              req.approved_at && // Make sure the date exists
              new Date(req.approved_at) >= today
            ); // Compare it
          });

          if (approvedRequests.length === 0) {
            container.innerHTML = `
                          <div class="empty-state">
                              <div style="text-align: center; padding: 40px; color: #999;">
                                  <div style="font-size: 3rem;"></div>
                                  <p style="margin-top: 10px;">No approved service requests for today.</p>
                              </div>
                          </div>
                      `;
            return;
          }

          container.innerHTML = approvedRequests
            .map(
              (request) => `
                              <div class="document-item approved">
                                  <div class="document-header">
                                      <div>
                                          <div class="document-title">${this.escapeHtml(
                                            request.services.join(", ")
                                          )}</div>
                                          <div class="document-description">
          <span class="requester-line">Requested by: ${this.escapeHtml(
            request.user_name
          )} (${this.escapeHtml(request.student_id)})</span><br>
          ${
            request.services
              ? `Service: ${this.escapeHtml(request.services.join(", "))}<br>`
              : ""
          }
          ${
            request.approved_at
              ? `Approved at: ${new Date(request.approved_at).toLocaleString()}`
              : ""
          }
      </div>
                                      </div>
                                      <div class="queue-number">
                                          <span class="badge approved-badge">Approved</span>
                                      </div>
                                  </div>
                                  <div class="document-meta">
                                      <span>Request ID: ${this.escapeHtml(
                                        request.request_id
                                      )}</span>
                                  </div>
                              </div>
                          `
            )
            .join("");
        }

        renderDeclinedRequests() {
          const container = document.getElementById(
            "declinedRequestsContainer"
          );
          if (!container) return;

          // 1. Get the start of today (midnight)
          const today = new Date();
          today.setHours(0, 0, 0, 0);

          // 2. Filter for declined AND declined_at date is on or after today
          const declinedRequests = this.requests.filter((req) => {
            return (
              req.status === "declined" &&
              req.declined_at && // Make sure the date exists
              new Date(req.declined_at) >= today
            ); // Compare it
          });

          if (declinedRequests.length === 0) {
            container.innerHTML = `
                          <div class="empty-state">
                              <div style="text-align: center; padding: 40px; color: #999;">
                                  <div style="font-size: 3rem;"></div>
                                  <p style="margin-top: 10px;">No declined service requests for today.</p>
                              </div>
                          </div>
                      `;
            return;
          }

          container.innerHTML = declinedRequests
            .map(
              (request) => `
                              <div class="document-item declined">
                                  <div class="document-header">
                                      <div>
                                          <div class="document-title">${this.escapeHtml(
                                            request.services.join(", ")
                                          )}</div>
                                          <div class="document-description">
          <span class="requester-line">Requested by: ${this.escapeHtml(
            request.user_name
          )} (${this.escapeHtml(request.student_id)})</span><br>
          ${
            request.services
              ? `Service: ${this.escapeHtml(request.services.join(", "))}<br>`
              : ""
          }
          ${
            request.declined_at
              ? `Declined at: ${new Date(request.declined_at).toLocaleString()}`
              : ""
          }
      </div>
                                      </div>
                                      <div class="queue-number">
                                          <span class="badge declined-badge">Declined</span>
                                      </div>
                                  </div>
                                  <div class="document-meta">
                                      <span>${
                                        request.declined_at
                                          ? `Declined at: ${new Date(
                                              request.declined_at
                                            ).toLocaleString()}`
                                          : "Declined"
                                      }</span>
                                  </div>
                              </div>
                          `
            )
            .join("");
        }

        updateStats() {
          // Get today's date as a string (e.g., "2025-10-31")
          const todayStr = new Date().toLocaleDateString("en-CA");

          // Pending requests are always "current"
          const pendingCount = this.requests.filter(
            (req) => req.status === "pending"
          ).length;

          // Filter approved for today
          const approvedCount = this.requests.filter((req) => {
            if (req.status !== "approved" || !req.approved_at) {
              return false;
            }
            const requestDateStr = new Date(req.approved_at).toLocaleDateString(
              "en-CA"
            );
            return requestDateStr === todayStr;
          }).length;

          // Filter declined for today
          const declinedCount = this.requests.filter((req) => {
            if (req.status !== "declined" || !req.declined_at) {
              return false;
            }
            const requestDateStr = new Date(req.declined_at).toLocaleDateString(
              "en-CA"
            );
            return requestDateStr === todayStr;
          }).length;

          const pendingElement = document.getElementById("pendingCount");
          const approvedElement = document.getElementById("approvedCount");
          const declinedElement = document.getElementById("declinedCount");

          if (pendingElement) pendingElement.textContent = pendingCount;
          if (approvedElement) approvedElement.textContent = approvedCount;
          if (declinedElement) declinedElement.textContent = declinedCount;
        }

        showApproveModal(requestId) {
          const request = this.requests.find(
            (req) => req.request_id === requestId
          );
          if (!request) return;

          document.getElementById("approveRequestId").value = requestId;
          document.getElementById("approveRequestDetails").innerHTML =
            this.getRequestDetailsHTML(request);
          document.getElementById("approveNotes").value = "";

          toggleModal("approveRequestModal");
        }

        showDeclineModal(requestId) {
          const request = this.requests.find(
            (req) => req.request_id === requestId
          );
          if (!request) return;

          document.getElementById("declineRequestId").value = requestId;
          document.getElementById("declineRequestDetails").innerHTML =
            this.getRequestDetailsHTML(request);
          document.getElementById("declineReason").value = "";

          toggleModal("declineRequestModal");
        }

        viewRequestDetails(requestId) {
          const request = this.requests.find(
            (req) => req.request_id === requestId
          );
          if (!request) return;

          document.getElementById("requestDetailsContent").innerHTML =
            this.getDetailedRequestHTML(request);
          toggleModal("requestDetailsModal");
        }

        getRequestDetailsHTML(request) {
          return `
                      <div class="request-preview">
                          <strong>Student:</strong> ${this.escapeHtml(
                            request.user_name
                          )} (${this.escapeHtml(request.student_id)})<br>
                          <strong>Course:</strong> ${this.escapeHtml(
                            request.course
                          )} - ${this.escapeHtml(request.year_level)}<br>
                          <strong>Services:</strong> ${this.escapeHtml(
                            request.services.join(", ")
                          )}<br>
                          <strong>Total Amount:</strong> ‚Ç±${parseFloat(
                            request.total_amount || 0
                          ).toFixed(2)}<br>
                          <strong>Submitted:</strong> ${new Date(
                            request.submitted_at
                          ).toLocaleString()}
                      </div>
                  `;
        }

        getDetailedRequestHTML(request) {
          const services = Array.isArray(request.services)
            ? request.services
            : [];
          const requirements = Array.isArray(request.requirements)
            ? request.requirements
            : [];

          const requirementsHTML = requirements
            .map(
              (req) => `
                              <div class="requirement-item">
                                  <strong>${this.escapeHtml(
                                    req.service || "Service"
                                  )}:</strong><br>
                                  <ul>
                                      ${(req.requirements || [])
                                        .map(
                                          (r) =>
                                            `<li>${this.escapeHtml(r)}</li>`
                                        )
                                        .join("")}
                                  </ul>
                              </div>
                          `
            )
            .join("");

          return `
                      <div class="request-details">
                          <div class="info-row">
                              <span class="info-label">Request ID:</span>
                              <span class="info-value">${this.escapeHtml(
                                request.request_id
                              )}</span>
                          </div>
                          <div class="info-row">
                              <span class="info-label">Student Name:</span>
                              <span class="info-value">${this.escapeHtml(
                                request.user_name
                              )}</span>
                          </div>
                          <div class="info-row">
                              <span class="info-label">Student ID:</span>
                              <span class="info-value">${this.escapeHtml(
                                request.student_id
                              )}</span>
                          </div>
                          <div class="info-row">
                              <span class="info-label">Course & Year:</span>
                              <span class="info-value">${this.escapeHtml(
                                request.course
                              )} - ${this.escapeHtml(request.year_level)}</span>
                          </div>
                          ${
                            request.contact_email
                              ? `
                              <div class="info-row">
                                  <span class="info-label">Contact Email:</span>
                                  <span class="info-value">${this.escapeHtml(
                                    request.contact_email
                                  )}</span>
                              </div>
                          `
                              : ""
                          }
                          ${
                            request.contact_phone
                              ? `
                              <div class="info-row">
                                  <span class="info-label">Contact Phone:</span>
                                  <span class="info-value">${this.escapeHtml(
                                    request.contact_phone
                                  )}</span>
                              </div>
                          `
                              : ""
                          }
                          <div class="info-row">
                              <span class="info-label">Submitted:</span>
                              <span class="info-value">${new Date(
                                request.submitted_at
                              ).toLocaleString()}</span>
                          </div>

                          <h4>Requested Services</h4>
                          <div class="services-list">
                              ${services
                                .map(
                                  (service) => `
                                          <div class="service-item">
                                              <strong>‚Ä¢ ${this.escapeHtml(
                                                service
                                              )}</strong>
                                          </div>
                                      `
                                )
                                .join("")}
                              <div class="total-amount">
                                  <strong>Total Amount: ‚Ç±${parseFloat(
                                    request.total_amount || 0
                                  ).toFixed(2)}</strong>
                              </div>
                          </div>

                          ${
                            requirements.length > 0
                              ? `
                              <h4>Requirements</h4>
                              <div class="requirements-list">
                                  ${requirementsHTML}
                              </div>
                          `
                              : ""
                          }

                          ${
                            request.status === "approved" && request.approved_by
                              ? `
                              <div class="approval-details">
                                  <strong>Approval Details:</strong><br>
                                  Approved by: ${this.escapeHtml(
                                    request.approved_by
                                  )}<br>
                                  ${
                                    request.approved_at
                                      ? `Approved at: ${new Date(
                                          request.approved_at
                                        ).toLocaleString()}<br>`
                                      : ""
                                  }
                                  ${
                                    request.approve_notes
                                      ? `Notes: ${this.escapeHtml(
                                          request.approve_notes
                                        )}`
                                      : ""
                                  }
                              </div>
                          `
                              : ""
                          }

                          ${
                            request.status === "declined" && request.declined_by
                              ? `
                              <div class="decline-details">
                                  <strong>Decline Details:</strong><br>
                                  Declined by: ${this.escapeHtml(
                                    request.declined_by
                                  )}<br>
                                  ${
                                    request.declined_at
                                      ? `Declined at: ${new Date(
                                          request.declined_at
                                        ).toLocaleString()}<br>`
                                      : ""
                                  }
                                  ${
                                    request.decline_reason
                                      ? `Reason: ${this.escapeHtml(
                                          request.decline_reason
                                        )}`
                                      : ""
                                  }
                              </div>
                          `
                              : ""
                          }
                      </div>
                  `;
        }

        async confirmApproveRequest() {
          const requestId = document.getElementById("approveRequestId").value;
          const notes = document.getElementById("approveNotes").value;

          try {
            const response = await makeAuthenticatedRequest(
              "/api/admin/approve-request",
              {
                method: "POST",
                body: JSON.stringify({
                  requestId: requestId,
                  approveNotes: notes,
                }),
              }
            );

            const result = await response.json();

            if (result.success) {
              toggleModal("approveRequestModal");
              showNotification("Request approved successfully!");

              // Reload data
              await this.loadServiceRequests();

              // Refresh queue if on queue page
              if (
                queueManager &&
                document
                  .getElementById("queue-page")
                  .classList.contains("active")
              ) {
                await queueManager.loadQueues();
              }
            } else {
              alert("Error approving request: " + result.message);
            }
          } catch (error) {
            console.error("Error approving request:", error);
            alert("Error approving request. Please try again.");
          }
        }

        async confirmDeclineRequest() {
          const requestId = document.getElementById("declineRequestId").value;
          const reason = document.getElementById("declineReason").value;

          if (!reason.trim()) {
            alert("Please provide a reason for declining.");
            return;
          }

          try {
            const response = await makeAuthenticatedRequest(
              "/api/admin/decline-request",
              {
                method: "POST",
                body: JSON.stringify({
                  requestId: requestId,
                  declineReason: reason,
                }),
              }
            );

            const result = await response.json();

            if (result.success) {
              toggleModal("declineRequestModal");
              await this.loadServiceRequests();
              showNotification("Request declined successfully!");
            } else {
              alert("Error declining request: " + result.message);
            }
          } catch (error) {
            console.error("Error declining request:", error);
            alert("Error declining request. Please try again.");
          }
        }

        // Utility function to prevent XSS
        escapeHtml(unsafe) {
          if (unsafe === null || unsafe === undefined) return "";
          return String(unsafe)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
        }
      }
      /* --------------------------------------------------------------
         SERVICE REQUEST SEARCH ‚Äî BY REQUESTER NAME ONLY
         -------------------------------------------------------------- */
      document.addEventListener("DOMContentLoaded", () => {
        const searchInput = document.getElementById(
          "serviceRequestSearchInput"
        );
        const searchBtn = document.getElementById("serviceRequestSearchBtn");

        if (!searchInput || !searchBtn) return;

        const performSearch = () => {
          const term = searchInput.value.trim().toLowerCase();
          if (!serviceRequestManager?.requests?.length) return;

          ["pending", "approved", "declined"].forEach((status) => {
            const containerId = {
              pending: "pendingRequestsContainer",
              approved: "approvedRequestsContainer",
              declined: "declinedRequestsContainer",
            }[status];

            const container = document.getElementById(containerId);
            if (!container) return;

            const items = container.querySelectorAll(".document-item");
            let visible = 0;

            items.forEach((item) => {
              // ---- NEW: only look at the line that has class "requester-line" ----
              const requesterEl = item.querySelector(".requester-line");
              const requesterName = requesterEl
                ? requesterEl.textContent
                    .replace(/^Requested by:\s*/i, "")
                    .trim()
                    .toLowerCase()
                : "";

              const show = term === "" || requesterName.includes(term);
              item.style.display = show ? "" : "none";
              if (show) visible++;
            });

            // ---- Show / hide ‚Äúno results‚Äù message ----
            let noResult = container.querySelector(".no-result-msg");
            if (!noResult && visible === 0 && term !== "") {
              noResult = document.createElement("div");
              noResult.className = "no-result-msg text-center text-muted py-4";
              noResult.innerHTML = `<em>No ${status} requests found for "${searchInput.value}"</em>`;
              container.appendChild(noResult);
            } else if (noResult && (visible > 0 || term === "")) {
              noResult.remove();
            }
          });
        };

        // Button click
        searchBtn.addEventListener("click", performSearch);

        // Live search (debounced)
        let debounceTimer;
        searchInput.addEventListener("input", () => {
          clearTimeout(debounceTimer);
          debounceTimer = setTimeout(performSearch, 300);
        });

        // Re-apply after every render
        const originalRender = serviceRequestManager.renderRequests.bind(
          serviceRequestManager
        );
        serviceRequestManager.renderRequests = function () {
          originalRender();
          performSearch();
        };
      });

      // Staff Management (Super Admin)
      class StaffManager {
        async loadAllStaff() {
          try {
            const response = await makeAuthenticatedRequest(
              "/api/admin/all-staff"
            );
            const result = await response.json();

            if (result.success) {
              this.renderStaffList(result.staff);
            }
          } catch (error) {
            console.error("Error loading staff:", error);
          }
        }

        renderStaffList(staffList) {
          const container = document.getElementById("staffListContainer");
          if (!container) return;

          container.innerHTML = staffList
            .map((staff) => {
              // Logic: Check if this row is the currently logged-in user
              const isMe = currentStaff && currentStaff.id === staff.id;

              // Logic: Don't show Delete button for your own account
              const deleteButton = isMe
                ? `<button class="btn btn-sm btn-outline-secondary disabled ms-2" title="You cannot delete yourself"><i class="bi bi-trash"></i></button>`
                : `<button class="btn btn-sm btn-outline-danger ms-2" onclick="staffManager.deleteStaff(${staff.id}, '${staff.full_name}')" title="Delete Account"><i class="bi bi-trash"></i></button>`;

              // üü¢ FIX: Status Logic üü¢
              let statusBadge = "";

              if (isMe) {
                // If it is YOU, you are definitely Online
                if (staff.role === "super_admin") {
                  statusBadge = `<span class="badge bg-primary">Active: Supervisor</span>`;
                } else if (staff.assigned_window) {
                  statusBadge = `<span class="badge bg-success">Active: ${staff.assigned_window}</span>`;
                } else {
                  statusBadge = `<span class="badge bg-success">Online</span>`;
                }
              } else {
                // For others, rely on database status
                if (staff.assigned_window) {
                  statusBadge = `<span class="badge bg-success">Active: ${staff.assigned_window}</span>`;
                } else {
                  statusBadge =
                    '<span class="text-muted small">Offline / Idle</span>';
                }
              }

              return `
              <tr>
                  <td class="p-3 ps-4">
                      <div class="d-flex align-items-center">
                          <div class="staff-avatar-small me-3 bg-primary text-white rounded-circle d-flex justify-content-center align-items-center" style="width:35px; height:35px; font-size:12px;">
                              ${staff.full_name.charAt(0).toUpperCase()}
                          </div>
                          <div>
                              <div class="fw-bold text-dark">${
                                staff.full_name
                              } ${isMe ? "(You)" : ""}</div>
                              <div class="text-muted small">${staff.email}</div>
                          </div>
                      </div>
                  </td>
                  <td class="p-3"><span class="badge bg-secondary">${staff.role.replace(
                    "_",
                    " "
                  )}</span></td>
                  <td class="p-3">${staff.department || "N/A"}</td>
                  <td class="p-3">
                      ${statusBadge} 
                  </td>
                  <td class="p-3 text-end pe-4">
                      <button class="btn btn-sm btn-outline-primary" onclick='staffManager.openEditModal(${JSON.stringify(
                        staff
                      )})'>
                          <i class="bi bi-pencil"></i> Edit
                      </button>
                      ${deleteButton} 
                  </td>
              </tr>
          `;
            })
            .join("");
        }

        // üü¢ NEW: Delete Staff Function
        async deleteStaff(id, name) {
          if (
            !confirm(
              `‚ö†Ô∏è ARE YOU SURE?\n\nYou are about to permanently delete the account for "${name}".\nThis action cannot be undone.`
            )
          ) {
            return;
          }

          try {
            const response = await makeAuthenticatedRequest(
              `/api/admin/delete-staff/${id}`,
              {
                method: "DELETE",
              }
            );

            const result = await response.json();

            if (result.success) {
              showNotification(
                "Staff account deleted successfully.",
                "success"
              );
              this.loadAllStaff(); // Refresh the list immediately
            } else {
              alert("Failed to delete: " + result.message);
            }
          } catch (error) {
            console.error("Delete error:", error);
            alert("An error occurred while deleting the account.");
          }
        }

        openEditModal(staff) {
          document.getElementById("editStaffId").value = staff.id;
          document.getElementById("editStaffName").value = staff.full_name;
          document.getElementById("editStaffEmail").value = staff.email;
          document.getElementById("editStaffPhone").value = staff.phone || "";
          document.getElementById("editStaffDept").value =
            staff.department || "";
          document.getElementById("editStaffRole").value = staff.role;
          document.getElementById("editStaffPassword").value = ""; // Reset password field

          toggleModal("editStaffModal");
        }

        async updateStaff() {
          const id = document.getElementById("editStaffId").value;
          const data = {
            id: id,
            full_name: document.getElementById("editStaffName").value,
            email: document.getElementById("editStaffEmail").value,
            phone: document.getElementById("editStaffPhone").value,
            department: document.getElementById("editStaffDept").value,
            role: document.getElementById("editStaffRole").value,
            password: document.getElementById("editStaffPassword").value,
          };

          try {
            const response = await makeAuthenticatedRequest(
              "/api/admin/update-staff-account",
              {
                method: "POST",
                body: JSON.stringify(data),
              }
            );
            const result = await response.json();

            if (result.success) {
              showNotification("Staff updated successfully");
              toggleModal("editStaffModal");
              this.loadAllStaff(); // Reload list
            } else {
              alert(result.message);
            }
          } catch (error) {
            alert("Update failed");
          }
        }
      }
      // Initialize global instance
      const staffManager = new StaffManager();

      // Function to handle Super Admin registering new staff
      async function submitNewStaffRegistration() {
        // 1. Gather Data
        const lastName = document.getElementById("regLastName").value;
        const firstName = document.getElementById("regFirstName").value;
        const middleInitial = document.getElementById("regMiddleInitial").value;
        const phone = document.getElementById("regPhone").value;
        const sex = document.getElementById("regSex").value;
        const email = document.getElementById("regEmail").value;
        const address = document.getElementById("regAddress").value;
        const password = document.getElementById("regPassword").value;
        const confirmPassword =
          document.getElementById("regConfirmPassword").value;

        // 2. Validate
        if (
          !lastName ||
          !firstName ||
          !phone ||
          !sex ||
          !email ||
          !address ||
          !password
        ) {
          alert("Please fill in all required fields.");
          return;
        }

        if (password !== confirmPassword) {
          alert("Passwords do not match.");
          return;
        }

        // Construct full name automatically
        const fullName = `${firstName} ${
          middleInitial ? middleInitial + ". " : ""
        }${lastName}`.trim();

        const payload = {
          lastName,
          firstName,
          middleInitial,
          phone,
          sex,
          email,
          address,
          password,
          full_name: fullName,
        };

        // 3. Send to API (using Authenticated Request)
        try {
          const response = await makeAuthenticatedRequest(
            "/api/admin/register",
            {
              method: "POST",
              body: JSON.stringify(payload),
            }
          );

          const result = await response.json();

          if (result.success) {
            showNotification("Staff account created successfully!", "success");
            toggleModal("registerStaffModal");

            // Clear Form
            document.getElementById("dashboardRegisterForm").reset();

            // Refresh the staff list immediately
            if (typeof staffManager !== "undefined") {
              staffManager.loadAllStaff();
            }
          } else {
            alert("Error: " + result.message);
          }
        } catch (error) {
          console.error("Registration error:", error);
          alert("Failed to register staff. See console for details.");
        }
      }

      // Queue Manager
      class QueueManager {
        constructor() {
          this.queues = {
            waiting: [],
            processing: [],
            ready: [],
            completed: [],
            priority: [],
          };
          this.isAutoRefresh = true;
          this.lastUpdate = null;
        }

        async loadQueues() {
          try {
            console.log("Loading queues...");
            const response = await makeAuthenticatedRequest(
              "/api/admin/queues"
            );

            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();

            if (result.success) {
              this.queues = result.queues || {
                waiting: [],
                processing: [],
                ready: [],
                completed: [],
                priority: [],
              };

              // --- üü¢ REVERTED: The .reverse() line has been REMOVED üü¢ ---
              // The sorting is now handled correctly by the server.

              this.renderQueueDashboard();
              this.updateQueueStats();
              updateReportsData();
              this.lastUpdate = new Date();
              console.log("Queues loaded successfully:", this.queues);
            } else {
              console.error("Error loading queues:", result.message);
              this.showEmptyQueueState();
              showNotification(
                "Failed to load queue data: " + result.message,
                "error"
              );
            }
          } catch (error) {
            console.error("Error loading queues:", error);
            this.showEmptyQueueState();
            if (error.message.includes("No admin token")) {
              showNotification("Session expired. Please login again.", "error");
              adminLogout();
            } else if (!error.message.includes("Failed to fetch")) {
              showNotification("Failed to load queue data", "error");
            }
          }
        }

        renderQueueDashboard() {
          this.renderNowServing(); // Renamed from renderCurrentRequest
          this.renderNewRequests();
          this.renderAllProcessing(); // <--- üü¢ ADD THIS LINE üü¢
        }

        // üü¢ NEW FUNCTION: Opens the modal with details üü¢
        showWindowDetails(windowName) {
          // 1. Filter requests for this window
          const cleanString = (str) =>
            String(str || "")
              .replace(/[^a-zA-Z0-9]/g, "")
              .toLowerCase();
          const targetKey = cleanString(windowName);

          const requests = this.queues.processing.filter(
            (req) => cleanString(req.window_number) === targetKey
          );

          // 2. Get Modal Elements
          const modalTitle = document.getElementById("windowDetailsTitle");
          const modalList = document.getElementById("windowDetailsList");

          if (modalTitle)
            modalTitle.innerHTML = `<i class="bi bi-display me-2"></i> ${windowName} Status`;

          // 3. Populate Modal Content
          if (modalList) {
            if (requests.length === 0) {
              // Idle State
              modalList.innerHTML = `
                              <div class="text-center py-5 text-muted bg-white rounded shadow-sm">
                                  <i class="bi bi-cup-hot display-1 text-secondary opacity-25"></i>
                                  <h4 class="mt-3 fw-bold">Currently Idle</h4>
                                  <p class="mb-0">This window is ready to serve.</p>
                              </div>
                          `;
            } else {
              // Active Processing State
              modalList.innerHTML = requests
                .map((req) => {
                  const services = Array.isArray(req.services)
                    ? req.services
                    : [];
                  return `
                              <div class="card border-0 shadow-sm mb-3 animate__animated animate__fadeIn">
                                  <div class="card-body border-start border-5 border-primary rounded-start">
                                      <div class="d-flex justify-content-between align-items-start mb-2">
                                          <div>
                                              <h5 class="fw-bold mb-0 text-dark">${this.escapeHtml(
                                                req.user_name
                                              )}</h5>
                                              <small class="text-muted">Student ID: ${this.escapeHtml(
                                                req.student_id || "N/A"
                                              )}</small>
                                          </div>
                                          <span class="badge bg-primary rounded-pill px-3 py-2 fs-6">${this.escapeHtml(
                                            req.queue_number
                                          )}</span>
                                      </div>

                                      <div class="p-2 bg-light rounded mt-3">
                                          <div class="d-flex align-items-center text-secondary small mb-1">
                                              <i class="bi bi-gear-wide-connected me-2"></i> Service:
                                          </div>
                                          <div class="fw-semibold text-dark">${services.join(
                                            ", "
                                          )}</div>
                                      </div>

                                      <div class="d-flex justify-content-between align-items-center mt-3 pt-2 border-top">
                                          <small class="text-muted">
                                              <i class="bi bi-clock me-1"></i> Started: ${new Date(
                                                req.started_at
                                              ).toLocaleTimeString()}
                                          </small>
                                          <span class="badge bg-warning text-dark">In Progress</span>
                                      </div>
                                  </div>
                              </div>
                              `;
                })
                .join("");
            }
          }

          // 4. Show Modal
          const modalEl = document.getElementById("windowDetailsModal");
          if (modalEl) {
            const modal = new bootstrap.Modal(modalEl);
            modal.show();
          }
        }

        renderAllProcessing() {
          const container = document.getElementById("all-processing-list");
          const noRequestsMsg = document.getElementById("no-processing-msg");

          const processingRequests = this.queues.processing || [];

          if (processingRequests.length === 0) {
            container.innerHTML = "";
            if (noRequestsMsg) noRequestsMsg.style.display = "block";
            return;
          }

          if (noRequestsMsg) noRequestsMsg.style.display = "none";

          // Clean string helper
          const cleanString = (str) =>
            String(str || "")
              .replace(/[^a-zA-Z0-9]/g, "")
              .toLowerCase();

          container.innerHTML =
            `<div class="active-requests-container">` +
            processingRequests
              .map((request) => {
                const services = Array.isArray(request.services)
                  ? request.services
                  : [];
                const processingTime = this.getProcessingTime(
                  request.started_at
                );
                const winKey = cleanString(request.window_number);

                // Styling Classes
                let winClass = "win-grey";
                let badgeClass = "bg-secondary";

                if (winKey.includes("1")) {
                  winClass = "win-1";
                  badgeClass = "bg-primary";
                } else if (winKey.includes("2")) {
                  winClass = "win-2";
                  badgeClass = "bg-warning text-dark";
                } else if (winKey.includes("3")) {
                  winClass = "win-3";
                  badgeClass = "bg-info text-dark";
                } else if (winKey.includes("4")) {
                  winClass = "win-4";
                  badgeClass = "bg-danger";
                }

                return `
                      <div class="active-request-row ${winClass}">
                          <div class="req-queue-num">${this.escapeHtml(
                            request.queue_number
                          )}</div>

                          <div class="req-info">
                              <h6>${this.escapeHtml(request.user_name)}</h6>
                              <p>${services.join(", ").substring(0, 35)}${
                  services.join(", ").length > 35 ? "..." : ""
                }</p>
                          </div>

                          <div>
                              <span class="req-window-badge badge ${badgeClass}">${this.escapeHtml(
                  request.window_number
                )}</span>
                          </div>

                          <div class="req-time">
                              <i class="bi bi-stopwatch me-1"></i>${processingTime}
                          </div>
                      </div>
                    `;
              })
              .join("") +
            `</div>`;
        }

        // ---------------------------------------------------------
        // BLOCK 4: Render New Requests (Inside QueueManager)
        // ---------------------------------------------------------
        renderNewRequests() {
          const container = document.getElementById("requests-list");
          const noRequestsMsg = document.getElementById("no-requests-msg");
          if (!container || !noRequestsMsg) return;

          const newRequests = [
            ...(this.queues.priority || []),
            ...(this.queues.waiting || []),
          ];

          if (newRequests.length === 0) {
            container.innerHTML = "";
            noRequestsMsg.style.display = "block";
            return;
          }

          noRequestsMsg.style.display = "none";

          // üü¢ CHECK IF SUPER ADMIN üü¢
          const isSuperAdmin =
            currentStaff && currentStaff.role === "super_admin";

          container.innerHTML = newRequests
            .map((request) => {
              const services = Array.isArray(request.services)
                ? request.services
                : [];
              const isPriority = request.is_priority;
              const cardId = `req-${request.queue_id}`;

              // üü¢ DETERMINE BUTTON STYLE üü¢
              let actionButton = "";
              if (isSuperAdmin) {
                // Disabled button for Supervisor
                actionButton = `<button class="btn btn-sm btn-secondary" disabled style="opacity: 0.6; cursor: not-allowed;">
                                          <i class="bi bi-eye"></i> View Only
                                      </button>`;
              } else {
                // Normal button for Staff
                actionButton = `<button class="btn btn-sm btn-primary" onclick="queueManager.startProcessing('${request.queue_id}')">
                                          <i class="bi bi-person-check-fill me-1"></i> Serve Client
                                      </button>`;
              }

              return `
                  <div class="request-card ${
                    isPriority ? "priority-card" : ""
                  }" id="${cardId}">
                      <div class="card-info">
                          <span class="student-name">
                              ${this.escapeHtml(request.user_name)}
                              <small class="text-muted ms-2">(${this.escapeHtml(
                                request.queue_number
                              )})</small>
                              ${
                                isPriority
                                  ? '<span class="badge bg-danger ms-2">Priority</span>'
                                  : ""
                              }
                          </span>
                          <span class="text-secondary small me-2">
                              ${services.join(", ").substring(0, 30)}...
                          </span>
                      </div>
                      <div class="card-actions">
                          ${actionButton} <button class="btn btn-sm btn-secondary ms-2" onclick="queueManager.viewDetails('${
                request.queue_id
              }')">
                              Details
                          </button>
                      </div>
                  </div>
                  `;
            })
            .join("");
        }
        renderNowServing() {
          const myProcessingTicket = (this.queues.processing || []).find(
            (q) => q.window_number === currentWindow
          );

          const container = document.getElementById(
            "current-serving-container"
          ); // You need to update the HTML ID below too

          if (!currentWindow) {
            // Default "Select Window" state
            // (Keep your existing simple logic or update to new style if you prefer)
            return;
          }

          if (!myProcessingTicket) {
            // Idle State
            container.innerHTML = `
                      <div class="now-serving-card text-center py-4">
                          <div class="text-muted opacity-50 mb-2">
                              <i class="bi bi-cup-hot fs-1"></i>
                          </div>
                          <h4 class="text-secondary fw-bold">Window ${currentWindow} is Idle</h4>
                          <p class="text-muted small mb-0">Waiting for next client...</p>
                      </div>
                   `;
          } else {
            // Active State
            const services = Array.isArray(myProcessingTicket.services)
              ? myProcessingTicket.services
              : [];

            container.innerHTML = `
                      <div class="now-serving-card animate__animated animate__fadeIn">
                          <div class="now-serving-header">
                              <span class="serving-status-badge">
                                  <span class="spinner-grow spinner-grow-sm text-success" role="status"></span>
                                  Serving Now
                              </span>
                              <span class="badge bg-primary fs-6 px-3 py-2 rounded-pill">
                                  ${this.escapeHtml(
                                    myProcessingTicket.queue_number
                                  )}
                              </span>
                          </div>
                          <div class="serving-body">
                              <div class="serving-client-name">${this.escapeHtml(
                                myProcessingTicket.user_name
                              )}</div>
                              <div class="serving-meta">
                                  <span><i class="bi bi-person-badge"></i> ${this.escapeHtml(
                                    myProcessingTicket.student_id
                                  )}</span>
                                  <span><i class="bi bi-clock"></i> Started: ${new Date(
                                    myProcessingTicket.started_at
                                  ).toLocaleTimeString()}</span>
                              </div>
                              <div class="p-2 bg-light rounded border border-light">
                                  <small class="text-uppercase text-muted fw-bold" style="font-size: 0.7rem; letter-spacing: 0.5px;">Services</small>
                                  <div class="text-dark fw-medium mt-1">
                                      ${this.escapeHtml(services.join(", "))}
                                  </div>
                              </div>
                          </div>
                      </div>
                   `;
          }
        }

        renderProcessingQueue() {
          const container = document.getElementById("processingQueueContainer");
          const badge = document.getElementById("processingBadge");

          if (!container) return;

          const processingQueues = this.queues.processing || [];

          if (badge) {
            badge.textContent = processingQueues.length;
          }

          if (processingQueues.length === 0) {
            container.innerHTML = `
                          <div class="empty-state">
                              <div style="text-align: center; padding: 20px; color: #999;">
                                  No requests currently processing
                              </div>
                          </div>
                      `;
            return;
          }

          container.innerHTML = processingQueues
            .map((queue, index) => {
              const services = Array.isArray(queue.services)
                ? queue.services
                : [];
              const processingTime = this.getProcessingTime(queue.started_at);
              const isCurrent = index === 0;

              return `
                          <div class="queue-item ${
                            isCurrent ? "queue-item-processing" : ""
                          }" style="padding: 15px; border-bottom: 1px solid #eee; ${
                !isCurrent ? "opacity: 0.7;" : ""
              }">
                              <div class="queue-header" style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                  <div>
                                      <strong>${this.escapeHtml(
                                        queue.queue_number
                                      )}</strong>
                                      ${
                                        queue.is_priority
                                          ? '<span class="status-badge" style="background: #d32f2f; margin-left: 8px;">PRIORITY</span>'
                                          : ""
                                      }
                                      ${
                                        isCurrent
                                          ? '<span class="status-badge status-processing">CURRENT</span>'
                                          : '<span class="status-badge status-waiting">NEXT</span>'
                                      }
                                  </div>
                                  <div style="text-align: right;">
                                      <div style="font-size: 12px; color: #666;">${processingTime}</div>
                                  </div>
                              </div>
                              <div style="font-size: 14px; margin-bottom: 5px;">${this.escapeHtml(
                                queue.user_name
                              )}</div>
                              <div style="font-size: 12px; color: #666; margin-bottom: 8px;">
                                  ${services.slice(0, 2).join(", ")}${
                services.length > 2 ? ` +${services.length - 2} more` : ""
              }
                              </div>
                              <div class="action-buttons">
                                  ${
                                    !isCurrent
                                      ? `
                                      <button class="btn btn-sm btn-primary" onclick="queueManager.makeCurrent('${queue.queue_id}')">Make Current</button>
                                  `
                                      : ""
                                  }
                                  <button class="btn btn-sm btn-success" onclick="queueManager.markAsDone('${
                                    queue.queue_id
                                  }')">Complete</button>
                                  <button class="btn btn-sm btn-warning" onclick="queueManager.notifyStudent('${
                                    queue.queue_id
                                  }')">Notify</button>
                              </div>
                          </div>
                      `;
            })
            .join("");
        }

        getProcessingTime(startedAt) {
          if (!startedAt) return "0m";
          const start = new Date(startedAt);
          const now = new Date();
          const diff = Math.floor((now - start) / (1000 * 60)); // minutes
          return `${diff}m`;
        }

        getNextToServe() {
          if (this.queues.priority && this.queues.priority.length > 0) {
            const nextPriority = this.queues.priority[0];
            return `${nextPriority.queue_number} (Priority)`;
          }

          if (this.queues.waiting && this.queues.waiting.length > 0) {
            const nextRegular = this.queues.waiting[0];
            return `${nextRegular.queue_number} (Regular)`;
          }

          return "No pending requests";
        }

        // üü¢ UPDATED: Makes cards clickable and shows status üü¢
        updateQueueStats() {
          // 1. Calculate Sidebar Total
          const waitingCount = (this.queues.waiting || []).length;
          const processingCount = (this.queues.processing || []).length;
          const completedCount = (this.queues.completed || []).length;
          const priorityCount = (this.queues.priority || []).length;
          const totalCount =
            waitingCount + processingCount + completedCount + priorityCount;

          const sidebarTotalEl = document.getElementById("totalRequestsToday");
          if (sidebarTotalEl) sidebarTotalEl.textContent = totalCount;

          // 2. Determine Status
          const windowStatus = {
            window1: false,
            window2: false,
            window3: false,
            window4: false,
          };

          const cleanString = (str) =>
            String(str || "")
              .replace(/[^a-zA-Z0-9]/g, "")
              .toLowerCase();

          (this.queues.processing || []).forEach((ticket) => {
            const winKey = cleanString(ticket.window_number);
            if (windowStatus.hasOwnProperty(winKey)) {
              windowStatus[winKey] = true;
            }
          });

          // 3. Update Cards & Add Click Listeners
          const windows = [
            {
              key: "window1",
              id: "win1-count",
              colorClass: "text-primary",
              name: "Window 1",
            },
            {
              key: "window2",
              id: "win2-count",
              colorClass: "text-warning",
              name: "Window 2",
            },
            {
              key: "window3",
              id: "win3-count",
              colorClass: "text-info",
              name: "Window 3",
            },
            {
              key: "window4",
              id: "win4-count",
              colorClass: "text-danger",
              name: "Window 4",
            },
          ];

          windows.forEach((win) => {
            const isBusy = windowStatus[win.key];
            const element = document.getElementById(win.id);

            if (element) {
              // üü¢ Make the Card Clickable üü¢
              const card = element.closest(".card");
              if (card) {
                card.style.cursor = "pointer";
                card.style.transition = "transform 0.2s, box-shadow 0.2s";

                // Add hover effect via JS
                card.onmouseover = () => {
                  card.style.transform = "translateY(-5px)";
                  card.style.boxShadow = "0 10px 20px rgba(0,0,0,0.1)";
                };
                card.onmouseout = () => {
                  card.style.transform = "translateY(0)";
                  card.style.boxShadow = "none";
                };

                // Add Click Event
                card.onclick = () => this.showWindowDetails(win.name);
              }

              // Update Text Status
              if (isBusy) {
                element.textContent = "Processing";
                element.className = `fw-bold mb-0 ${win.colorClass}`;
                element.style.fontSize = "1.5rem";
              } else {
                element.textContent = "Idle";
                element.className = "fw-bold mb-0 text-muted";
                element.style.fontSize = "2rem";
              }
            }
          });
        }

        // New methods for enhanced functionality
        async makePriority(queueId) {
          if (!confirm("Make this request priority?")) return;

          try {
            const response = await makeAuthenticatedRequest(
              "/api/admin/make-priority",
              {
                method: "POST",
                body: JSON.stringify({ queueId }),
              }
            );

            const result = await response.json();
            if (result.success) {
              showNotification("Request moved to priority queue!");
              await this.loadQueues();
            } else {
              alert("Error: " + result.message);
            }
          } catch (error) {
            console.error("Error making priority:", error);
            alert("Error making priority. Please try again.");
          }
        }

        async makeCurrent(queueId) {
          try {
            const response = await makeAuthenticatedRequest(
              "/api/admin/make-current",
              {
                method: "POST",
                body: JSON.stringify({ queueId }),
              }
            );

            const result = await response.json();
            if (result.success) {
              showNotification("Request set as current!");
              await this.loadQueues();
            } else {
              alert("Error: " + result.message);
            }
          } catch (error) {
            console.error("Error making current:", error);
            alert("Error making current. Please try again.");
          }
        }

        async transferToStaff(queueId) {
          const staff = prompt("Enter staff name to transfer to:");
          if (staff) {
            showNotification(`Transferred to ${staff}`);
            // Implementation would go here
          }
        }

        async clearPriorityQueue() {
          if (
            !confirm(
              "Clear all priority requests? This will move them to regular queue."
            )
          )
            return;

          try {
            const response = await makeAuthenticatedRequest(
              "/api/admin/clear-priority",
              {
                method: "POST",
              }
            );

            const result = await response.json();
            if (result.success) {
              showNotification("Priority queue cleared!");
              await this.loadQueues();
            }
          } catch (error) {
            console.error("Error clearing priority:", error);
          }
        }

        async moveToRegular(queueId) {
          try {
            const response = await makeAuthenticatedRequest(
              "/api/admin/move-to-regular",
              {
                method: "POST",
                body: JSON.stringify({ queueId }),
              }
            );

            const result = await response.json();
            if (result.success) {
              showNotification("Moved to regular queue");
              await this.loadQueues();
            }
          } catch (error) {
            console.error("Error moving to regular:", error);
          }
        }

        viewDetails(queueId) {
          // Implementation for viewing queue details
          alert("View details for: " + queueId);
        }

        async startProcessing(queueId) {
          // 1. Check Window Assignment
          if (!currentWindow) {
            currentWindow = localStorage.getItem("assignedWindow");
            if (!currentWindow) {
              alert(
                "You must select a Window (1-4) before serving clients. Please refresh."
              );
              checkWindowAssignment();
              return;
            }
          }

          // üü¢ 2. OPTIMISTIC UPDATE: Remove the card IMMEDIATELY üü¢
          // This prevents double-clicking and makes the UI feel instant.
          const cardToRemove = document.getElementById(`req-${queueId}`);
          if (cardToRemove) {
            // Visual fade out
            cardToRemove.style.transition = "all 0.3s ease";
            cardToRemove.style.opacity = "0";
            cardToRemove.style.transform = "translateX(20px)";

            // Remove from HTML after animation
            setTimeout(() => {
              if (cardToRemove.parentNode) cardToRemove.remove();
            }, 300);
          }

          try {
            // 3. Call Backend
            const response = await makeAuthenticatedRequest(
              "/api/admin/start-processing",
              {
                method: "POST",
                body: JSON.stringify({
                  queueId: queueId,
                  windowNumber: currentWindow,
                }),
              }
            );

            const result = await response.json();

            if (result.success) {
              showNotification(`Success! Now Serving at ${currentWindow}`);
              await this.loadQueues();
              this.renderNowServing();
            } else {
              // üü¢ FIX: Handle "Already Taken" gracefully üü¢
              console.warn("Server response:", result.message);

              // Refresh the list to remove the ghost card
              await this.loadQueues();
              this.renderQueueDashboard();

              // Show a nice warning so the user knows why it disappeared
              if (result.message.toLowerCase().includes("already")) {
                showNotification(
                  "This request was just taken by another window.",
                  "warning"
                );
              } else {
                alert("System Update: " + result.message);
              }
            }
          } catch (error) {
            console.error("Error starting processing:", error);
            // If network fails, put the card back by refreshing
            await this.loadQueues();
            this.renderQueueDashboard();
            alert("Connection error. Please try again.");
          }
        }

        async notifyStudent(queueId) {
          try {
            const response = await makeAuthenticatedRequest(
              "/api/admin/notify-student",
              {
                method: "POST",
                body: JSON.stringify({ queueId }),
              }
            );

            const result = await response.json();
            if (result.success) {
              showNotification("Student notified successfully!");
              // Update UI to show notified status
              this.updateNotificationStatus(queueId);
            } else {
              alert("Error: " + result.message);
            }
          } catch (error) {
            console.error("Error notifying student:", error);
            alert("Error notifying student. Please try again.");
          }
        }

        async markAsDone(queueId) {
          if (!confirm("Mark this request as completed?")) return;

          try {
            const response = await makeAuthenticatedRequest(
              "/api/admin/mark-done",
              {
                method: "POST",
                body: JSON.stringify({ queueId }),
              }
            );

            const result = await response.json();
            if (result.success) {
              showNotification("Request completed successfully!");

              // 1. Refresh Queue Data (Moves item from 'Processing' to 'Completed')
              await this.loadQueues();

              // ------------------------------------------------------------
              // üü¢ CRITICAL FIX: Refresh Service Request Page UI üü¢
              // ------------------------------------------------------------
              if (typeof serviceRequestManager !== "undefined") {
                // This removes the card from the "Now Serving" list in the Service Request tab
                serviceRequestManager.renderRequests();
                // This updates the "History" list immediately
                serviceRequestManager.updateStats();
              }
              // ------------------------------------------------------------
            } else {
              alert("Error: " + result.message);
            }
          } catch (error) {
            console.error("Error marking as done:", error);
            alert("Error completing request. Please try again.");
          }
        }

        async processNextInQueue() {
          const nextQueue =
            this.queues.priority && this.queues.priority.length > 0
              ? this.queues.priority[0]
              : this.queues.waiting && this.queues.waiting.length > 0
              ? this.queues.waiting[0]
              : null;

          if (!nextQueue) {
            alert("No requests in queue to process.");
            return;
          }

          await this.startProcessing(nextQueue.queue_id);
        }

        updateNotificationStatus(queueId) {
          // Update UI to show that student was notified
          const elements = document.querySelectorAll(`[onclick*="${queueId}"]`);
          elements.forEach((element) => {
            const btn = element
              .closest(".action-buttons")
              ?.querySelector('[onclick*="notifyStudent"]');
            if (btn) {
              btn.innerHTML = "‚úÖ Notified";
              btn.disabled = true;
              btn.classList.remove("btn-primary");
              btn.classList.add("btn-success");
            }
          });
        }

        escapeHtml(unsafe) {
          if (unsafe === null || unsafe === undefined) return "";
          return String(unsafe)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
        }

        showEmptyQueueState() {
          const stats = [
            "waitingCount",
            "processingCount",
            "completedCount",
            "priorityCount",
          ];
          stats.forEach((stat) => {
            const element = document.getElementById(stat);
            if (element) element.textContent = "0";
          });
        }

        // üü¢ UPDATED: Handles assigning a new request to a specific window
        async startProcessingFromList(queueId, windowNumber) {
          if (
            !confirm(`Start serving this client and assign to ${windowNumber}?`)
          )
            return;

          // Optional Check: Is the *target* window already serving someone? (This logic is usually handled better server-side, but client-side is faster for UX)
          // If the current admin's window is the target window, let them decide if they want to override the current request.
          // For simplicity, we'll allow assigning, and the backend's sorting will determine who is truly "Now Serving".

          try {
            const response = await makeAuthenticatedRequest(
              "/api/admin/start-processing",
              {
                method: "POST",
                body: JSON.stringify({
                  queueId: queueId,
                  windowNumber: windowNumber,
                }),
              }
            );

            const result = await response.json();
            if (result.success) {
              showNotification(`Processing started at ${windowNumber}!`);
              await this.loadQueues(); // Refresh all lists

              // üü¢ CRITICAL FIX: Explicitly check and update Now Serving if the target window is *this* admin's window.
              if (currentWindow === windowNumber) {
                this.renderNowServing();
              }
            } else {
              alert("Error: " + result.message);
            }
          } catch (error) {
            alert("Error starting processing. Please try again.");
          }
        }
      }

      // Manual Queue Entry Function
      async function addManualQueue() {
        const name = document.getElementById("manualName").value;
        const studentId = document.getElementById("manualStudentId").value;
        const service = document.getElementById("manualService").value;
        const isPriority =
          document.getElementById("manualPriority").value === "true";

        if (!name) {
          alert("Please enter a name");
          return;
        }

        // Show additional details modal
        document.getElementById("manualNameDisplay").textContent = name;
        document.getElementById("manualStudentIdDisplay").textContent =
          studentId || "N/A";
        document.getElementById("manualServiceDisplay").textContent = service;
        document.getElementById("manualPriorityDisplay").textContent =
          isPriority ? "Yes" : "No";

        toggleModal("manualTransactionModal");
      }

      async function confirmManualQueue() {
        const name = document.getElementById("manualName").value;
        const studentId = document.getElementById("manualStudentId").value;
        const service = document.getElementById("manualService").value;
        const isPriority =
          document.getElementById("manualPriority").value === "true";
        const transactionType =
          document.getElementById("transactionType").value;
        const notes = document.getElementById("transactionNotes").value;

        try {
          const response = await makeAuthenticatedRequest(
            "/api/admin/add-manual-queue",
            {
              method: "POST",
              body: JSON.stringify({
                name,
                studentId,
                service,
                isPriority,
                transactionType,
                notes,
              }),
            }
          );

          const result = await response.json();

          if (result.success) {
            showNotification(`Manual queue entry added: ${result.queueNumber}`);
            toggleModal("manualTransactionModal");

            // Clear form
            document.getElementById("manualName").value = "";
            document.getElementById("manualStudentId").value = "";
            document.getElementById("transactionNotes").value = "";

            // Refresh queues
            queueManager.loadQueues();
          } else {
            alert("Error: " + result.message);
          }
        } catch (error) {
          console.error("Error adding manual queue:", error);
          alert("Error adding to queue. Please try again.");
        }
      }

      // Enhanced auto-refresh with error handling
      function setupEnhancedAutoRefresh() {
        // üü¢ FIX: Change 5000 (5s) to 1500 (1.5s) üü¢
        // This makes the request disappear from other windows almost instantly.
        setInterval(() => {
          if (!isQueuePaused) {
            queueManager.loadQueues();
          }
        }, 1500);

        // Refresh service requests every 15 seconds (was 30s)
        setInterval(() => {
          serviceRequestManager.loadServiceRequests();
        }, 15000);
      }
      /**
       * Populates the 'Queue Report History' list on the Reports page.
       * For now, it just checks for today's completed requests.
       */
      function renderReportHistory(queues) {
        const container = document.getElementById(
          "queueReportHistoryContainer"
        );
        if (!container) return;

        const completedRequests = queues.completed || [];

        if (completedRequests.length > 0) {
          // Format today's date
          const today = new Date();
          const day = today.toLocaleDateString("en-US", { weekday: "long" });
          const date = today.toLocaleDateString("en-US", {
            year: "numeric",
            month: "long",
            day: "numeric",
          });

          container.innerHTML = `
                <h2 class="history-title">Queue Report History</h2>
                <div class="history-item" onclick="showReportDetail('today')">
                  <span class="history-day">Today's Report</span>
                  <span class="history-date">${day}, ${date}</span>
                </div>
                `;
        } else {
          container.innerHTML = `
                <h2 class="history-title">Queue Report History</h2>
                <div class="history-item empty" style="text-align: center; color: #999; padding: 20px 0;">
                  No completed requests for today.
                </div>
              `;
        }
      }

      /**
       * Populates the Report Detail page with data from 'today' (queueManager.queues.completed)
       */
      function populateTodayReportDetail() {
        const completedRequests = queueManager.queues.completed || [];

        // --- 1. Set Date and Total ---
        const today = new Date();
        const day = today.toLocaleDateString("en-US", { weekday: "long" });
        const date = today.toLocaleDateString("en-US", {
          year: "numeric",
          month: "long",
          day: "numeric",
        });

        const dateEl = document.getElementById("reportDetailDate");
        const totalEl = document.getElementById("reportDetailTotal");

        if (dateEl) dateEl.innerHTML = `Today: ${day} <br/> ${date}`;
        if (totalEl) totalEl.textContent = completedRequests.length;

        // --- 2. Group services and create summary ---
        const serviceSummary = new Map();
        const requestsByService = new Map();

        // Utility to prevent XSS (HTML injection)
        const escape = (str) => {
          if (str === null || str === undefined) return "";
          return String(str)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");
        };

        completedRequests.forEach((req) => {
          let services = [];
          try {
            if (
              typeof req.services === "string" &&
              req.services.startsWith("[")
            ) {
              services = JSON.parse(req.services);
            } else if (Array.isArray(req.services)) {
              services = req.services;
            } else if (req.services) {
              services = [String(req.services)]; // Handle as single string
            }
          } catch (e) {
            console.warn("Could not parse services:", req.services);
          }

          if (services.length === 0) {
            services = ["Other"]; // Fallback
          }

          services.forEach((serviceName) => {
            const cleanServiceName = escape(serviceName);
            // Add to summary count
            serviceSummary.set(
              cleanServiceName,
              (serviceSummary.get(cleanServiceName) || 0) + 1
            );

            // Add request to service group
            if (!requestsByService.has(cleanServiceName)) {
              requestsByService.set(cleanServiceName, []);
            }
            requestsByService.get(cleanServiceName).push(req);
          });
        });

        // --- 3. Populate Service Grid ---
        const gridContainer = document.getElementById(
          "reportDetailServiceGrid"
        );
        let gridHtml = "<div>"; // Start first column
        let count = 0;
        serviceSummary.forEach((count, serviceName) => {
          gridHtml += `
                <div class="service-item">
                  <span class="service-name">${serviceName}:</span>
                  <span class="service-count">${count}</span>
                </div>
              `;
          count++;
          // Split into two columns
          if (count % 5 === 0 && count < serviceSummary.size) {
            gridHtml += "</div><div>";
          }
        });
        gridHtml += "</div>";

        if (gridContainer) {
          gridContainer.innerHTML =
            serviceSummary.size > 0
              ? gridHtml
              : '<div style="color: #999; font-size: 14px;">No services recorded.</div>';
        }

        // --- 4. Populate Data Table ---
        const tableContainer = document.getElementById("reportDetailDataTable");
        let tableHtml = "";

        requestsByService.forEach((requests, serviceName) => {
          tableHtml += `
                <div class="table-section">
                  <div class="table-header-title">${serviceName}</div>
                  <div class="table-row header-row">
                    <div class="table-cell header">Name</div>
                    <div class="table-cell header">Year/Course</div>
                    <div class="table-cell header">Student ID</div>
                  </div>
              `;

          requests.forEach((req) => {
            tableHtml += `
                  <div class="table-row">
                    <div class="table-cell">${escape(req.user_name)}</div>
                    <div class="table-cell">${escape(
                      req.course || "N/A"
                    )} - ${escape(req.year_level || "N/A")}</div>
                    <div class="table-cell">${escape(
                      req.student_id || "N/A"
                    )}</div>
                  </div>
                `;
          });

          tableHtml += "</div>"; // End table-section
        });

        if (tableContainer) {
          tableContainer.innerHTML =
            requestsByService.size > 0
              ? tableHtml
              : `
                <div style="text-align: center; color: #999; padding: 30px 0;">
                  No detailed request data to display.
                </div>
              `;
        }
      }
      // ‚¨ÜÔ∏è END OF NEW FUNCTIONS ‚¨ÜÔ∏è
      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Theme toggle (only on Settings page) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      document.addEventListener("DOMContentLoaded", () => {
        const body = document.body;
        const darkSwitch = document.getElementById("darkModeSwitch");

        // Load saved preference
        if (localStorage.getItem("theme") === "dark") {
          body.classList.add("dark-theme");
          if (darkSwitch) darkSwitch.checked = true;
        }

        // Toggle handler
        if (darkSwitch) {
          darkSwitch.addEventListener("change", () => {
            if (darkSwitch.checked) {
              body.classList.add("dark-theme");
              localStorage.setItem("theme", "dark");
            } else {
              body.classList.remove("dark-theme");
              localStorage.setItem("theme", "light");
            }
          });
        }
      });
      // Apply dark-theme only once ‚Äì no inline !important overrides
      document.addEventListener("DOMContentLoaded", () => {
        if (localStorage.getItem("theme") === "dark") {
          document.body.classList.add("dark-theme");
          const sw = document.getElementById("darkModeSwitch");
          if (sw) sw.checked = true;
        }
      });
      // ==========================================
      // WINDOW ASSIGNMENT LOGIC (PERSISTENCE)
      // ==========================================
      let activeWindows = []; // Cache of windows currently in use

      async function checkWindowAssignment() {
        const currentWindowDisplay = document.getElementById(
          "currentWindowDisplay"
        );
        let savedWindow = localStorage.getItem("assignedWindow");

        // üü¢ 1. SUPER ADMIN BYPASS üü¢
        if (
          (currentStaff && currentStaff.role === "super_admin") ||
          savedWindow === "Supervisor"
        ) {
          console.log("Super Admin: Skipping window selection modal.");
          if (winDisplay) winDisplay.textContent = "Supervisor";
          return;
        }

        // üü¢ 2. AUTO RE-LOCK (Handles Refresh Logic) üü¢
        // If we have a saved window, we must tell the server "I'm still here!"
        // because the 'pagehide' event might have just unlocked it during the refresh.
        if (savedWindow && savedWindow !== "Supervisor") {
          currentWindow = savedWindow;

          // SILENTLY RE-ASSIGN ON SERVER
          makeAuthenticatedRequest("/api/admin/assign-window", {
            method: "POST",
            body: JSON.stringify({ windowNumber: savedWindow }),
          }).catch((err) => console.warn("Background re-lock failed", err));

          // Update UI
          updateUIWithWindow(currentWindow);
          if (queueManager) queueManager.loadQueues();
          return; // Stop here, don't show modal
        }

        if (currentWindowDisplay) currentWindowDisplay.textContent = "N/A";

        // 3. Fetch active windows and show modal (Normal Login Flow)
        try {
          const response = await makeAuthenticatedRequest(
            "/api/admin/active-windows"
          );
          const data = await response.json();
          if (data.success) {
            activeWindows = data.activeWindows;
          }
        } catch (error) {
          console.error("Failed to fetch active windows:", error);
        }

        // Show the modal
        const modalElement = document.getElementById("windowSelectionModal");
        if (modalElement) {
          renderWindowButtons(modalElement);
          windowSelectionModalObj = new bootstrap.Modal(modalElement, {
            backdrop: "static",
            keyboard: false,
          });
          windowSelectionModalObj.show();
        }
      }

      // The rest of your assignment functions (renderWindowButtons and selectWindow)
      // are still required and remain unchanged from the previous steps.

      function renderWindowButtons(modalElement) {
        const windows = ["Window 1", "Window 2", "Window 3", "Window 4"];
        const modalBody = modalElement.querySelector(".modal-body .d-grid");

        if (!modalBody) return;
        modalBody.innerHTML = "";

        windows.forEach((windowName) => {
          const isLocked = activeWindows.includes(windowName);
          const isDisabled = isLocked ? "disabled" : "";
          const lockIcon = isLocked
            ? '<i class="bi bi-lock-fill ms-auto text-danger"></i>'
            : "";

          // üü¢ FIX 2: Pass 'event' to the function call üü¢
          modalBody.innerHTML += `
                      <button
                          type="button"
                          class="btn btn-outline-primary p-3 text-start fw-semibold position-relative"
                          onclick="${
                            isLocked
                              ? ""
                              : `selectWindow('${windowName}', event)`
                          }"
                          ${isDisabled}
                      >
                          <i class="bi bi-display me-3 fs-5"></i> ${windowName}
                          ${lockIcon}
                      </button>
                  `;
        });
      }

      window.selectWindow = async function (windowName, event) {
        // 1. Stop the default immediate form refresh (we need to save data first!)
        if (event) {
          event.preventDefault();
          event.stopPropagation();
        }

        try {
          // 2. Lock the window on the server
          const response = await makeAuthenticatedRequest(
            "/api/admin/assign-window",
            {
              method: "POST",
              body: JSON.stringify({ windowNumber: windowName }),
            }
          );
          const data = await response.json();

          if (!data.success) {
            alert(`Assignment failed: ${data.message}. Refreshing list.`);
            checkWindowAssignment();
            return;
          }

          // 3. Save state to Local Storage
          localStorage.setItem("assignedWindow", windowName);
          currentWindow = windowName;

          // 4. üü¢ SHOW LOADING SCREEN IN MODAL üü¢
          const modalBody = document.querySelector(
            "#windowSelectionModal .modal-body"
          );
          if (modalBody) {
            modalBody.innerHTML = `
                      <div class="text-center py-5">
                          <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
                              <span class="visually-hidden">Loading...</span>
                          </div>
                          <h4 class="fw-bold text-dark">Setting up ${windowName}...</h4>
                          <p class="text-muted">The page will reload to apply settings.</p>
                      </div>
                    `;
          }

          // 5. üü¢ FORCE RELOAD AFTER 1 SECOND üü¢
          // This guarantees the dashboard loads fresh with the buttons visible.
          setTimeout(() => {
            window.location.reload();
          }, 1000);
        } catch (error) {
          console.error("Error assigning window:", error);
          alert("Network error. Please try again.");
        }
      };

      function updateUIWithWindow(windowName) {
        const currentWindowDisplay = document.getElementById(
          "currentWindowDisplay"
        );
        if (currentWindowDisplay) currentWindowDisplay.textContent = windowName;

        const sidebarTitle = document.querySelector(".sidebar-title");
        if (sidebarTitle) {
          // Simple update for sidebar title
          sidebarTitle.innerHTML = `Registrar Staff <br><small style="font-size: 12px; color: #aab0bc;">${windowName}</small>`;
        }
      }

      // Hook into existing initialization
      document.addEventListener("DOMContentLoaded", function () {
        // checkWindowAssignment();
      });

      // Correct Logout Function
      window.handleLogout = function () {
        if (confirm("Are you sure you want to log out?")) {
          showNotification("Logging out...");

          // 1. Ensure we have the window value to send to server
          if (!currentWindow) {
            currentWindow = localStorage.getItem("assignedWindow");
          }

          // 2. Call server to UNLOCK the window in the database
          unassignWindowOnServer()
            .then(() => {
              // 3. Clear local storage and redirect
              localStorage.removeItem("assignedWindow");
              adminLogout();
            })
            .catch((err) => {
              // Even if server fails, log out anyway
              console.error("Unassign failed", err);
              localStorage.removeItem("assignedWindow");
              adminLogout();
            });
        }
      };

      // Function to toggle password visibility
      function toggleRegPassword(inputId, iconSpan) {
        const input = document.getElementById(inputId);
        const icon = iconSpan.querySelector("i");

        if (input.type === "password") {
          input.type = "text";
          icon.classList.remove("bi-eye");
          icon.classList.add("bi-eye-slash");
        } else {
          input.type = "password";
          icon.classList.remove("bi-eye-slash");
          icon.classList.add("bi-eye");
        }
      }
      // üü¢ ROBUST TAB CLOSE HANDLER üü¢
      // Uses sendBeacon with a Blob to bypass header restrictions
      window.addEventListener("pagehide", function () {
        if (adminToken) {
          const payload = JSON.stringify({ token: adminToken });
          const blob = new Blob([payload], { type: "application/json" });

          // Send signal to the new specific endpoint
          navigator.sendBeacon("/api/admin/beacon-unlock", blob);
        }
      });
    </script>
  </body>
</html>
