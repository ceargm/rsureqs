<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Queue Management Dashboard</title>
  <link rel="stylesheet" href="assets/css/admindashb.css" />
  <style>
    /* Fallback styles in case CSS fails to load */
    .notification-toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #2e7d32;
      color: white;
      padding: 15px 25px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      z-index: 10000;
    }

    @keyframes slideInRight {
      from {
        transform: translateX(400px);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }

      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
    }

    .modal.active {
      display: block;
    }

    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      border-radius: 8px;
      width: 80%;
      max-width: 600px;
    }

    /* Additional fallback styles */
    .btn {
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }

    .btn-primary {
      background: #007bff;
      color: white;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
    }

    /* Enhanced styles for real-time updates */
    .queue-item-processing {
      border-left: 4px solid #ff9800;
      background-color: #fff3e0;
    }

    .queue-item-notified {
      border-left: 4px solid #2196f3;
      background-color: #e3f2fd;
    }

    .queue-item-completed {
      border-left: 4px solid #4caf50;
      background-color: #e8f5e8;
    }

    .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
    }

    .status-processing {
      background: #ff9800;
      color: white;
    }

    .status-notified {
      background: #2196f3;
      color: white;
    }

    .status-completed {
      background: #4caf50;
      color: white;
    }

    .status-waiting {
      background: #9e9e9e;
      color: white;
    }

    .action-buttons {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }

    .btn-sm {
      padding: 4px 8px;
      font-size: 12px;
    }

    /* Manual entry styles */
    .manual-entry-form {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .form-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .form-group {
      flex: 1;
      min-width: 200px;
    }

    .form-input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    .quick-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
    }

    .stat-item {
      background: white;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .stat-number {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    /* Scrollable Priority Queue */
    .priority-queue-list {
      max-height: 300px;
      /* Fits approximately 2 items; scrolls for more */
      overflow-y: auto;
      padding-right: 8px;
    }

    /* Custom scrollbar for Priority Queue */
    .priority-queue-list::-webkit-scrollbar {
      width: 6px;
    }

    .priority-queue-list::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }

    .priority-queue-list::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 10px;
    }

    .priority-queue-list::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }

    .stat-label {
      font-size: 12px;
      color: #666;
    }

    /* Scrollable Regular Queue */
    #regularQueueContainer .card-body {
      max-height: 400px;
      overflow-y: auto;
      padding-right: 8px;
    }

    /* Scrollable Currently Processing */
    #processingQueueContainer {
      max-height: 400px;
      overflow-y: auto;
      padding-right: 8px;
    }

    /* Optional: Custom scrollbar (nice touch) */
    #regularQueueContainer .card-body::-webkit-scrollbar,
    #processingQueueContainer::-webkit-scrollbar {
      width: 6px;
    }

    #regularQueueContainer .card-body::-webkit-scrollbar-track,
    #processingQueueContainer::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }

    #regularQueueContainer .card-body::-webkit-scrollbar-thumb,
    #processingQueueContainer::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 10px;
    }

    #regularQueueContainer .card-body::-webkit-scrollbar-thumb:hover,
    #processingQueueContainer::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }

    /* Scrollable Priority & Regular Queue - Show scroll after 2 items */
    .priority-queue-list,
    .regular-queue-list {
      max-height: 240px;
      /* ~2 items visible */
      overflow-y: auto;
      padding-right: 8px;
    }

    /* Custom scrollbar */
    .priority-queue-list::-webkit-scrollbar,
    .regular-queue-list::-webkit-scrollbar {
      width: 6px;
    }

    .priority-queue-list::-webkit-scrollbar-track,
    .regular-queue-list::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }

    .priority-queue-list::-webkit-scrollbar-thumb,
    .regular-queue-list::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 10px;
    }

    .priority-queue-list::-webkit-scrollbar-thumb:hover,
    .regular-queue-list::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }
  </style>
</head>

<body>
  <div class="sidebar">
    <div class="sidebar-header">
      <img src="/assets/img/logo.jpg" width="50" height="50" alt="Office of the University Registrar"
        onerror="this.style.display='none'" />
      <div class="sidebar-title">Registrar Staff</div>
    </div>

    <div class="menu-item active" data-page="queue">
      <svg class="menu-icon" fill="currentColor" viewBox="0 0 20 20">
        <path
          d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z" />
      </svg>
      <span>Queue Management</span>
    </div>

    <div class="menu-item" data-page="documents">
      <svg class="menu-icon" fill="currentColor" viewBox="0 0 20 20">
        <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" />
        <path fill-rule="evenodd"
          d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z"
          clip-rule="evenodd" />
      </svg>
      <span>Service Requests</span>
    </div>

    <div class="menu-item" data-page="reports">
      <svg class="menu-icon" fill="currentColor" viewBox="0 0 20 20">
        <path
          d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z" />
      </svg>
      <span>Reports</span>
    </div>

    <div class="menu-item" data-page="settings">
      <svg class="menu-icon" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd"
          d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z"
          clip-rule="evenodd" />
      </svg>
      <span>Settings</span>
    </div>

    <div class="request-card">
      <div class="request-number" id="totalRequestsToday">0</div>
      <div class="request-label">Request Today</div>
    </div>

    <div class="user-card">
      <div class="user-avatar"></div>
      <div class="user-info">
        <h4>Jila Santos</h4>
        <p>Registrar Staff</p>
      </div>
    </div>
  </div>

  <div class="main-content">
    <!-- Queue Management Page -->
    <div id="queue-page" class="page active">
      <div class="header">
        <h1>Queue Management Dashboard</h1>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-number blue" id="waitingCount">0</div>
            <div class="stat-label">Waiting</div>
          </div>
          <div class="stat-card">
            <div class="stat-number orange" id="processingCount">0</div>
            <div class="stat-label">Processing</div>
          </div>
          <div class="stat-card">
            <div class="stat-number green" id="readyCount">0</div>
            <div class="stat-label">Ready</div>
          </div>
          <div class="stat-card">
            <div class="stat-number purple" id="completedCount">0</div>
            <div class="stat-label">Completed</div>
          </div>
          <div class="stat-card priority">
            <div class="stat-number red" id="priorityCount">0</div>
            <div class="stat-label">Priority Queue</div>
          </div>
        </div>
      </div>

      <div class="content-grid">
        <div>
          <!-- ==================== MANUAL QUEUE ENTRY (CLEAN UI) ==================== -->
          <div class="card mb-3 border-0 shadow-sm">
            <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center py-3">
              <span class="card-title">Manual Queue Entry</span>
              <button class="btn btn-sm btn-outline-secondary border-0" type="button" data-bs-toggle="collapse"
                data-bs-target="#manualEntryCollapse">
                <small>Toggle</small>
              </button>
            </div>

            <div class="collapse show" id="manualEntryCollapse">
              <div class="card-body p-4">
                <form id="manualQueueForm" class="row g-3 needs-validation" novalidate>
                  <!-- Full Name -->
                  <div class="col-md-6">
                    <label class="form-label text-secondary fw-medium">Full Name</label>
                    <input type="text" class="form-control form-control-sm" id="manualName"
                      placeholder="Enter full name" required />
                  </div>

                  <!-- Student ID -->
                  <div class="col-md-6">
                    <label class="form-label text-secondary fw-medium">Student ID</label>
                    <input type="text" class="form-control form-control-sm" id="manualStudentId"
                      placeholder="e.g. 2022-0001-001" required />
                  </div>

                  <!-- Course -->
                  <div class="col-md-4">
                    <label class="form-label text-secondary fw-medium">Course</label>
                    <input type="text" class="form-control form-control-sm" id="manualCourse" placeholder="e.g. BSIT"
                      required />
                  </div>

                  <!-- Year Level -->
                  <div class="col-md-4">
                    <label class="form-label text-secondary fw-medium">Year Level</label>
                    <select class="form-select form-select-sm" id="manualYearLevel" required>
                      <option value="" disabled selected>Select</option>
                      <option>1st Year</option>
                      <option>2nd Year</option>
                      <option>3rd Year</option>
                      <option>4th Year</option>
                    </select>
                  </div>

                  <!-- Service -->
                  <div class="col-md-4">
                    <label class="form-label text-secondary fw-medium">Service</label>
                    <select class="form-select form-select-sm" id="manualService" required>
                      <option value="" disabled selected>
                        Select Service
                      </option>
                      <option value='["Transcript of Records"]'>
                        Transcript of Records
                      </option>
                      <option value='["Certificate of Enrollment"]'>
                        Certificate of Enrollment
                      </option>
                      <option value='["Good Moral Character"]'>
                        Good Moral Character
                      </option>
                      <option value='["Diploma"]'>Diploma</option>
                    </select>
                  </div>

                  <!-- Submit Button -->
                  <div class="col-12 mt-3">
                    <button type="submit" class="btn btn-primary btn-sm w-100 fw-medium shadow-sm">
                      Add to Queue
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
          <!-- =========================================================================== -->

          <div class="card" id="currentRequestCard">
            <!-- Current request will be loaded dynamically -->
          </div>

          <div class="quick-actions">
            <h3>Quick Actions</h3>
            <button class="action-btn" onclick="queueManager.processNextInQueue()">
              ➡️ Process Next
            </button>
            <button class="action-btn" onclick="serviceRequestManager.loadServiceRequests()">
              🔄 Refresh
            </button>
            <button class="action-btn" id="pauseQueueBtn" onclick="toggleQueuePause()">
              ⏸️ Pause Queue
            </button>
          </div>
        </div>

        <div>
          <div class="priority-card" id="priorityQueueContainer">
            <!-- Priority queue will be loaded dynamically -->
          </div>

          <div class="card">
            <div class="card-header">
              <span class="card-title">Regular Queue</span>
              <span class="badge waiting">0 waiting</span>
            </div>
            <div class="card-body" style="padding: 0">
              <div id="regularQueueContainer" style="padding: 0">
                <!-- Items loaded here -->
              </div>
            </div>
          </div>
          <div class="card">
            <div class="card-header">
              <span class="card-title">🔄 Currently Processing</span>
              <span class="badge" id="processingBadge">0 processing</span>
            </div>
            <div id="processingQueueContainer" style="padding: 0 20px">
              <!-- Currently processing queues will be loaded here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Service Request Page -->
    <div id="documents-page" class="page">
      <div class="header">
        <h1>Service Request Management</h1>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-number blue" id="pendingCount">0</div>
            <div class="stat-label">Pending</div>
          </div>
          <div class="stat-card">
            <div class="stat-number orange" id="approvedCount">0</div>
            <div class="stat-label">Approved</div>
          </div>
          <div class="stat-card">
            <div class="stat-number green" id="declinedCount">0</div>
            <div class="stat-label">Declined</div>
          </div>
        </div>
      </div>

      <div class="document-section">
        <h2 class="section-title">Pending Service Requests</h2>
        <div id="pendingRequestsContainer">
          <!-- Pending requests will be loaded here dynamically -->
        </div>
      </div>

      <div class="document-section">
        <h2 class="section-title">Approved Requests</h2>
        <div id="approvedRequestsContainer">
          <!-- Approved requests will be loaded here -->
        </div>
      </div>

      <div class="document-section">
        <h2 class="section-title">Declined Requests</h2>
        <div id="declinedRequestsContainer">
          <!-- Declined requests will be loaded here -->
        </div>
      </div>
    </div>

    <!-- Reports Page -->
    <div id="reports-page" class="page">
      <div class="header">
        <h1>Analytics Dashboard</h1>
      </div>

      <div class="analytics-grid">
        <div class="summary-card">
          <div class="summary-number" id="totalRequestsSummary">0</div>
          <div class="summary-label">Total Today's Request</div>
        </div>
        <div class="summary-card">
          <div class="summary-number" id="completedSummary">0</div>
          <div class="summary-label">Completed Today</div>
        </div>
      </div>

      <div class="charts-grid">
        <div class="info-card">
          <h3>
            Peak Hours Statistic <span style="color: #999">(Today)</span>
          </h3>
          <div class="chart-placeholder">Chart Placeholder - Peak Hours</div>
        </div>

        <div class="info-card">
          <h3>
            Recent Client Requests <span style="color: #999">(Today)</span>
          </h3>
          <ul class="request-list" id="recentRequestsList">
            <!-- Recent requests will be populated here -->
          </ul>
        </div>
      </div>

      <div class="history-table">
        <h2 class="history-title">Queue Report History</h2>
        <div class="history-item" onclick="showReportDetail()">
          <span class="history-day">Today: Monday 8am-4pm</span>
          <span class="history-date">August 8, 2025</span>
        </div>
        <div class="history-item" onclick="showReportDetail()">
          <span class="history-day">Friday 8am-4pm</span>
          <span class="history-date">August 5, 2025</span>
        </div>
        <div class="history-item" onclick="showReportDetail()">
          <span class="history-day">Thursday 8am-4pm</span>
          <span class="history-date">August 4, 2025</span>
        </div>
      </div>
    </div>

    <!-- Detail Report Page -->
    <div id="report-detail-page" class="page">
      <div class="header">
        <h1>Queue Report Details</h1>
        <button class="btn btn-secondary" onclick="showPage('reports')">
          ← Back to Reports
        </button>
      </div>

      <div class="report-header">
        <h2 class="report-title">Queue Report History</h2>
        <div class="report-date">Friday 8am-4pm<br />August 5, 2025</div>

        <div class="service-summary">
          <h3 class="summary-title">Overall Service Requested</h3>
          <div class="summary-grid">
            <div>
              <div class="service-item">
                <span class="service-name">Transcript of Grades:</span>
                <span class="service-count">2</span>
              </div>
              <div class="service-item">
                <span class="service-name">Certification of Grade Form:</span>
                <span class="service-count">7</span>
              </div>
              <div class="service-item">
                <span class="service-name">Adding/Dropping Subjects:</span>
                <span class="service-count">3</span>
              </div>
            </div>
            <div>
              <div class="service-item">
                <span class="service-name">Signature Related Services:</span>
                <span class="service-count">26</span>
              </div>
              <div class="service-item">
                <span class="service-name">Grade Slip:</span>
                <span class="service-count">11</span>
              </div>
            </div>
          </div>

          <div class="total-requests">
            <div class="total-label">Total Requests</div>
            <div class="total-number">52</div>
          </div>
        </div>
      </div>

      <div class="data-table">
        <div class="table-section">
          <div class="table-header-title">Transcript of Grades</div>
          <div class="table-row header-row">
            <div class="table-cell header">Name</div>
            <div class="table-cell header">Year/Course/Major</div>
            <div class="table-cell header">Year Graduated</div>
            <div class="table-cell header">Student ID</div>
          </div>
          <div class="table-row">
            <div class="table-cell">Sarah Jane Maralo</div>
            <div class="table-cell">N/A</div>
            <div class="table-cell">2024</div>
            <div class="table-cell">2019-0987654</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Page -->
    <div id="settings-page" class="page">
      <!-- Add this somewhere in your admin dashboard HTML where you want to show staff info -->
      <div class="staff-info-card" style="
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
          ">
        <div class="staff-header d-flex align-items-center mb-3">
          <div class="staff-avatar" style="
                width: 60px;
                height: 60px;
                border-radius: 50%;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: bold;
                font-size: 1.5rem;
                margin-right: 15px;
              ">
            <span id="staffAvatarInitials">AD</span>
          </div>
          <div>
            <h4 id="staffFullName" class="mb-1">Loading...</h4>
            <p class="text-muted mb-0" id="staffEmail">Loading...</p>
            <span class="badge bg-primary" id="staffRole">Loading...</span>
          </div>
        </div>

        <div class="staff-details">
          <div class="row">
            <div class="col-md-6">
              <p>
                <strong>Department:</strong>
                <span id="staffDepartment">Loading...</span>
              </p>
              <p>
                <strong>Phone:</strong>
                <span id="staffPhone">Loading...</span>
              </p>
            </div>
            <div class="col-md-6">
              <p>
                <strong>Last Login:</strong>
                <span id="staffLastLogin">Loading...</span>
              </p>
              <p>
                <strong>Member Since:</strong>
                <span id="staffMemberSince">Loading...</span>
              </p>
            </div>
          </div>
        </div>
      </div>

      <div class="header">
        <h1>Settings</h1>
      </div>

      <!-- Account Center Section -->
      <div class="settings-section">
        <h2 class="settings-section-title">Account Center</h2>

        <div class="settings-item" onclick="toggleModal('accountDetailsModal')">
          <div class="settings-item-icon">👤</div>
          <span>Registrar Staff Account Details</span>
        </div>

        <div class="settings-item" onclick="toggleModal('passwordModal')">
          <div class="settings-item-icon">🔒</div>
          <span>Manage Account Password</span>
        </div>

        <div class="settings-profile">
          <div class="profile-avatar-large"></div>
          <div class="profile-info">
            <h3>Jila Santos</h3>
            <p>Registrar Staff</p>
          </div>
        </div>

        <button class="btn-logout" onclick="handleLogout()">
          🚪 Log out
        </button>
      </div>

      <!-- Manage Queue System Settings Section -->
      <div class="settings-section">
        <h2 class="settings-section-title">Manage Queue System Settings</h2>

        <div class="settings-item" onclick="toggleModal('waitingTimeModal')">
          <div class="settings-item-icon">⏱️</div>
          <span>Edit Services Waiting Time</span>
        </div>

        <div class="settings-item" onclick="toggleModal('monitoringModal')">
          <div class="settings-item-icon">📺</div>
          <span>Edit Monitoring Details</span>
        </div>

        <div class="settings-item" onclick="toggleModal('notificationModal')">
          <div class="settings-item-icon">🔔</div>
          <span>Edit Notification Details</span>
        </div>

        <div class="settings-item" onclick="toggleFontSize()">
          <div class="settings-item-icon">Aa</div>
          <span>Change Font Size</span>
          <span class="settings-value" id="fontSizeValue">Medium</span>
        </div>
      </div>
    </div>

    <!-- ------Modals-------------------------------------------------------------------------- -->

    <!-- Account Details Modal -->
    <div id="accountDetailsModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Registrar Staff Account Details</h3>
          <span class="modal-close" onclick="toggleModal('accountDetailsModal')">&times;</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>Full Name</label>
            <input type="text" value="Jila Santos" class="form-input" />
          </div>
          <div class="form-group">
            <label>Email Address</label>
            <input type="email" value="jila.santos@rsu.edu" class="form-input" />
          </div>
          <div class="form-group">
            <label>Role</label>
            <input type="text" value="Registrar Staff" class="form-input" disabled />
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="toggleModal('accountDetailsModal')">
            Cancel
          </button>
          <button class="btn btn-primary" onclick="saveAccountDetails()">
            Save Changes
          </button>
        </div>
      </div>
    </div>

    <!-- Password Modal -->
    <div id="passwordModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Manage Account Password</h3>
          <span class="modal-close" onclick="toggleModal('passwordModal')">&times;</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>Current Password</label>
            <input type="password" class="form-input" placeholder="Enter current password" />
          </div>
          <div class="form-group">
            <label>New Password</label>
            <input type="password" class="form-input" placeholder="Enter new password" />
          </div>
          <div class="form-group">
            <label>Confirm New Password</label>
            <input type="password" class="form-input" placeholder="Confirm new password" />
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="toggleModal('passwordModal')">
            Cancel
          </button>
          <button class="btn btn-primary" onclick="changePassword()">
            Change Password
          </button>
        </div>
      </div>
    </div>

    <!-- Approve Request Modal -->
    <div id="approveRequestModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Approve Service Request</h3>
          <span class="modal-close" onclick="toggleModal('approveRequestModal')">&times;</span>
        </div>
        <div class="modal-body">
          <input type="hidden" id="approveRequestId" />
          <div class="form-group">
            <label>Request Details</label>
            <div id="approveRequestDetails" class="request-details-preview">
              <!-- Request details will be populated here -->
            </div>
          </div>
          <div class="form-group">
            <label>Admin Notes (Optional)</label>
            <textarea id="approveNotes" class="form-input" rows="3"
              placeholder="Add any notes for the student..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="toggleModal('approveRequestModal')">
            Cancel
          </button>
          <button class="btn btn-success" onclick="serviceRequestManager.confirmApproveRequest()">
            Approve Request
          </button>
        </div>
      </div>
    </div>

    <!-- Decline Request Modal -->
    <div id="declineRequestModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Decline Service Request</h3>
          <span class="modal-close" onclick="toggleModal('declineRequestModal')">&times;</span>
        </div>
        <div class="modal-body">
          <input type="hidden" id="declineRequestId" />
          <div class="form-group">
            <label>Request Details</label>
            <div id="declineRequestDetails" class="request-details-preview">
              <!-- Request details will be populated here -->
            </div>
          </div>
          <div class="form-group">
            <label>Reason for Declining <span style="color: red">*</span></label>
            <textarea id="declineReason" class="form-input" rows="4"
              placeholder="Please provide a clear reason for declining this request..." required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="toggleModal('declineRequestModal')">
            Cancel
          </button>
          <button class="btn btn-danger" onclick="serviceRequestManager.confirmDeclineRequest()">
            Decline Request
          </button>
        </div>
      </div>
    </div>

    <!-- Request Details Modal -->
    <div id="requestDetailsModal" class="modal">
      <div class="modal-content" style="max-width: 700px">
        <div class="modal-header">
          <h3>Service Request Details</h3>
          <span class="modal-close" onclick="toggleModal('requestDetailsModal')">&times;</span>
        </div>
        <div class="modal-body">
          <div id="requestDetailsContent">
            <!-- Request details will be populated here -->
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="toggleModal('requestDetailsModal')">
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Additional Modals for Settings -->
    <div id="waitingTimeModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Edit Services Waiting Time</h3>
          <span class="modal-close" onclick="toggleModal('waitingTimeModal')">&times;</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>Average Service Time (minutes)</label>
            <input type="number" class="form-input" value="15" min="1" />
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="toggleModal('waitingTimeModal')">
            Cancel
          </button>
          <button class="btn btn-primary" onclick="saveWaitingTime()">
            Save Changes
          </button>
        </div>
      </div>
    </div>

    <div id="monitoringModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Edit Monitoring Details</h3>
          <span class="modal-close" onclick="toggleModal('monitoringModal')">&times;</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>Auto-refresh Interval (seconds)</label>
            <input type="number" class="form-input" value="5" min="1" />
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="toggleModal('monitoringModal')">
            Cancel
          </button>
          <button class="btn btn-primary" onclick="saveMonitoring()">
            Save Changes
          </button>
        </div>
      </div>
    </div>

    <div id="notificationModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Edit Notification Details</h3>
          <span class="modal-close" onclick="toggleModal('notificationModal')">&times;</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>Enable Sound Notifications</label>
            <input type="checkbox" checked />
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="toggleModal('notificationModal')">
            Cancel
          </button>
          <button class="btn btn-primary" onclick="saveNotification()">
            Save Changes
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- New Modal for Manual Transaction Details -->
  <div id="manualTransactionModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Manual Transaction Details</h3>
        <span class="modal-close" onclick="toggleModal('manualTransactionModal')">&times;</span>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Transaction Type</label>
          <select id="transactionType" class="form-input">
            <option value="walkin">Walk-in Transaction</option>
            <option value="phone">Phone Transaction</option>
            <option value="emergency">Emergency Service</option>
          </select>
        </div>
        <div class="form-group">
          <label>Additional Notes</label>
          <textarea id="transactionNotes" class="form-input" rows="3"
            placeholder="Any additional information..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="toggleModal('manualTransactionModal')">
          Cancel
        </button>
        <button class="btn btn-primary" onclick="confirmManualQueue()">
          Add to Queue
        </button>
      </div>
    </div>
  </div>

  <script>
    // Initialize managers
    let serviceRequestManager;
    let queueManager;
    let isQueuePaused = false;

    // Admin Dashboard Authentication Helper
    const adminToken = localStorage.getItem("adminToken");
    console.log(
      "Admin token from localStorage:",
      adminToken ? "Present" : "Missing"
    );

    let currentStaff = null;

    // Function to make authenticated API calls
    function makeAuthenticatedRequest(url, options = {}) {
      if (!adminToken) {
        console.error("No admin token found, redirecting to login");
        adminLogout();
        return Promise.reject("No admin token");
      }

      const defaultOptions = {
        headers: {
          Authorization: `Bearer ${adminToken}`,
          "Content-Type": "application/json",
          ...options.headers,
        },
      };

      console.log("Making authenticated request to:", url);
      return fetch(url, { ...defaultOptions, ...options });
    }

    // Function to display staff information
    function displayStaffInfo(staff) {
      currentStaff = staff;

      // Update staff info in the UI
      if (document.getElementById("staffFullName")) {
        document.getElementById("staffFullName").textContent =
          staff.full_name;
      }

      if (document.getElementById("staffEmail")) {
        document.getElementById("staffEmail").textContent = staff.email;
      }

      if (document.getElementById("staffRole")) {
        document.getElementById("staffRole").textContent = staff.role
          .replace("_", " ")
          .toUpperCase();
      }

      if (document.getElementById("staffDepartment")) {
        document.getElementById("staffDepartment").textContent =
          staff.department || "Not specified";
      }

      if (document.getElementById("staffPhone")) {
        document.getElementById("staffPhone").textContent =
          staff.phone || "Not specified";
      }

      if (document.getElementById("staffLastLogin")) {
        document.getElementById("staffLastLogin").textContent =
          staff.last_login
            ? new Date(staff.last_login).toLocaleString()
            : "First login";
      }

      if (document.getElementById("staffMemberSince")) {
        document.getElementById("staffMemberSince").textContent = new Date(
          staff.created_at
        ).toLocaleDateString();
      }

      if (document.getElementById("staffAvatarInitials")) {
        const initials = staff.full_name
          .split(" ")
          .map((n) => n[0])
          .join("")
          .toUpperCase();
        document.getElementById("staffAvatarInitials").textContent = initials;
      }

      // Also update any other places where staff name is displayed
      if (document.getElementById("adminName")) {
        document.getElementById("adminName").textContent = staff.full_name;
      }

      // Update the ServiceRequestManager's currentAdmin
      if (serviceRequestManager) {
        serviceRequestManager.currentAdmin = staff.full_name;
      }

      console.log("Staff info displayed:", staff.full_name);
    }

    // Check authentication on page load
    if (!adminToken) {
      window.location.href = "/adminLogin";
    } else {
      console.log("Admin token found, verifying...");
      // Verify token is still valid on page load
      makeAuthenticatedRequest("/api/admin/me")
        .then((response) => {
          console.log("Auth check response status:", response.status);
          return response.json();
        })
        .then((data) => {
          console.log("Auth check response:", data);
          if (!data.success) {
            console.log("Token invalid, logging out");
            adminLogout();
          } else {
            console.log("Admin logged in:", data.admin);
            // You can display admin info in the dashboard
            if (document.getElementById("adminName")) {
              document.getElementById("adminName").textContent =
                data.admin.full_name;
            }

            // Load initial data after successful auth
            if (queueManager) {
              queueManager.loadQueues();
            }
            if (serviceRequestManager) {
              serviceRequestManager.loadServiceRequests();
            }
          }
        })
        .catch((error) => {
          console.error("Auth check failed:", error);
          adminLogout();
        });
    }

    // Admin logout function
    function adminLogout() {
      localStorage.removeItem("admin");
      localStorage.removeItem("adminToken");
      window.location.href = "/adminLogin";
    }

    // Navigation functionality
    document.addEventListener("DOMContentLoaded", function () {
      console.log("Admin dashboard initialized");

      // Initialize managers
      serviceRequestManager = new ServiceRequestManager();
      queueManager = new QueueManager();

      // Set up navigation
      setupNavigation();

      // Show initial page
      showPage("queue");

      // Load preferences
      loadPreferences();

      // Set up auto-refresh
      setupAutoRefresh();
    });

    function setupNavigation() {
      const menuItems = document.querySelectorAll(".menu-item");

      menuItems.forEach((item) => {
        item.addEventListener("click", () => {
          const targetPage = item.getAttribute("data-page");

          // Remove active class from all menu items and pages
          menuItems.forEach((mi) => mi.classList.remove("active"));
          document
            .querySelectorAll(".page")
            .forEach((page) => page.classList.remove("active"));

          // Add active class to clicked item
          item.classList.add("active");

          // Show target page
          showPage(targetPage);
        });
      });
    }

    function showPage(page) {
      // Hide all pages
      document
        .querySelectorAll(".page")
        .forEach((p) => p.classList.remove("active"));

      // Show target page
      const pageToShow = document.getElementById(page + "-page");
      if (pageToShow) {
        pageToShow.classList.add("active");

        // Refresh data for specific pages
        if (page === "queue" && queueManager) {
          queueManager.loadQueues();
        } else if (page === "documents" && serviceRequestManager) {
          serviceRequestManager.loadServiceRequests();
        } else if (page === "reports") {
          updateReportsData();
        }
      } else {
        console.error("Page not found:", page);
        // Fallback to queue page
        document.getElementById("queue-page").classList.add("active");
      }
    }

    function showReportDetail() {
      showPage("report-detail");
    }

    function toggleQueuePause() {
      isQueuePaused = !isQueuePaused;
      const btn = document.getElementById("pauseQueueBtn");
      if (isQueuePaused) {
        btn.innerHTML = "▶️ Resume Queue";
        showNotification("Queue processing paused", "warning");
      } else {
        btn.innerHTML = "⏸️ Pause Queue";
        showNotification("Queue processing resumed", "success");
      }
    }

    function updateReportsData() {
      // Update report statistics
      if (queueManager && queueManager.queues) {
        const total =
          (queueManager.queues.waiting || []).length +
          (queueManager.queues.processing || []).length +
          (queueManager.queues.completed || []).length;

        document.getElementById("totalRequestsSummary").textContent = total;
        document.getElementById("completedSummary").textContent = (
          queueManager.queues.completed || []
        ).length;
        document.getElementById("totalRequestsToday").textContent = total;
      }
    }

    function setupAutoRefresh() {
      // Refresh queue data every 10 seconds
      setInterval(() => {
        if (
          !isQueuePaused &&
          document.getElementById("queue-page").classList.contains("active")
        ) {
          queueManager.loadQueues();
        }
      }, 10000);

      // Refresh service requests every 30 seconds
      setInterval(() => {
        if (
          document
            .getElementById("documents-page")
            .classList.contains("active")
        ) {
          serviceRequestManager.loadServiceRequests();
        }
      }, 30000);
    }

    // Modal functions
    function toggleModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.classList.toggle("active");
      }
    }

    // Close modal when clicking outside
    window.onclick = function (event) {
      if (event.target.classList.contains("modal")) {
        event.target.classList.remove("active");
      }
    };

    // Theme toggle
    let currentTheme = "light";
    function toggleTheme() {
      currentTheme = currentTheme === "light" ? "dark" : "light";
      document.getElementById("themeValue").textContent =
        currentTheme === "light" ? "Light" : "Dark";

      if (currentTheme === "dark") {
        document.documentElement.setAttribute("data-theme", "dark");
        document.body.classList.add("dark-theme");
      } else {
        document.documentElement.removeAttribute("data-theme");
        document.body.classList.remove("dark-theme");
      }

      showNotification(
        "Theme changed to " + (currentTheme === "light" ? "Light" : "Dark")
      );

      // Save to localStorage
      localStorage.setItem("adminTheme", currentTheme);
    }

    // Font size toggle
    const fontSizes = ["Small", "Medium", "Large"];
    let currentFontSizeIndex = 1;
    function toggleFontSize() {
      currentFontSizeIndex = (currentFontSizeIndex + 1) % fontSizes.length;
      const fontSize = fontSizes[currentFontSizeIndex];
      document.getElementById("fontSizeValue").textContent = fontSize;

      const sizes = {
        Small: "14px",
        Medium: "16px",
        Large: "18px",
      };

      document.body.style.fontSize = sizes[fontSize];
      showNotification("Font size changed to " + fontSize);

      // Save to localStorage
      localStorage.setItem("adminFontSize", fontSize);
    }

    // Load saved preferences
    function loadPreferences() {
      // Load theme
      const savedTheme = localStorage.getItem("adminTheme");
      if (savedTheme) {
        currentTheme = savedTheme;
        document.getElementById("themeValue").textContent =
          savedTheme === "light" ? "Light" : "Dark";
        if (savedTheme === "dark") {
          document.documentElement.setAttribute("data-theme", "dark");
          document.body.classList.add("dark-theme");
        }
      }

      // Load font size
      const savedFontSize = localStorage.getItem("adminFontSize");
      if (savedFontSize) {
        const sizes = { Small: "14px", Medium: "16px", Large: "18px" };
        document.body.style.fontSize = sizes[savedFontSize];
        document.getElementById("fontSizeValue").textContent = savedFontSize;
        currentFontSizeIndex = fontSizes.indexOf(savedFontSize);
      }
    }

    // Save functions
    function saveAccountDetails() {
      showNotification("Account details saved successfully!");
      toggleModal("accountDetailsModal");
    }

    function changePassword() {
      showNotification("Password changed successfully!");
      toggleModal("passwordModal");
    }

    function saveWaitingTime() {
      showNotification("Waiting time settings saved!");
      toggleModal("waitingTimeModal");
    }

    function saveMonitoring() {
      showNotification("Monitoring settings saved!");
      toggleModal("monitoringModal");
    }

    function saveNotification() {
      showNotification("Notification settings saved!");
      toggleModal("notificationModal");
    }

    function handleLogout() {
      if (confirm("Are you sure you want to log out?")) {
        showNotification("Logging out...");
        setTimeout(() => {
          adminLogout();
        }, 1000);
      }
    }

    // Notification system
    function showNotification(message, type = "success") {
      // Remove existing notification if any
      const existingNotif = document.querySelector(".notification-toast");
      if (existingNotif) {
        existingNotif.remove();
      }

      // Create notification
      const notification = document.createElement("div");
      notification.className = "notification-toast";
      notification.textContent = message;

      // Style based on type
      const bgColor =
        type === "error"
          ? "#d32f2f"
          : type === "warning"
            ? "#f57c00"
            : "#2e7d32";
      notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${bgColor};
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 10000;
            animation: slideInRight 0.3s ease-out;
        `;

      document.body.appendChild(notification);

      // Remove after 3 seconds
      setTimeout(() => {
        if (notification.parentNode) {
          notification.style.animation = "slideOutRight 0.3s ease-out";
          setTimeout(() => {
            if (notification.parentNode) {
              notification.remove();
            }
          }, 300);
        }
      }, 3000);
    }

    // Service Request Management
    class ServiceRequestManager {
      constructor() {
        this.currentAdmin = "Jila Santos";
        this.requests = [];
      }

      async loadServiceRequests() {
        try {
          console.log("Loading service requests...");
          const response = await makeAuthenticatedRequest(
            "/api/admin/service-requests"
          );

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();

          if (result.success) {
            this.requests = result.requests || [];
            this.renderRequests();
            this.updateStats();
            console.log(
              "Service requests loaded successfully:",
              this.requests.length
            );
          } else {
            console.error("Error loading service requests:", result.message);
            this.showEmptyState();
            showNotification(
              "Failed to load service requests: " + result.message,
              "error"
            );
          }
        } catch (error) {
          console.error("Error loading service requests:", error);
          this.showEmptyState();
          if (error.message.includes("No admin token")) {
            showNotification("Session expired. Please login again.", "error");
            adminLogout();
          } else {
            showNotification("Failed to load service requests", "error");
          }
        }
      }

      showEmptyState() {
        const containers = [
          "pendingRequestsContainer",
          "approvedRequestsContainer",
          "declinedRequestsContainer",
        ];

        containers.forEach((containerId) => {
          const container = document.getElementById(containerId);
          if (container) {
            container.innerHTML = `
                        <div class="empty-state">
                            <div style="text-align: center; padding: 40px; color: #999;">
                                <div style="font-size: 3rem;">📋</div>
                                <p style="margin-top: 10px;">No service requests found.</p>
                            </div>
                        </div>
                    `;
          }
        });

        this.updateStats();
      }

      renderRequests() {
        this.renderPendingRequests();
        this.renderApprovedRequests();
        this.renderDeclinedRequests();
      }

      renderPendingRequests() {
        const container = document.getElementById("pendingRequestsContainer");
        if (!container) return;

        const pendingRequests = this.requests.filter(
          (req) => req.status === "pending"
        );

        if (pendingRequests.length === 0) {
          container.innerHTML = `
                    <div class="empty-state">
                        <div style="text-align: center; padding: 40px; color: #999;">
                            <div style="font-size: 3rem;"> </div>
                            <p style="margin-top: 10px;">No pending service requests.</p>
                        </div>
                    </div>
                `;
          return;
        }

        container.innerHTML = pendingRequests
          .map(
            (request) => `
                        <div class="document-item">
                            <div class="document-header">
                                <div>
                                    <div class="document-title">${this.escapeHtml(
              request.services.join(", ")
            )}</div>
                                    <div class="document-description">
                                        Requested by: ${this.escapeHtml(
              request.user_name
            )} (${this.escapeHtml(
              request.student_id
            )})<br>
                                        Course: ${this.escapeHtml(
              request.course
            )} - ${this.escapeHtml(
              request.year_level
            )}<br>
                                        Total Amount: ₱${parseFloat(
              request.total_amount || 0
            ).toFixed(2)}
                                    </div>
                                </div>
                                <div class="queue-number">Request ID: ${this.escapeHtml(
              request.request_id
            )}</div>
                            </div>
                            <div class="document-meta">
                                <span>Submitted: ${new Date(
              request.submitted_at
            ).toLocaleString()}</span>
                                <div class="button-group" style="margin-top: 10px;">
                                    <button class="btn btn-success btn-sm" onclick="serviceRequestManager.showApproveModal('${request.request_id
              }')">
                                        ✓ Approve
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="serviceRequestManager.showDeclineModal('${request.request_id
              }')">
                                        ✗ Decline
                                    </button>
                                    <button class="btn btn-primary btn-sm" onclick="serviceRequestManager.viewRequestDetails('${request.request_id
              }')">
                                        👁️ View Details
                                    </button>
                                </div>
                            </div>
                        </div>
                    `
          )
          .join("");
      }

      renderApprovedRequests() {
        const container = document.getElementById(
          "approvedRequestsContainer"
        );
        if (!container) return;

        const approvedRequests = this.requests.filter(
          (req) => req.status === "approved"
        );

        if (approvedRequests.length === 0) {
          container.innerHTML = `
                    <div class="empty-state">
                        <div style="text-align: center; padding: 40px; color: #999;">
                            <div style="font-size: 3rem;"></div>
                            <p style="margin-top: 10px;">No approved service requests.</p>
                        </div>
                    </div>
                `;
          return;
        }

        container.innerHTML = approvedRequests
          .map(
            (request) => `
                        <div class="document-item approved">
                            <div class="document-header">
                                <div>
                                    <div class="document-title">${this.escapeHtml(
              request.services.join(", ")
            )}</div>
                                    <div class="document-description">
                                        Requested by: ${this.escapeHtml(
              request.user_name
            )} (${this.escapeHtml(
              request.student_id
            )})<br>
                                        ${request.approved_by
                ? `Approved by: ${this.escapeHtml(
                  request.approved_by
                )}<br>`
                : ""
              }
                                        ${request.approved_at
                ? `Approved at: ${new Date(
                  request.approved_at
                ).toLocaleString()}`
                : ""
              }
                                    </div>
                                </div>
                                <div class="queue-number">
                                    <span class="badge approved-badge">Approved</span>
                                </div>
                            </div>
                            <div class="document-meta">
                                <span>Request ID: ${this.escapeHtml(
                request.request_id
              )}</span>
                            </div>
                        </div>
                    `
          )
          .join("");
      }

      renderDeclinedRequests() {
        const container = document.getElementById(
          "declinedRequestsContainer"
        );
        if (!container) return;

        const declinedRequests = this.requests.filter(
          (req) => req.status === "declined"
        );

        if (declinedRequests.length === 0) {
          container.innerHTML = `
                    <div class="empty-state">
                        <div style="text-align: center; padding: 40px; color: #999;">
                            <div style="font-size: 3rem;"></div>
                            <p style="margin-top: 10px;">No declined service requests.</p>
                        </div>
                    </div>
                `;
          return;
        }

        container.innerHTML = declinedRequests
          .map(
            (request) => `
                        <div class="document-item declined">
                            <div class="document-header">
                                <div>
                                    <div class="document-title">${this.escapeHtml(
              request.services.join(", ")
            )}</div>
                                    <div class="document-description">
                                        Requested by: ${this.escapeHtml(
              request.user_name
            )} (${this.escapeHtml(
              request.student_id
            )})<br>
                                        ${request.declined_by
                ? `Declined by: ${this.escapeHtml(
                  request.declined_by
                )}<br>`
                : ""
              }
                                        ${request.decline_reason
                ? `Reason: ${this.escapeHtml(
                  request.decline_reason
                )}`
                : ""
              }
                                    </div>
                                </div>
                                <div class="queue-number">
                                    <span class="badge declined-badge">Declined</span>
                                </div>
                            </div>
                            <div class="document-meta">
                                <span>${request.declined_at
                ? `Declined at: ${new Date(
                  request.declined_at
                ).toLocaleString()}`
                : "Declined"
              }</span>
                            </div>
                        </div>
                    `
          )
          .join("");
      }

      updateStats() {
        const pendingCount = this.requests.filter(
          (req) => req.status === "pending"
        ).length;
        const approvedCount = this.requests.filter(
          (req) => req.status === "approved"
        ).length;
        const declinedCount = this.requests.filter(
          (req) => req.status === "declined"
        ).length;

        const pendingElement = document.getElementById("pendingCount");
        const approvedElement = document.getElementById("approvedCount");
        const declinedElement = document.getElementById("declinedCount");

        if (pendingElement) pendingElement.textContent = pendingCount;
        if (approvedElement) approvedElement.textContent = approvedCount;
        if (declinedElement) declinedElement.textContent = declinedCount;
      }

      showApproveModal(requestId) {
        const request = this.requests.find(
          (req) => req.request_id === requestId
        );
        if (!request) return;

        document.getElementById("approveRequestId").value = requestId;
        document.getElementById("approveRequestDetails").innerHTML =
          this.getRequestDetailsHTML(request);
        document.getElementById("approveNotes").value = "";

        toggleModal("approveRequestModal");
      }

      showDeclineModal(requestId) {
        const request = this.requests.find(
          (req) => req.request_id === requestId
        );
        if (!request) return;

        document.getElementById("declineRequestId").value = requestId;
        document.getElementById("declineRequestDetails").innerHTML =
          this.getRequestDetailsHTML(request);
        document.getElementById("declineReason").value = "";

        toggleModal("declineRequestModal");
      }

      viewRequestDetails(requestId) {
        const request = this.requests.find(
          (req) => req.request_id === requestId
        );
        if (!request) return;

        document.getElementById("requestDetailsContent").innerHTML =
          this.getDetailedRequestHTML(request);
        toggleModal("requestDetailsModal");
      }

      getRequestDetailsHTML(request) {
        return `
                <div class="request-preview">
                    <strong>Student:</strong> ${this.escapeHtml(
          request.user_name
        )} (${this.escapeHtml(request.student_id)})<br>
                    <strong>Course:</strong> ${this.escapeHtml(
          request.course
        )} - ${this.escapeHtml(request.year_level)}<br>
                    <strong>Services:</strong> ${this.escapeHtml(
          request.services.join(", ")
        )}<br>
                    <strong>Total Amount:</strong> ₱${parseFloat(
          request.total_amount || 0
        ).toFixed(2)}<br>
                    <strong>Submitted:</strong> ${new Date(
          request.submitted_at
        ).toLocaleString()}
                </div>
            `;
      }

      getDetailedRequestHTML(request) {
        const services = Array.isArray(request.services)
          ? request.services
          : [];
        const requirements = Array.isArray(request.requirements)
          ? request.requirements
          : [];

        const requirementsHTML = requirements
          .map(
            (req) => `
                        <div class="requirement-item">
                            <strong>${this.escapeHtml(
              req.service || "Service"
            )}:</strong><br>
                            <ul>
                                ${(req.requirements || [])
                .map((r) => `<li>${this.escapeHtml(r)}</li>`)
                .join("")}
                            </ul>
                        </div>
                    `
          )
          .join("");

        return `
                <div class="request-details">
                    <div class="info-row">
                        <span class="info-label">Request ID:</span>
                        <span class="info-value">${this.escapeHtml(
          request.request_id
        )}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Student Name:</span>
                        <span class="info-value">${this.escapeHtml(
          request.user_name
        )}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Student ID:</span>
                        <span class="info-value">${this.escapeHtml(
          request.student_id
        )}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Course & Year:</span>
                        <span class="info-value">${this.escapeHtml(
          request.course
        )} - ${this.escapeHtml(request.year_level)}</span>
                    </div>
                    ${request.contact_email
            ? `
                        <div class="info-row">
                            <span class="info-label">Contact Email:</span>
                            <span class="info-value">${this.escapeHtml(
              request.contact_email
            )}</span>
                        </div>
                    `
            : ""
          }
                    ${request.contact_phone
            ? `
                        <div class="info-row">
                            <span class="info-label">Contact Phone:</span>
                            <span class="info-value">${this.escapeHtml(
              request.contact_phone
            )}</span>
                        </div>
                    `
            : ""
          }
                    <div class="info-row">
                        <span class="info-label">Submitted:</span>
                        <span class="info-value">${new Date(
            request.submitted_at
          ).toLocaleString()}</span>
                    </div>
                    
                    <h4>Requested Services</h4>
                    <div class="services-list">
                        ${services
            .map(
              (service) => `
                                    <div class="service-item">
                                        <strong>• ${this.escapeHtml(
                service
              )}</strong>
                                    </div>
                                `
            )
            .join("")}
                        <div class="total-amount">
                            <strong>Total Amount: ₱${parseFloat(
              request.total_amount || 0
            ).toFixed(2)}</strong>
                        </div>
                    </div>

                    ${requirements.length > 0
            ? `
                        <h4>Requirements</h4>
                        <div class="requirements-list">
                            ${requirementsHTML}
                        </div>
                    `
            : ""
          }

                    ${request.status === "approved" && request.approved_by
            ? `
                        <div class="approval-details">
                            <strong>Approval Details:</strong><br>
                            Approved by: ${this.escapeHtml(
              request.approved_by
            )}<br>
                            ${request.approved_at
              ? `Approved at: ${new Date(
                request.approved_at
              ).toLocaleString()}<br>`
              : ""
            }
                            ${request.approve_notes
              ? `Notes: ${this.escapeHtml(
                request.approve_notes
              )}`
              : ""
            }
                        </div>
                    `
            : ""
          }

                    ${request.status === "declined" && request.declined_by
            ? `
                        <div class="decline-details">
                            <strong>Decline Details:</strong><br>
                            Declined by: ${this.escapeHtml(
              request.declined_by
            )}<br>
                            ${request.declined_at
              ? `Declined at: ${new Date(
                request.declined_at
              ).toLocaleString()}<br>`
              : ""
            }
                            ${request.decline_reason
              ? `Reason: ${this.escapeHtml(
                request.decline_reason
              )}`
              : ""
            }
                        </div>
                    `
            : ""
          }
                </div>
            `;
      }

      async confirmApproveRequest() {
        const requestId = document.getElementById("approveRequestId").value;
        const notes = document.getElementById("approveNotes").value;

        try {
          const response = await makeAuthenticatedRequest(
            "/api/admin/approve-request",
            {
              method: "POST",
              body: JSON.stringify({
                requestId: requestId,
                approveNotes: notes,
              }),
            }
          );

          const result = await response.json();

          if (result.success) {
            toggleModal("approveRequestModal");
            showNotification("Request approved successfully!");

            // Reload data
            await this.loadServiceRequests();

            // Refresh queue if on queue page
            if (
              queueManager &&
              document
                .getElementById("queue-page")
                .classList.contains("active")
            ) {
              await queueManager.loadQueues();
            }
          } else {
            alert("Error approving request: " + result.message);
          }
        } catch (error) {
          console.error("Error approving request:", error);
          alert("Error approving request. Please try again.");
        }
      }

      async confirmDeclineRequest() {
        const requestId = document.getElementById("declineRequestId").value;
        const reason = document.getElementById("declineReason").value;

        if (!reason.trim()) {
          alert("Please provide a reason for declining.");
          return;
        }

        try {
          const response = await makeAuthenticatedRequest(
            "/api/admin/decline-request",
            {
              method: "POST",
              body: JSON.stringify({
                requestId: requestId,
                declineReason: reason,
              }),
            }
          );

          const result = await response.json();

          if (result.success) {
            toggleModal("declineRequestModal");
            await this.loadServiceRequests();
            showNotification("Request declined successfully!");
          } else {
            alert("Error declining request: " + result.message);
          }
        } catch (error) {
          console.error("Error declining request:", error);
          alert("Error declining request. Please try again.");
        }
      }

      // Utility function to prevent XSS
      escapeHtml(unsafe) {
        if (unsafe === null || unsafe === undefined) return "";
        return String(unsafe)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }
    }

    // Queue Manager
    class QueueManager {
      constructor() {
        this.queues = {
          waiting: [],
          processing: [],
          ready: [],
          completed: [],
          priority: [],
        };
        this.isAutoRefresh = true;
        this.lastUpdate = null;
      }

      async loadQueues() {
        try {
          console.log("Loading queues...");
          const response = await makeAuthenticatedRequest(
            "/api/admin/queues"
          );

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();

          if (result.success) {
            this.queues = result.queues || {
              waiting: [],
              processing: [],
              ready: [],
              completed: [],
              priority: [],
            };
            this.renderQueueDashboard();
            this.updateQueueStats();
            updateReportsData();
            this.lastUpdate = new Date();
            console.log("Queues loaded successfully:", this.queues);
          } else {
            console.error("Error loading queues:", result.message);
            this.showEmptyQueueState();
            showNotification(
              "Failed to load queue data: " + result.message,
              "error"
            );
          }
        } catch (error) {
          console.error("Error loading queues:", error);
          this.showEmptyQueueState();
          if (error.message.includes("No admin token")) {
            showNotification("Session expired. Please login again.", "error");
            adminLogout();
          } else if (!error.message.includes("Failed to fetch")) {
            showNotification("Failed to load queue data", "error");
          }
        }
      }

      renderQueueDashboard() {
        this.renderCurrentRequest();
        this.renderPriorityQueue();
        this.renderRegularQueue();
        this.renderProcessingQueue();
      }

      renderCurrentRequest() {
        const currentProcessing = this.queues.processing[0];
        const currentRequestCard =
          document.getElementById("currentRequestCard");

        if (!currentRequestCard) return;

        if (!currentProcessing) {
          currentRequestCard.innerHTML = `
                    <div class="card-header">
                        <div>
                            <span class="card-title">Current Request</span>
                            <span class="badge inactive">No Active Request</span>
                        </div>
                    </div>
                    <div class="empty-state">
                        <div style="text-align: center; padding: 40px; color: #999;">
                            <div style="font-size: 3rem;">📋</div>
                            <p style="margin-top: 10px;">No request is currently being processed.</p>
                        </div>
                    </div>
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="queueManager.processNextInQueue()" style="width: 100%;">
                            Process Next in Queue
                        </button>
                    </div>
                `;
          return;
        }

        const isPriority = currentProcessing.is_priority;
        const services = Array.isArray(currentProcessing.services)
          ? currentProcessing.services
          : [];

        const processingTime = this.getProcessingTime(
          currentProcessing.started_at
        );

        currentRequestCard.innerHTML = `
                <div class="card-header">
                    <div>
                        <span class="card-title">Current Request</span>
                        ${isPriority
            ? '<span class="badge priority">🔴 PRIORITY</span>'
            : ""
          }
                        <span class="badge processing">⏱️ Processing (${processingTime})</span>
                    </div>
                </div>
                <div class="info-row">
                    <span class="info-label">Queue Number:</span>
                    <span class="info-value">${this.escapeHtml(
            currentProcessing.queue_number
          )}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Full Name:</span>
                    <span class="info-value">${this.escapeHtml(
            currentProcessing.user_name
          )}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Student ID:</span>
                    <span class="info-value">${this.escapeHtml(
            currentProcessing.student_id || "N/A"
          )}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Services:</span>
                    <span class="info-value">${services.join(", ")}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Started:</span>
                    <span class="info-value">${new Date(
            currentProcessing.started_at
          ).toLocaleTimeString()}</span>
                </div>
                ${isPriority
            ? `
                    <div class="alert-box">
                        ℹ️ <strong>Priority Service:</strong> This request is prioritized.
                    </div>
                `
            : ""
          }
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="queueManager.notifyStudent('${currentProcessing.queue_id
          }')">
                        🔔 Notify Student
                    </button>
                    <button class="btn btn-warning" onclick="queueManager.escalatePriority('${currentProcessing.queue_id
          }')">
                        ⚡ Escalate
                    </button>
                    <button class="btn btn-success" onclick="queueManager.markAsDone('${currentProcessing.queue_id
          }')">
                        ✓ Mark as Done
                    </button>
                    <button class="btn btn-secondary" onclick="queueManager.transferToStaff('${currentProcessing.queue_id
          }')">
                        👥 Transfer
                    </button>
                </div>
            `;
      }

      renderProcessingQueue() {
        const container = document.getElementById("processingQueueContainer");
        const badge = document.getElementById("processingBadge");

        if (!container) return;

        const processingQueues = this.queues.processing || [];

        if (badge) {
          badge.textContent = processingQueues.length;
        }

        if (processingQueues.length === 0) {
          container.innerHTML = `
                    <div class="empty-state">
                        <div style="text-align: center; padding: 20px; color: #999;">
                            No requests currently processing
                        </div>
                    </div>
                `;
          return;
        }

        container.innerHTML = processingQueues
          .map((queue, index) => {
            const services = Array.isArray(queue.services)
              ? queue.services
              : [];
            const processingTime = this.getProcessingTime(queue.started_at);
            const isCurrent = index === 0;

            return `
                    <div class="queue-item ${isCurrent ? "queue-item-processing" : ""
              }" style="padding: 15px; border-bottom: 1px solid #eee; ${!isCurrent ? "opacity: 0.7;" : ""
              }">
                        <div class="queue-header" style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <div>
                                <strong>${this.escapeHtml(
                queue.queue_number
              )}</strong>
                                ${queue.is_priority
                ? '<span class="status-badge" style="background: #d32f2f; margin-left: 8px;">PRIORITY</span>'
                : ""
              }
                                ${isCurrent
                ? '<span class="status-badge status-processing">CURRENT</span>'
                : '<span class="status-badge status-waiting">NEXT</span>'
              }
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 12px; color: #666;">${processingTime}</div>
                            </div>
                        </div>
                        <div style="font-size: 14px; margin-bottom: 5px;">${this.escapeHtml(
                queue.user_name
              )}</div>
                        <div style="font-size: 12px; color: #666; margin-bottom: 8px;">
                            ${services.slice(0, 2).join(", ")}${services.length > 2 ? ` +${services.length - 2} more` : ""
              }
                        </div>
                        <div class="action-buttons">
                            ${!isCurrent
                ? `
                                <button class="btn btn-sm btn-primary" onclick="queueManager.makeCurrent('${queue.queue_id}')">Make Current</button>
                            `
                : ""
              }
                            <button class="btn btn-sm btn-success" onclick="queueManager.markAsDone('${queue.queue_id
              }')">Complete</button>
                            <button class="btn btn-sm btn-warning" onclick="queueManager.notifyStudent('${queue.queue_id
              }')">Notify</button>
                        </div>
                    </div>
                `;
          })
          .join("");
      }

      // renderPriorityQueue() {
      //   const priorityCard = document.getElementById(
      //     "priorityQueueContainer"
      //   );
      //   if (!priorityCard) return;

      //   const priorityQueues = this.queues.priority || [];

      //   priorityCard.innerHTML = `
      //         <div class="priority-header">
      //             <div>
      //                 <div style="color: #c62828; font-size: 14px; font-weight: 600; margin-bottom: 5px;">
      //                     ❤️ Priority Queue (${priorityQueues.length})
      //                 </div>
      //                 <div style="font-size: 12px; color: #666">Next: ${
      //                   priorityQueues[0]
      //                     ? priorityQueues[0].queue_number
      //                     : "None"
      //                 }</div>
      //             </div>
      //             <button class="btn btn-sm btn-outline-danger" onclick="queueManager.clearPriorityQueue()" ${
      //               priorityQueues.length === 0 ? "disabled" : ""
      //             }>
      //                 Clear All
      //             </button>
      //         </div>
      //         ${priorityQueues
      //           .map((queue, index) => {
      //             const services = Array.isArray(queue.services)
      //               ? queue.services
      //               : [];
      //             return `
      //                 <div class="priority-queue-item" style="background: white; border-radius: 8px; padding: 15px; margin-top: 10px; border-left: 4px solid #c62828;">
      //                     <div class="queue-header" style="display: flex; justify-content: space-between; margin-bottom: 10px;">
      //                         <div class="priority-id">${this.escapeHtml(
      //                           queue.queue_number
      //                         )}</div>
      //                         <div>
      //                             <span class="badge pwa">${this.escapeHtml(
      //                               queue.priority_type || "Priority"
      //                             )}</span>
      //                             <span class="status-badge status-waiting">#${
      //                               index + 1
      //                             }</span>
      //                         </div>
      //                     </div>
      //                     <div style="font-size: 14px; color: #333; margin-bottom: 5px; font-weight: 600;">${this.escapeHtml(
      //                       queue.user_name
      //                     )}</div>
      //                     <div style="font-size: 12px; color: #666; margin-bottom: 3px;">
      //                         ${this.escapeHtml(
      //                           queue.student_id || "N/A"
      //                         )} | ${this.escapeHtml(queue.course || "N/A")}
      //                     </div>
      //                     <div style="font-size: 12px; color: #999; margin-bottom: 8px;">
      //                         ${services.join(", ")}
      //                     </div>
      //                     <div style="font-size: 12px; color: #999;">
      //                         Submitted: ${new Date(
      //                           queue.submitted_at
      //                         ).toLocaleTimeString()}
      //                     </div>
      //                     <div style="font-size: 14px; font-weight: 600; color: #c62828; margin-top: 10px;">
      //                         ₱${parseFloat(queue.total_amount || 0).toFixed(
      //                           2
      //                         )}
      //                     </div>
      //                     <div class="action-buttons" style="margin-top: 10px;">
      //                         <button class="btn btn-sm btn-primary" onclick="queueManager.startProcessing('${
      //                           queue.queue_id
      //                         }')">
      //                             Start Processing
      //                         </button>
      //                         <button class="btn btn-sm btn-outline-secondary" onclick="queueManager.moveToRegular('${
      //                           queue.queue_id
      //                         }')">
      //                             Make Regular
      //                         </button>
      //                     </div>
      //                 </div>
      //             `;
      //           })
      //           .join("")}
      //         ${
      //           priorityQueues.length === 0
      //             ? `
      //             <div class="empty-state">
      //                 <div style="text-align: center; padding: 20px; color: #999;">
      //                     No priority requests
      //                 </div>
      //             </div>
      //         `
      //             : ""
      //         }
      //     `;
      // }
      renderPriorityQueue() {
        const priorityQueueCard = document.getElementById(
          "priorityQueueContainer"
        );
        if (!priorityQueueCard) return;

        const priorityQueues = this.queues.priority || [];

        priorityQueueCard.innerHTML = `
    <div class="card-header">
      <span class="card-title">❤️ Priority Queue</span>
      <span class="badge priority">${priorityQueues.length} priority</span>
    </div>
    <div class="priority-queue-list" style="padding: 0 20px;">
      ${priorityQueues
            .map((queue) => {
              const services = Array.isArray(queue.services) ? queue.services : [];
              return `
            <div class="queue-card" onclick="queueManager.startProcessing('${queue.queue_id
                }')" style="cursor: pointer; padding: 12px; border-bottom: 1px solid #f0f0f0;">
              <div class="queue-header" style="display: flex; justify-content: space-between; align-items: start;">
                <span class="queue-id">${this.escapeHtml(
                  queue.queue_number
                )}</span>
                <span class="queue-status" style="text-align: right;">
                  ${services[0] || "Service"}<br />
                  <small style="color: #999">${new Date(
                  queue.submitted_at
                ).toLocaleTimeString()}</small>
                </span>
              </div>
              <div style="font-size: 14px; color: #666; margin-top: 5px;">
                ${this.escapeHtml(queue.user_name)}
              </div>
              <div style="font-size: 12px; color: #999;">
                ${this.escapeHtml(queue.student_id || "N/A")}
              </div>
              <div class="action-buttons" style="margin-top: 8px;">
                <button class="btn btn-sm btn-outline-secondary" onclick="event.stopPropagation(); queueManager.moveToRegular('${queue.queue_id
                }')">
                  Move to Regular
                </button>
                <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); queueManager.viewDetails('${queue.queue_id
                }')">
                  Details
                </button>
              </div>
            </div>
          `;
            })
            .join("")}
      ${priorityQueues.length === 0
            ? `
        <div class="empty-state">
          <div style="text-align: center; padding: 20px; color: #999;">
            No priority requests
          </div>
        </div>
      `
            : ""
          }
    </div>
  `;
        this.updateQueueStats();
      }

      renderRegularQueue() {
        const regularQueueCard = document.getElementById(
          "regularQueueContainer"
        );
        if (!regularQueueCard) return;

        const regularQueues = this.queues.waiting || [];

        regularQueueCard.innerHTML = `
    <div class="regular-queue-list" style="padding: 0 20px;">
      ${regularQueues
            .map((queue) => {
              const services = Array.isArray(queue.services) ? queue.services : [];
              return `
            <div class="queue-card" onclick="queueManager.startProcessing('${queue.queue_id
                }')" style="cursor: pointer; padding: 12px; border-bottom: 1px solid #f0f0f0;">
              <div class="queue-header" style="display: flex; justify-content: space-between; align-items: start;">
                <span class="queue-id">${this.escapeHtml(
                  queue.queue_number
                )}</span>
                <span class="queue-status" style="text-align: right;">
                  ${services[0] || "Service"}<br />
                  <small style="color: #999">${new Date(
                  queue.submitted_at
                ).toLocaleTimeString()}</small>
                </span>
              </div>
              <div style="font-size: 14px; color: #666; margin-top: 5px;">
                ${this.escapeHtml(queue.user_name)}
              </div>
              <div style="font-size: 12px; color: #999;">
                ${this.escapeHtml(queue.student_id || "N/A")}
              </div>
              <div class="action-buttons" style="margin-top: 8px;">
                <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); queueManager.makePriority('${queue.queue_id
                }')">
                  Make Priority
                </button>
                <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); queueManager.viewDetails('${queue.queue_id
                }')">
                  Details
                </button>
              </div>
            </div>
          `;
            })
            .join("")}
      ${regularQueues.length === 0
            ? `
        <div class="empty-state">
          <div style="text-align: center; padding: 20px; color: #999;">
            No regular requests in queue
          </div>
        </div>
      `
            : ""
          }
    </div>
    <div class="next-serve" style="padding: 15px 20px; border-top: 1px solid #f0f0f0; background: #f9f9f9;">
      Next to serve: <strong>${this.getNextToServe()}</strong>
    </div>
  `;
        // Update badge in header
        const badge = document
          .getElementById("regularQueueContainer")
          .parentElement.parentElement.querySelector(
            ".card-header .badge.waiting"
          );
        if (badge) {
          badge.textContent =
            regularQueues.length +
            (regularQueues.length === 1 ? " waiting" : " waiting");
        }
      }

      getProcessingTime(startedAt) {
        if (!startedAt) return "0m";
        const start = new Date(startedAt);
        const now = new Date();
        const diff = Math.floor((now - start) / (1000 * 60)); // minutes
        return `${diff}m`;
      }

      getNextToServe() {
        if (this.queues.priority && this.queues.priority.length > 0) {
          const nextPriority = this.queues.priority[0];
          return `${nextPriority.queue_number} (Priority)`;
        }

        if (this.queues.waiting && this.queues.waiting.length > 0) {
          const nextRegular = this.queues.waiting[0];
          return `${nextRegular.queue_number} (Regular)`;
        }

        return "No pending requests";
      }

      updateQueueStats() {
        const waitingCount = (this.queues.waiting || []).length;
        const processingCount = (this.queues.processing || []).length;
        const readyCount = (this.queues.ready || []).length; // Added: Handle ready queues if API provides them
        const completedCount = (this.queues.completed || []).length;
        const priorityCount = (this.queues.priority || []).length;

        // Calculate total today's requests (sum of all queues)
        const totalCount =
          waitingCount +
          processingCount +
          readyCount +
          completedCount +
          priorityCount;

        // Update top stat cards (existing)
        const waitingEl = document.getElementById("waitingCount");
        const processingEl = document.getElementById("processingCount");
        const readyEl = document.getElementById("readyCount"); // Added: Update ready count
        const completedEl = document.getElementById("completedCount");
        const priorityEl = document.getElementById("priorityCount");

        if (waitingEl) waitingEl.textContent = waitingCount;
        if (processingEl) processingEl.textContent = processingCount;
        if (readyEl) readyEl.textContent = readyCount;
        if (completedEl) completedEl.textContent = completedCount;
        if (priorityEl) priorityEl.textContent = priorityCount;

        // Sync Total Today's Request (sidebar and reports)
        const sidebarTotalEl = document.getElementById("totalRequestsToday");
        const reportsTotalEl = document.getElementById(
          "totalRequestsSummary"
        );
        if (sidebarTotalEl) sidebarTotalEl.textContent = totalCount;
        if (reportsTotalEl) reportsTotalEl.textContent = totalCount;

        // Sync Completed in reports (new card)
        const reportsCompletedEl =
          document.getElementById("completedSummary");
        if (reportsCompletedEl)
          reportsCompletedEl.textContent = completedCount;

        // Also update Regular Queue badge (existing, no change)
        const regularBadge = document
          .getElementById("regularQueueContainer")
          .parentElement.parentElement.querySelector(
            ".card-header .badge.waiting"
          );
        if (regularBadge) {
          regularBadge.textContent =
            waitingCount + (waitingCount === 1 ? " waiting" : " waiting");
        }
      }

      // New methods for enhanced functionality
      async makePriority(queueId) {
        if (!confirm("Make this request priority?")) return;

        try {
          const response = await makeAuthenticatedRequest(
            "/api/admin/make-priority",
            {
              method: "POST",
              body: JSON.stringify({ queueId }),
            }
          );

          const result = await response.json();
          if (result.success) {
            showNotification("Request moved to priority queue!");
            await this.loadQueues();
          } else {
            alert("Error: " + result.message);
          }
        } catch (error) {
          console.error("Error making priority:", error);
          alert("Error making priority. Please try again.");
        }
      }

      async makeCurrent(queueId) {
        try {
          const response = await makeAuthenticatedRequest(
            "/api/admin/make-current",
            {
              method: "POST",
              body: JSON.stringify({ queueId }),
            }
          );

          const result = await response.json();
          if (result.success) {
            showNotification("Request set as current!");
            await this.loadQueues();
          } else {
            alert("Error: " + result.message);
          }
        } catch (error) {
          console.error("Error making current:", error);
          alert("Error making current. Please try again.");
        }
      }

      async escalatePriority(queueId) {
        try {
          const response = await makeAuthenticatedRequest(
            "/api/admin/escalate-priority",
            {
              method: "POST",
              body: JSON.stringify({ queueId }),
            }
          );

          const result = await response.json();
          if (result.success) {
            showNotification("Priority escalated!");
            await this.loadQueues();
          }
        } catch (error) {
          console.error("Error escalating:", error);
        }
      }

      async transferToStaff(queueId) {
        const staff = prompt("Enter staff name to transfer to:");
        if (staff) {
          showNotification(`Transferred to ${staff}`);
          // Implementation would go here
        }
      }

      async clearPriorityQueue() {
        if (
          !confirm(
            "Clear all priority requests? This will move them to regular queue."
          )
        )
          return;

        try {
          const response = await makeAuthenticatedRequest(
            "/api/admin/clear-priority",
            {
              method: "POST",
            }
          );

          const result = await response.json();
          if (result.success) {
            showNotification("Priority queue cleared!");
            await this.loadQueues();
          }
        } catch (error) {
          console.error("Error clearing priority:", error);
        }
      }

      async moveToRegular(queueId) {
        try {
          const response = await makeAuthenticatedRequest(
            "/api/admin/move-to-regular",
            {
              method: "POST",
              body: JSON.stringify({ queueId }),
            }
          );

          const result = await response.json();
          if (result.success) {
            showNotification("Moved to regular queue");
            await this.loadQueues();
          }
        } catch (error) {
          console.error("Error moving to regular:", error);
        }
      }

      viewDetails(queueId) {
        // Implementation for viewing queue details
        alert("View details for: " + queueId);
      }

      async startProcessing(queueId) {
        if (!confirm("Start processing this request?")) return;

        try {
          const response = await makeAuthenticatedRequest(
            "/api/admin/start-processing",
            {
              method: "POST",
              body: JSON.stringify({ queueId }),
            }
          );

          const result = await response.json();
          if (result.success) {
            showNotification("Processing started!");
            await this.loadQueues();
          } else {
            alert("Error: " + result.message);
          }
        } catch (error) {
          console.error("Error starting processing:", error);
          alert("Error starting processing. Please try again.");
        }
      }

      async notifyStudent(queueId) {
        try {
          const response = await makeAuthenticatedRequest(
            "/api/admin/notify-student",
            {
              method: "POST",
              body: JSON.stringify({ queueId }),
            }
          );

          const result = await response.json();
          if (result.success) {
            showNotification("Student notified successfully!");
            // Update UI to show notified status
            this.updateNotificationStatus(queueId);
          } else {
            alert("Error: " + result.message);
          }
        } catch (error) {
          console.error("Error notifying student:", error);
          alert("Error notifying student. Please try again.");
        }
      }

      // async markAsDone(queueId) {
      //   if (!confirm("Mark this request as completed?")) return;

      //   try {
      //     const response = await makeAuthenticatedRequest(
      //       "/api/admin/mark-done",
      //       {
      //         method: "POST",
      //         body: JSON.stringify({ queueId }),
      //       }
      //     );

      //     const result = await response.json();
      //     if (result.success) {
      //       showNotification(
      //         result.nextQueueStarted
      //           ? "Request completed! Next queue started automatically."
      //           : "Request completed!"
      //       );
      //       await this.loadQueues();
      //     } else {
      //       alert("Error: " + result.message);
      //     }
      //   } catch (error) {
      //     console.error("Error marking as done:", error);
      //     alert("Error completing request. Please try again.");
      //   }
      // }

      async markAsDone(queueId) {
        if (!confirm("Mark this request as completed?")) return;

        try {
          const response = await makeAuthenticatedRequest(
            "/api/admin/mark-done",
            {
              method: "POST",
              body: JSON.stringify({ queueId }),
            }
          );

          const result = await response.json();
          if (result.success) {
            // ✅ FIXED: Simplified notification - no automatic next queue
            showNotification("Request completed successfully!");
            await this.loadQueues();
          } else {
            alert("Error: " + result.message);
          }
        } catch (error) {
          console.error("Error marking as done:", error);
          alert("Error completing request. Please try again.");
        }
      }

      async processNextInQueue() {
        const nextQueue =
          this.queues.priority && this.queues.priority.length > 0
            ? this.queues.priority[0]
            : this.queues.waiting && this.queues.waiting.length > 0
              ? this.queues.waiting[0]
              : null;

        if (!nextQueue) {
          alert("No requests in queue to process.");
          return;
        }

        await this.startProcessing(nextQueue.queue_id);
      }

      updateNotificationStatus(queueId) {
        // Update UI to show that student was notified
        const elements = document.querySelectorAll(`[onclick*="${queueId}"]`);
        elements.forEach((element) => {
          const btn = element
            .closest(".action-buttons")
            ?.querySelector('[onclick*="notifyStudent"]');
          if (btn) {
            btn.innerHTML = "✅ Notified";
            btn.disabled = true;
            btn.classList.remove("btn-primary");
            btn.classList.add("btn-success");
          }
        });
      }

      escapeHtml(unsafe) {
        if (unsafe === null || unsafe === undefined) return "";
        return String(unsafe)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      showEmptyQueueState() {
        const stats = [
          "waitingCount",
          "processingCount",
          "completedCount",
          "priorityCount",
        ];
        stats.forEach((stat) => {
          const element = document.getElementById(stat);
          if (element) element.textContent = "0";
        });
      }
    }

    // Manual Queue Entry Function
    async function addManualQueue() {
      const name = document.getElementById("manualName").value;
      const studentId = document.getElementById("manualStudentId").value;
      const service = document.getElementById("manualService").value;
      const isPriority =
        document.getElementById("manualPriority").value === "true";

      if (!name) {
        alert("Please enter a name");
        return;
      }

      // Show additional details modal
      document.getElementById("manualNameDisplay").textContent = name;
      document.getElementById("manualStudentIdDisplay").textContent =
        studentId || "N/A";
      document.getElementById("manualServiceDisplay").textContent = service;
      document.getElementById("manualPriorityDisplay").textContent =
        isPriority ? "Yes" : "No";

      toggleModal("manualTransactionModal");
    }

    async function confirmManualQueue() {
      const name = document.getElementById("manualName").value;
      const studentId = document.getElementById("manualStudentId").value;
      const service = document.getElementById("manualService").value;
      const isPriority =
        document.getElementById("manualPriority").value === "true";
      const transactionType =
        document.getElementById("transactionType").value;
      const notes = document.getElementById("transactionNotes").value;

      try {
        const response = await makeAuthenticatedRequest(
          "/api/admin/add-manual-queue",
          {
            method: "POST",
            body: JSON.stringify({
              name,
              studentId,
              service,
              isPriority,
              transactionType,
              notes,
            }),
          }
        );

        const result = await response.json();

        if (result.success) {
          showNotification(`Manual queue entry added: ${result.queueNumber}`);
          toggleModal("manualTransactionModal");

          // Clear form
          document.getElementById("manualName").value = "";
          document.getElementById("manualStudentId").value = "";
          document.getElementById("transactionNotes").value = "";

          // Refresh queues
          queueManager.loadQueues();
        } else {
          alert("Error: " + result.message);
        }
      } catch (error) {
        console.error("Error adding manual queue:", error);
        alert("Error adding to queue. Please try again.");
      }
    }

    // Enhanced auto-refresh with error handling
    function setupEnhancedAutoRefresh() {
      // Refresh every 5 seconds when on queue page
      setInterval(() => {
        if (
          !isQueuePaused &&
          document.getElementById("queue-page").classList.contains("active")
        ) {
          queueManager.loadQueues();
        }
      }, 5000);

      // Refresh service requests every 30 seconds
      setInterval(() => {
        if (
          document
            .getElementById("documents-page")
            .classList.contains("active")
        ) {
          serviceRequestManager.loadServiceRequests();
        }
      }, 30000);
    }

    // Initialize with enhanced features
    document.addEventListener("DOMContentLoaded", function () {
      console.log("Admin dashboard initialized with enhanced features");

      // Initialize managers
      serviceRequestManager = new ServiceRequestManager();
      queueManager = new QueueManager();

      // Set up navigation
      setupNavigation();

      // Show initial page
      showPage("queue");

      // Load preferences
      loadPreferences();

      // Set up enhanced auto-refresh
      setupEnhancedAutoRefresh();
    });

    // Manual Queue Entry Handler
    // Manual Queue Entry Handler (Fixed: Null-safe)
    document
      .getElementById("manualQueueForm")
      ?.addEventListener("submit", async (e) => {
        e.preventDefault();

        const name = document.getElementById("manualName")?.value?.trim();
        const studentId = document
          .getElementById("manualStudentId")
          ?.value?.trim();
        const course = document.getElementById("manualCourse")?.value?.trim();
        const yearLevel = document.getElementById("manualYearLevel")?.value;
        const servicesJson = document.getElementById("manualService")?.value;

        if (!name || !studentId || !course || !yearLevel || !servicesJson) {
          alert("Please fill in all fields.");
          return;
        }

        try {
          const response = await makeAuthenticatedRequest(
            "/api/admin/manual-queue-entry",
            {
              method: "POST",
              body: JSON.stringify({
                user_name: name,
                student_id: studentId,
                course: course,
                year_level: yearLevel,
                services: servicesJson,
                total_amount: 0.0,
              }),
            }
          );

          const result = await response.json();

          if (result.success) {
            showNotification(
              `${name} added to queue as ${result.queueNumber}`
            );
            document.getElementById("manualQueueForm")?.reset();

            // Null-safe collapse (fixes the error)
            const collapseElement =
              document.getElementById("manualEntryForm");
            if (collapseElement) {
              collapseElement.classList.remove("show");
            } else {
              console.warn("Collapse element not found - skipping hide");
            }

            queueManager.loadQueues(); // Refresh queue
          } else {
            alert("Error: " + result.message);
          }
        } catch (error) {
          console.error("Manual queue entry failed:", error);
          alert(
            `Failed to add to queue: ${error.message || "Check console for details."
            }`
          );
        }
      });
  </script>
</body>

</html>