<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Queue Status - RSU REQS</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />
    <link href="/assets/css/style.css" rel="stylesheet" />

    <style>
      .register-card-custom {
        max-width: 1000px;
        width: 100%;
      }
    </style>
  </head>

  <body>
    <!-- Guest Dashboard Section -->
    <div class="d-flex flex-grow-1 justify-content-center align-items-center">
      <div class="register-card-custom">
        <div
          class="logo d-flex flex-column justify-content-center align-items-center"
        >
          <div
            class="d-flex flex-row justify-content-center align-items-center mb-2"
          >
            <img
              src="/assets/img/rsu_logo.png"
              alt="RSU Logo"
              width="55"
              height="55"
              class="me-2"
            />
            <img
              src="/assets/img/registrar_logo.png"
              alt="Registrar Logo"
              width="40"
              height="40"
              class="me-2"
            />
          </div>
          <a href="/">
            <div class="d-flex flex-column lh-sm">
              <p class="fw-bold">Registrar's Office</p>
              <p class="fw-bold">Romblon State University - Odiongan</p>
            </div>
          </a>
        </div>
        <div class="content">
          <div class="queue-header text-center p-4 bg-light border rounded">
            <h2 class="mb-1 fw-bold">QUEUE STATUSes</h2>
            <h5 class="text-primary fw-bold d-block" id="live-time">
              09:27:04
            </h5>
            <h5 class="text-muted d-block" id="live-date">
              Thursday, October 30, 2025
            </h5>
          </div>
          <!-- <h1>QUEUE STATUS</h1> -->

          <div class="row g-4">
            <!-- Now Serving -->
            <div class="col-md-8">
              <div class="now-serving text-center">
                <h2>NOW SERVING</h2>
                <hr />
                <div class="queue-number">Loading...</div>
                <small class="text-muted">Queue Number:</small>
              </div>
            </div>

            <!-- Coming Up Next -->
            <div class="col-md-4">
              <div class="coming-next text-center">
                <h3>COMING UP NEXT</h3>
                <ul>
                  <!-- Dynamic items will be added here -->
                </ul>
              </div>
            </div>

            <!-- Ready to Claim -->
            <div class="ready-claim mt-4">
              <h3>READY TO CLAIM â†“</h3>
              <div class="codes">
                <!-- Dynamic items will be added here -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- <footer class="py-3 border-top text-center mt-2"></footer> -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
<script>
  // ---------- LIVE CLOCK ----------
  function updateClock() {
    const now = new Date();
    const time = now.toLocaleTimeString("en-US", {
      hour12: false,
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
    });
    const date = now.toLocaleDateString("en-US", {
      weekday: "long",
      year: "numeric",
      month: "long",
      day: "numeric",
    });

    document.getElementById("live-time").textContent = time;
    document.getElementById("live-date").textContent = date;
  }

  // --- State for "Ready to Claim" paging ---
  let fullReadyToClaimList = [];
  let readyToClaimBatchIndex = 0;
  const readyToClaimBatchSize = 10;
  // -----------------------------------------

  // --- Display batch (this function just renders the UI) ---
  function displayReadyToClaimBatch() {
    const readyClaimCodes = document.querySelector(".ready-claim .codes");

    // 1. Add 'sliding-out' class to slide UP and fade out
    readyClaimCodes.classList.add("sliding-out");

    // 2. Wait for the 'out' animation to finish (400ms)
    setTimeout(() => {
      // 3. Update the content (same as before)
      readyClaimCodes.innerHTML = "";
      const totalItems = fullReadyToClaimList.length;

      if (totalItems === 0) {
        const div = document.createElement("div");
        div.textContent = "None";
        readyClaimCodes.appendChild(div);
        readyToClaimBatchIndex = 0; // Reset index
      } else {
        // Check if index is out of bounds (end of list OR list shrank), reset to 0
        let startIndex = readyToClaimBatchIndex * readyToClaimBatchSize;
        if (startIndex >= totalItems) {
          readyToClaimBatchIndex = 0;
          startIndex = 0;
        }

        const endIndex = Math.min(
          startIndex + readyToClaimBatchSize,
          totalItems
        );
        const currentBatch = fullReadyToClaimList.slice(startIndex, endIndex);

        currentBatch.forEach((item) => {
          const div = document.createElement("div");
          div.textContent = item;
          readyClaimCodes.appendChild(div);
        });

        readyToClaimBatchIndex++; // Increment index for *next* time this runs
      }

      // 4. Prepare for 'slide in'
      // Remove 'sliding-out' and add 'sliding-in'
      // This makes it "jump" to the bottom, still invisible
      readyClaimCodes.classList.remove("sliding-out");
      readyClaimCodes.classList.add("sliding-in");

      // 5. Force the browser to apply the 'sliding-in' state
      // We use a tiny delay (a "tick")
      setTimeout(() => {
        // 6. Remove 'sliding-in' to trigger the animation
        // It will now slide UP and fade IN to its final spot
        readyClaimCodes.classList.remove("sliding-in");
      }, 20); // 20ms is all you need
    }, 400); // This 400ms MUST match your CSS transition duration
  }
  // --- Reset UI for a new day ---
  function resetQueueForNewDay() {
    document.querySelector(".now-serving .queue-number").textContent = "None";
    const comingNextList = document.querySelector(".coming-next ul");
    comingNextList.innerHTML = "<li>None</li>";
    fullReadyToClaimList = [];
    readyToClaimBatchIndex = 0;
  }

  // --- Fetch & update queue (this function just gets data) ---
  async function updateQueueStatus() {
    try {
      const response = await fetch("/api/queue/status");
      if (!response.ok) throw new Error("API error");
      const data = await response.json();

      if (data.success) {
        // ---- DAILY RESET LOGIC ----
        const today = new Date().toISOString().split("T")[0]; // YYYY-MM-DD
        const lastDay = sessionStorage.getItem("queueDay");

        if (!lastDay || lastDay !== today) {
          resetQueueForNewDay();
        }
        sessionStorage.setItem("queueDay", today);
        // ---------------------------

        // NOW SERVING
        const nowServingElem = document.querySelector(
          ".now-serving .queue-number"
        );
        nowServingElem.textContent = data.nowServing || "None";

        // COMING UP NEXT
        const comingNextList = document.querySelector(".coming-next ul");
        comingNextList.innerHTML = "";
        data.comingNext.forEach((item, i) => {
          const li = document.createElement("li");
          li.innerHTML = i === 0 ? `<strong>${item}</strong>` : item;
          comingNextList.appendChild(li);
        });
        if (!data.comingNext.length) {
          comingNextList.innerHTML = "<li>None</li>";
        }

        // READY TO CLAIM
        // Only update the list if the data *actually changed*
        const newList = data.readyToClaim || [];
        if (JSON.stringify(fullReadyToClaimList) !== JSON.stringify(newList)) {
          fullReadyToClaimList = newList;

          // *** THE FIX IS HERE ***
          // We have DELETED the line "readyToClaimBatchIndex = 0;"
          // The display loop will handle this itself.
        }
      }
    } catch (error) {
      console.error("Error fetching queue status:", error);
      document.querySelector(".now-serving .queue-number").textContent =
        "Loading...";
      document.querySelector(".coming-next ul").innerHTML =
        "<li>Loading...</li>";
      fullReadyToClaimList = [];
      readyToClaimBatchIndex = 0;
    }
  }

  // --- Initial load & timers ---
  updateClock();
  setInterval(updateClock, 1000); // 1. Clock loop

  async function initialLoad() {
    await updateQueueStatus(); // Get data one time
    displayReadyToClaimBatch(); // Show the first batch immediately
  }

  initialLoad();

  // --- SEPARATE LOOPS ---

  // 2. API Poll Loop: Fetch data every 5 seconds
  setInterval(updateQueueStatus, 5000);

  // 3. Display Rotation Loop: Rotate batch every 10 seconds
  setInterval(displayReadyToClaimBatch, 10000);
</script>
